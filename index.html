<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×¢×–×¨ ×ª×•×¨×” - ×ª×•×©×™×” ×ª×¤×¨×— | v9</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@300;400;500;700;900&family=Heebo:wght@300;400;500;600;700&display=swap');

:root {
  --navy:#1a2744; --navy-l:#243258; --navy-h:#0f1a30;
  --gold:#c9a84c; --gold-l:#e8c97e; --gold-bg:#fdf8ec;
  --cream:#f8f4ed; --cream-d:#ede8df;
  --text:#1a2744; --muted:#6b7a9a;
  --white:#fff; --danger:#c0392b; --danger-bg:#fdecea;
  --success:#27ae60; --success-bg:#eafaf1;
  --warn:#e67e22; --purple:#6d28d9; --purple-bg:#f5f3ff;
  --border:#d5cfc4;
  --teal:#0891b2; --teal-bg:#e0f7fa;
  --sh:0 2px 16px rgba(26,39,68,.08);
  --sh-lg:0 8px 40px rgba(26,39,68,.18);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Heebo',sans-serif;background:var(--cream);color:var(--text);min-height:100vh;direction:rtl}

/* LOGIN */
.login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--navy) 0%,#2a3f6b 100%)}
.login-box{background:var(--white);border-radius:20px;box-shadow:var(--sh-lg);padding:48px 40px;width:400px;max-width:95vw;text-align:center}
.login-logo{font-family:'Frank Ruhl Libre',serif;font-size:32px;color:var(--navy);margin-bottom:4px}
.login-sub{color:var(--muted);font-size:14px;margin-bottom:32px}
.login-form{display:flex;flex-direction:column;gap:14px;text-align:right}
.login-error{background:var(--danger-bg);color:var(--danger);padding:10px;border-radius:8px;font-size:13px;display:none}

/* TOPBAR */
.topbar{background:var(--navy);color:var(--white);padding:0 20px;height:58px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 12px rgba(26,39,68,.3);position:sticky;top:0;z-index:200;flex-wrap:wrap;gap:6px}
.topbar-brand{font-family:'Frank Ruhl Libre',serif;font-size:20px;font-weight:700;color:var(--gold-l)}
.topbar-brand span{color:rgba(255,255,255,.6);font-weight:300;font-size:16px}
.topbar-right{display:flex;align-items:center;gap:14px}
.user-pill{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.1);padding:5px 12px;border-radius:20px;font-size:13px}
.role-badge{font-size:10px;background:var(--gold);color:var(--navy);padding:2px 6px;border-radius:10px;font-weight:700}
.topbar-nav{display:flex;gap:4px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:1px}
.topbar-nav::-webkit-scrollbar{display:none}
.nav-btn{background:transparent;border:1px solid rgba(201,168,76,.3);color:rgba(255,255,255,.85);padding:6px 13px;border-radius:6px;cursor:pointer;font-family:'Heebo',sans-serif;font-size:13px;transition:all .2s}
.nav-btn:hover,.nav-btn.active{background:var(--gold);color:var(--navy);border-color:var(--gold);font-weight:700}
.logout-btn{background:none;border:none;color:rgba(255,255,255,.6);cursor:pointer;font-size:13px;font-family:'Heebo',sans-serif}
.logout-btn:hover{color:white}

/* PAGES */
.page{display:none;padding:16px 20px;min-height:calc(100vh - 90px)}
.page.active{display:block}

/* BUTTONS */
.btn{padding:8px 16px;border-radius:8px;font-family:'Heebo',sans-serif;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-navy{background:var(--navy);color:white}.btn-navy:hover{background:var(--navy-h)}
.btn-gold{background:var(--gold);color:var(--navy)}.btn-gold:hover{background:var(--gold-l)}
.btn-outline{background:white;color:var(--navy);border:1.5px solid var(--border)}.btn-outline:hover{border-color:var(--navy)}
.btn-danger{background:var(--danger-bg);color:var(--danger)}.btn-danger:hover{background:var(--danger);color:white}
.btn-purple{background:var(--purple);color:white}.btn-purple:hover{background:#5b21b6}
.btn-success{background:var(--success);color:white}
.btn-sm{padding:5px 11px;font-size:12px;border-radius:6px}
.btn-icon{width:32px;height:32px;border-radius:7px;border:none;cursor:pointer;font-size:15px;display:inline-flex;align-items:center;justify-content:center;transition:all .2s}
.btn-icon.wa{background:#e8fdf2;color:#25d366}.btn-icon.wa:hover{background:#25d366;color:white}
.btn-icon.em{background:#e8f0fe;color:var(--navy)}.btn-icon.em:hover{background:var(--navy);color:white}

/* CARDS */
.card{background:var(--white);border-radius:12px;box-shadow:var(--sh);overflow:hidden;margin-bottom:16px}
.card-header{background:var(--navy);color:white;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.card-header h3{font-family:'Frank Ruhl Libre',serif;font-size:17px}
.card-body{padding:20px}

/* STAT CARDS */
.stat-grid{display:grid;gap:14px;margin-bottom:20px}
.stat-card{background:var(--white);border-radius:12px;padding:18px 20px;box-shadow:var(--sh);border-top:3px solid var(--navy);cursor:default;transition:transform .15s,box-shadow .15s}
.stat-card.clickable{cursor:pointer}.stat-card.clickable:hover{transform:translateY(-2px);box-shadow:var(--sh-lg)}
.stat-card.gold{border-top-color:var(--gold)}
.stat-card.green{border-top-color:var(--success)}
.stat-card.orange{border-top-color:var(--warn)}
.stat-card.purple{border-top-color:var(--purple)}
.stat-card.red{border-top-color:var(--danger)}
.sv{font-family:'Frank Ruhl Libre',serif;font-size:28px;font-weight:700;color:var(--navy)}
.sv.green{color:var(--success)}.sv.red{color:var(--danger)}.sv.gold{color:#7a5c00}.sv.purple{color:var(--purple)}
.sl{font-size:12px;color:var(--muted);margin-top:3px}
.sl small{font-size:10px;color:var(--purple)}

/* TABLE */
.table-wrap{background:var(--white);border-radius:12px;box-shadow:var(--sh);overflow:hidden}
.table-info{padding:10px 18px;font-size:12px;color:var(--muted);border-bottom:1px solid var(--cream-d);display:flex;justify-content:space-between;align-items:center}
.table-scroll{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead{background:var(--navy);color:white;position:sticky;top:0;z-index:10}
th{padding:11px 12px;text-align:right;font-weight:600;font-size:12px;white-space:nowrap;cursor:pointer;user-select:none;transition:background .15s}
th:hover{background:var(--navy-l)}
th .si{font-size:10px;margin-right:3px;opacity:.5}
th.sorted .si{opacity:1;color:var(--gold-l)}
td{padding:9px 12px;border-bottom:1px solid var(--cream-d);white-space:nowrap;vertical-align:middle}
tr:hover td{background:#f8f6ff}
.row-actions{display:flex;gap:4px}

/* BADGES */
.badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:700}
.b-cash{background:var(--success-bg);color:var(--success)}
.b-credit{background:#e8f0fe;color:#1a56b0}
.b-check{background:#fff3e0;color:#b05e00}
.b-bank{background:#f3e5f5;color:#7b1fa2}
.b-other{background:var(--cream-d);color:var(--muted)}

/* TOOLBAR */
.toolbar{background:var(--white);border-radius:12px;padding:14px 18px;box-shadow:var(--sh);margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.search-input{flex:1;min-width:200px;padding:8px 14px;border:1.5px solid var(--border);border-radius:8px;font-family:'Heebo',sans-serif;font-size:14px;outline:none;transition:border-color .2s}
.search-input:focus{border-color:var(--navy)}
.filter-select{padding:7px 10px;border:1.5px solid var(--border);border-radius:7px;font-family:'Heebo',sans-serif;font-size:13px;outline:none;background:white;cursor:pointer}
.filter-select:focus{border-color:var(--navy)}
.filter-clear{background:none;border:none;color:var(--muted);cursor:pointer;font-size:12px;font-family:'Heebo',sans-serif;text-decoration:underline}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(26,39,68,.55);display:flex;align-items:center;justify-content:center;z-index:500;opacity:0;pointer-events:none;transition:opacity .2s}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--white);border-radius:16px;box-shadow:var(--sh-lg);width:700px;max-width:96vw;max-height:90vh;overflow:hidden;transform:translateY(24px);transition:transform .25s;display:flex;flex-direction:column}
.modal-body{overflow-y:auto;flex:1}
.modal-footer{flex-shrink:0}
.modal-overlay.open .modal{transform:translateY(0)}
.modal-sm{width:460px}.modal-lg{width:920px}
.modal-header{background:linear-gradient(135deg,#243868,#1e3258);color:white;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;border-radius:16px 16px 0 0;position:sticky;top:0;z-index:10}
.modal-header h3{font-family:'Frank Ruhl Libre',serif;font-size:19px}
.modal-close{background:none;border:none;color:rgba(255,255,255,.7);font-size:22px;cursor:pointer;line-height:1}
.modal-close:hover{color:white}
.modal-body{padding:24px}
.modal-footer{padding:14px 24px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;background:var(--cream);border-radius:0 0 16px 16px}

/* TABS */
.tabs{display:flex;border-bottom:2px solid var(--border);margin-bottom:20px}
.tab{padding:9px 18px;cursor:pointer;font-size:13px;font-weight:600;color:var(--muted);border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s}
.tab.active{color:var(--navy);border-bottom-color:var(--navy)}

/* FORM */
.fg{display:flex;flex-direction:column;gap:4px}
.fg.full{grid-column:1/-1}.fg.half{grid-column:span 2}
.form-label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.form-control{padding:8px 11px;border:1.5px solid var(--border);border-radius:8px;font-family:'Heebo',sans-serif;font-size:13px;color:var(--text);background:var(--white);outline:none;transition:border-color .2s,box-shadow .2s;width:100%}
.form-control:focus{border-color:var(--navy);box-shadow:0 0 0 3px rgba(26,39,68,.07)}
.form-control[readonly]{background:var(--cream);cursor:not-allowed}
.ig{display:flex;gap:6px;align-items:center}.ig .form-control{flex:1}
.req{color:var(--danger)}
.fg3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.fg2{display:grid;grid-template-columns:1fr 1fr;gap:14px}

/* DONOR STATS */
.d-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.d-stat{background:var(--cream);border-radius:9px;padding:12px 14px;text-align:center}
.d-stat .sv{font-size:20px}.d-stat .sl{font-size:11px}

/* FUTURE ITEM */
.future-item{background:var(--purple-bg);border:1px solid #c4b5fd;border-radius:10px;padding:12px 16px;margin-bottom:8px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.future-item-info{flex:1}
.future-item-info .fi-date{font-weight:700;font-size:13px;color:var(--purple)}
.future-item-info .fi-heb{font-size:11px;color:var(--muted);margin-top:1px}
.future-item-info .fi-amount{font-size:13px;margin-top:4px}
.future-item-info .fi-notes{font-size:12px;color:var(--muted);margin-top:3px;white-space:pre-wrap}
.future-item-actions{display:flex;gap:5px;flex-shrink:0}

/* ADMIN GRID */
.admin-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:24px}
.admin-card{background:var(--white);border-radius:12px;padding:20px;box-shadow:var(--sh);border-top:3px solid var(--border);cursor:pointer;transition:all .2s}
.admin-card:hover{border-top-color:var(--navy);transform:translateY(-2px);box-shadow:var(--sh-lg)}
.admin-card .ac-icon{font-size:30px;margin-bottom:10px}
.admin-card h3{font-size:15px;font-weight:700;margin-bottom:4px}
.admin-card p{font-size:12px;color:var(--muted)}

/* CAMPAIGN PANEL */
.camp-goal{font-family:'Frank Ruhl Libre',serif;font-size:48px;font-weight:900;text-align:center;margin:8px 0}
.camp-goal.over{color:var(--success)}.camp-goal.under{color:var(--danger)}
.progress-bar{height:16px;background:var(--cream-d);border-radius:20px;overflow:hidden;margin:8px 0}
.progress-fill{height:100%;border-radius:20px;transition:width .5s ease;background:linear-gradient(90deg,var(--navy),var(--gold))}
.progress-fill.over{background:linear-gradient(90deg,var(--success),#52c41a)}
.camp-stat{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--cream-d)}
.camp-stat:last-child{border:none}

/* DATE */
.date-cell{display:flex;flex-direction:column}
.date-heb{font-size:10px;color:var(--muted)}

/* USERS TABLE */
.users-table{width:100%;border-collapse:collapse}
.users-table th{background:var(--cream);padding:9px 12px;text-align:right;font-size:12px;font-weight:700;color:var(--muted);border-bottom:2px solid var(--border)}
.users-table td{padding:10px 12px;border-bottom:1px solid var(--cream-d)}

/* INLINE SETTINGS */
.setting-item{display:flex;gap:6px;margin-bottom:6px}
.setting-item .form-control{flex:1}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â• MOBILE RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {
  /* Topbar: stack or scroll nav */
  .nav-btn { padding: 5px 9px; font-size: 11px; white-space: nowrap; flex-shrink: 0; }

  /* Pages */
  .page { padding: 12px 14px; min-height: auto; }

  /* Stat grids - 2 columns on mobile */
  .stat-grid, .sg, .dash-stats {
    grid-template-columns: repeat(2, 1fr) !important;
  }

  /* Toolbar stacks */
  .toolbar { flex-direction: column; align-items: stretch; gap: 8px; }
  .search-input, .si-input { min-width: 0; width: 100%; }

  /* Tables scroll */
  .table-wrap, .tw { overflow: hidden; }
  .table-scroll, .ts { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  table { min-width: 600px; }

  /* Modals full screen */
  .modal-overlay { align-items: flex-end; }
  .modal, .modal.modal-sm, .modal.modal-lg, .modal.modal-xl {
    width: 100% !important;
    max-width: 100vw !important;
    max-height: 92vh !important;
    border-radius: 16px 16px 0 0;
  }
  .modal-header, .mh { border-radius: 16px 16px 0 0; }

  /* Form grids collapse */
  .form-grid, .fg3 { grid-template-columns: 1fr 1fr !important; }
  .form-grid-2, .fg2 { grid-template-columns: 1fr !important; }
  .fg4 { grid-template-columns: 1fr 1fr !important; }
  .fg.full, .fg.half { grid-column: 1 / -1; }

  /* Donor stats */
  .donor-stats, .d-stats { grid-template-columns: repeat(3, 1fr); }
  .d-stat .sv { font-size: 16px; }

  /* Admin grid */
  .admin-grid, .ag { grid-template-columns: repeat(2, 1fr) !important; }
  .ac, .admin-card { padding: 14px; }
  .ac .aci, .admin-card .ac-icon { font-size: 22px; }

  /* Campaign */
  .camp-goal { font-size: 36px; }

  /* Groups */
  .grp-card { padding: 12px; }

  /* Row actions always visible */
  .row-actions { flex-wrap: wrap; }

  /* Top10 tables */
  .t10 { min-width: 0; }

  /* Future item */
  .future-item, .fi { flex-direction: column; }
  .future-item-actions { margin-top: 8px; }
}

@media (max-width: 480px) {
  .stat-grid, .sg { grid-template-columns: 1fr 1fr !important; }
  .form-grid, .fg3 { grid-template-columns: 1fr !important; }
  .topbar-nav { justify-content: flex-start; }
  .d-stats, .donor-stats { grid-template-columns: repeat(2, 1fr) !important; }
  .modal-tabs, .tabs { overflow-x: auto; flex-wrap: nowrap; }
  .modal-tab, .tab { white-space: nowrap; flex-shrink: 0; }
}

/* PRINT */
@media print{.topbar,.toolbar,.row-actions,.nav-btn,.btn,.modal-overlay{display:none!important}.page{padding:0}.table-wrap{box-shadow:none;border:1px solid #ccc}}

/* SCROLLBAR */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--cream)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}


/* â”€â”€ Select with + button â”€â”€ */
.sel-wrap { display:flex; gap:5px; align-items:center; }
.sel-wrap select { flex:1; }
.sel-add-btn { flex-shrink:0; width:28px; height:28px; background:var(--gold); border:none; border-radius:6px;
  cursor:pointer; font-size:16px; color:var(--navy); font-weight:700; display:flex; align-items:center; justify-content:center; }
.sel-add-btn:hover { background:var(--gold-l); }

.col-pick{display:flex;align-items:center;gap:5px;font-size:12px;background:var(--cream);padding:4px 10px;border-radius:6px;cursor:pointer;border:1px solid var(--border);}
.col-pick:hover{background:var(--cream-d);}
.col-pick input{cursor:pointer;}
.add-opt-row{display:none;gap:5px;margin-top:4px;align-items:center}
.add-opt-row input{flex:1}
.add-opt-row.visible{display:flex}
.card-header{background:linear-gradient(135deg,#1e3a5f,#162d4a)!important}
.sub-modal-header{background:linear-gradient(135deg,#2d4a7a,#1e3258);color:white;padding:10px 16px;border-radius:10px 10px 0 0;display:flex;align-items:center;justify-content:space-between}

@media print {
  tr { page-break-inside: avoid; }
  td { 
    white-space: normal !important;
    word-wrap: break-word;
    max-height: calc(3 * 1.4em);
    overflow: hidden;
    line-height: 1.4;
  }
  table { page-break-inside: auto; }
}
/* â”€â”€ TEAL CARD â”€â”€ */
.stat-card.teal { border-top-color: var(--teal); }
.stat-card.teal .stat-val { color: var(--teal); }

/* â”€â”€ PICK LIST â”€â”€ */
.pick-results { max-height: 160px; overflow-y: auto; margin-top: 4px; }
.pick-item { padding: 7px 10px; cursor: pointer; border-radius: 7px; background: var(--cream); margin-bottom: 4px; border: 1px solid var(--border); font-size: 13px; }
.pick-item:hover { background: var(--cream-d); }

/* â”€â”€ TOP 10 TABLE â”€â”€ */
.t10 { width: 100%; border-collapse: collapse; font-size: 12px; }
.t10 th { padding: 6px 10px; background: var(--cream-d); text-align: right; font-weight: 700; font-size: 11px; }
.t10 td { padding: 6px 10px; border-bottom: 1px solid var(--cream-d); }
.t10 .rank { font-size: 16px; font-weight: 900; color: var(--muted); font-family: "Frank Ruhl Libre", serif; }

/* â”€â”€ GROUP CARD â”€â”€ */
.grp-card { background: var(--white); border-radius: 11px; box-shadow: var(--sh); padding: 14px; margin-bottom: 10px; border-right: 4px solid var(--teal); }

/* â”€â”€ CAMPAIGN GOAL â”€â”€ */
.camp-goal { font-family: "Frank Ruhl Libre", serif; font-size: 48px; font-weight: 900; text-align: center; margin: 8px 0; }
.camp-goal.over { color: var(--success); }
.camp-goal.under { color: var(--danger); }
.camp-stat { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--cream-d); }
.camp-stat:last-child { border: none; }
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="login-logo">âœ¡ï¸ ×¢×–×¨ ×ª×•×¨×”</div>
    <div class="login-sub">×ª×•×©×™×” ×ª×¤×¨×— â€” ×›× ×™×¡×” ×œ××¢×¨×›×ª</div>
    <div class="login-form">
      <div class="fg"><label class="form-label">×©× ××©×ª××©</label><input class="form-control" id="loginUser" placeholder="×©× ××©×ª××©" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <div class="fg"><label class="form-label">×¡×™×¡××”</label><input class="form-control" type="password" id="loginPass" placeholder="×¡×™×¡××”" onkeydown="if(event.key==='Enter')doLogin()"></div>
      <div class="login-error" id="loginError">×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×</div>
      <button class="btn btn-navy" onclick="doLogin()" style="padding:11px;justify-content:center">×›× ×™×¡×”</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">

<!-- TOPBAR -->
<div class="topbar" style="height:auto;padding:8px 16px;flex-direction:column;align-items:stretch;gap:6px">
  <div style="display:flex;align-items:center;justify-content:space-between">
    <div class="topbar-brand">âœ¡ï¸ ×¢×–×¨ ×ª×•×¨×” <span>| ×ª×•×©×™×” ×ª×¤×¨×—</span> <span style="font-size:10px;opacity:.7;font-weight:400">v9.0</span> <span style="font-size:10px;font-family:monospace;opacity:.45;font-weight:400;letter-spacing:.5px">v9</span></div>
    <div style="display:flex;align-items:center;gap:10px">
      <div class="user-pill"><span id="topUserName"></span><span class="role-badge" id="topUserRole"></span></div>
      <button class="btn btn-outline btn-sm" onclick="openSwitchUserModal()" style="background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.3);color:white;font-size:11px">ğŸ”„ ×”×—×œ×£ ××©×ª××©</button>
      <button class="logout-btn" onclick="doLogout()">â†© ×™×¦×™××”</button>
    </div>
  </div>
  <div class="topbar-nav" style="padding-bottom:2px">
    <button class="nav-btn active" id="navDash" onclick="showPage('dash')">ğŸ  ×¨××©×™</button>
    <button class="nav-btn" id="navDonors" onclick="showPage('donors')">ğŸ‘¥ ×ª×•×¨××™×</button>
    <button class="nav-btn" id="navDonations" onclick="showPage('donations')">ğŸ’° ×ª×¨×•××•×ª</button>
      <button class="nav-btn" id="navCampaign" onclick="showPage('campaign')">ğŸ¯ ××’×‘×™×ª</button>
    <button class="nav-btn" id="navFuture" onclick="showPage('future')">â­ ×¢×ª×™×“×™×•×ª</button>
    <button class="nav-btn" id="navFundraisers" onclick="showPage('fundraisers')">ğŸ“ ××ª×¨×™××™×</button>
    <button class="nav-btn" id="navAdmin" onclick="showPage('admin')">âš™ï¸ × ×™×”×•×œ</button>
  </div>
</div>

<!-- â•â•â•â• DASHBOARD PAGE â•â•â•â• -->
<div class="page active" id="pageDash">
  <div style="margin-bottom:20px;display:flex;align-items:center;justify-content:space-between">
    <div>
      <h2 style="font-family:'Frank Ruhl Libre',serif;font-size:26px" id="dashGreet">×©×œ×•×!</h2>
      <div id="dashDate" style="font-size:13px;color:var(--muted)"></div>
    </div>
    <div style="display:flex;gap:10px" id="dashActions">
      <button class="btn btn-gold" onclick="openNewDonorModal()">+ ×”×•×¡×£ ×ª×•×¨×</button>
      <button class="btn btn-navy" onclick="openQuickDonationModal()">ğŸ’° ×”×•×¡×£ ×ª×¨×•××”</button>
    </div>
  </div>

  <!-- Stats -->
  <div class="stat-grid" style="grid-template-columns:repeat(4,1fr)">
    <div class="stat-card green clickable" onclick="showPage('donors')">
      <div class="sv green" id="ds-count">0</div><div class="sl">×ª×•×¨××™× ×¨×©×•××™×</div>
    </div>
    <div class="stat-card gold">
      <div class="sv gold" id="ds-total">â‚ª0</div><div class="sl">×¡×š ×›×œ ×”×ª×¨×•××•×ª</div>
    </div>
    <div class="stat-card orange">
      <div class="sv" id="ds-donations">0</div><div class="sl">×ª×¨×•××•×ª ×©× ×¨×©××•</div>
    </div>
    <div class="stat-card purple clickable" onclick="showPage('future')">
      <div class="sv purple" id="ds-future">0</div><div class="sl">×ª×¨×•××•×ª ×¢×ª×™×“×™×•×ª <small>×œ×—×¥ ×œ×¨×©×™××”</small></div>
    </div>
  </div>

  <!-- Active Campaign Mini -->
  <div id="dashCampaignBox"></div>

  <!-- Recent donations -->
  <div class="card">
    <div class="card-header"><h3>â±ï¸ ×ª×¨×•××•×ª ××—×¨×•× ×•×ª</h3><button class="btn btn-outline btn-sm" onclick="showPage('donors')">×›×œ ×”×ª×•×¨××™×</button></div>
    <div class="card-body" style="padding:0;overflow-x:auto">
      <table style="width:100%;min-width:500px;border-collapse:collapse">
        <thead style="background:var(--navy);color:white">
          <tr>
            <th style="padding:8px 10px;text-align:right;font-size:11px;white-space:nowrap">×ª×•×¨×</th>
            <th style="padding:8px 10px;text-align:right;font-size:11px;white-space:nowrap">××’×‘×™×ª</th>
            <th style="padding:8px 10px;text-align:right;font-size:11px;white-space:nowrap">××ª×¨×™×</th>
            <th style="padding:8px 10px;text-align:right;font-size:11px;white-space:nowrap">×¡×›×•×</th>
            <th style="padding:8px 10px;text-align:right;font-size:11px;white-space:nowrap">×ª××¨×™×š</th>
            <th style="padding:8px 10px;text-align:right;font-size:11px;white-space:nowrap">××•×¤×Ÿ</th>
          </tr>
        </thead>
        <tbody id="recentDonations"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â• DONORS PAGE â•â•â•â• -->
<div class="page" id="pageDonors">
  <div class="toolbar">
    <input type="text" class="search-input" id="mainSearch" placeholder="ğŸ” ×—×™×¤×•×© ×—×•×¤×©×™ ×‘×›×œ ×”×©×“×•×ª..." oninput="applyFilters()">
    <button class="btn btn-gold" onclick="openNewDonorModal()">+ ×”×•×¡×£ ×ª×•×¨×</button>
    <button class="btn btn-outline btn-sm" id="exportBtn" onclick="exportFiltered()" style="display:none">ğŸ“¤ ×™×™×¦×•× ××•×¦×’</button>
    <button class="btn btn-danger btn-sm" id="deleteSelectedBtn" onclick="deleteSelectedDonors()" style="display:none">ğŸ—‘ï¸ ××—×§ × ×‘×—×¨×™×</button>
    <button class="btn btn-outline btn-sm" id="exportWizBtn" onclick="openExportWizard()" style="display:none">ğŸ§™ ××©×£ ×™×™×¦×•×</button>
    <button class="btn btn-outline btn-sm" onclick="window.print()">ğŸ–¨ï¸</button>
    <button class="btn btn-outline btn-sm" onclick="openLabelsModal()">ğŸ·ï¸ ××“×‘×§×•×ª</button>
  </div>
  <div id="bulkActionBar" style="display:none;background:#fff3cd;border:1px solid #ffc107;border-radius:8px;padding:8px 14px;margin:0 18px 8px;display:none;align-items:center;gap:10px;flex-wrap:wrap">
    <span id="bulkCount" style="font-size:13px;font-weight:700;color:#856404">0 × ×‘×—×¨×•</span>
    <button class="btn btn-danger btn-sm" onclick="deleteSelectedDonors()">ğŸ—‘ï¸ ××—×§ × ×‘×—×¨×™×</button>
    <button class="btn btn-outline btn-sm" onclick="clearAllSelections()">âœ• ×‘×˜×œ ×‘×—×™×¨×”</button>
  </div>
  <div class="toolbar" style="padding:10px 18px">
    <select class="filter-select" id="fAffil" onchange="applyFilters()">
      <option value="">×›×œ ×”×©×™×•×›×™×</option>
      <option>×ª×œ××™×“</option><option>×‘×•×’×¨</option><option>×”×•×¨×” ×ª×œ××™×“</option><option>×”×•×¨×” ×‘×•×’×¨</option><option>××›×¨</option><option>×¢×¡×§×™</option><option>××—×¨</option>
    </select>
    <select class="filter-select" id="fPref" onchange="applyFilters()">
      <option value="">×›×œ ××•×¢×“×™ ×ª×¨××”</option>
      <option>×˜×œ×¤×•× ×™ ×œ×¤× ×™ ×¤×•×¨×™×</option><option>×¤×•×¨×™× ×‘×‘×™×ª</option><option>×˜×œ×¤×•× ×™ ×‘×¤×•×¨×™×</option>
    </select>
    <select class="filter-select" id="fMinDon" onchange="applyFilters()">
      <option value="">×›×œ ×”×¡×›×•××™×</option>
      <option value="500">××¢×œ â‚ª500</option><option value="1000">××¢×œ â‚ª1,000</option>
      <option value="5000">××¢×œ â‚ª5,000</option><option value="10000">××¢×œ â‚ª10,000</option>
    </select>
    <button class="filter-clear" onclick="clearFilters()">× ×§×” ×¡×™× ×•×Ÿ</button>
    <span style="margin-right:auto;font-size:12px;color:var(--muted)" id="filterInfo"></span>
  </div>
  <div class="table-wrap">
    <div class="table-info"><span id="tableCount">0 ×ª×•×¨××™×</span><span id="tableSum" style="font-weight:700;color:var(--navy)"></span></div>
    <div class="table-scroll">
      <table id="donorsTable">
        <thead><tr>
          <th style="width:36px;padding:6px"><input type="checkbox" id="selectAllDonors" onclick="toggleSelectAllDonors(this)" title="×‘×—×¨ ×”×›×œ"></th>
          <th onclick="sortTable('code')" data-col="code"><span class="si">â‡…</span>×§×•×“</th>
          <th onclick="sortTable('name')" data-col="name"><span class="si">â‡…</span>×©×</th>
          <th onclick="sortTable('affil')" data-col="affil"><span class="si">â‡…</span>×©×™×•×š</th>
          <th>×›×ª×•×‘×ª</th><th>×˜×œ×¤×•×Ÿ / ×¡×œ×•×œ×¨×™</th><th>××™×™×œ</th>
          <th onclick="sortTable('prefTime')" data-col="prefTime"><span class="si">â‡…</span>××•×¢×“ ×ª×¨××”</th>
          <th onclick="sortTable('total')" data-col="total"><span class="si">â‡…</span>×¡×š ×ª×¨×•××•×ª</th>
          <th onclick="sortTable('maxDon')" data-col="maxDon"><span class="si">â‡…</span>×’×‘×•×”×” ×‘×™×•×ª×¨</th>
          <th onclick="sortTable('createdAt')" data-col="createdAt"><span class="si">â‡…</span>×ª××¨×™×š ×™×¦×™×¨×”</th>
          <th>×¤×¢×•×œ×•×ª</th>
        </tr></thead>
        <tbody id="donorsBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â• CAMPAIGN PAGE â•â•â•â• -->
<div class="page" id="pageCampaign">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
    <h2 style="font-family:'Frank Ruhl Libre',serif;font-size:24px">ğŸ¯ ××’×‘×™×•×ª</h2>
    <button class="btn btn-gold" onclick="openNewCampaignModal()" id="addCampBtn">+ ××’×‘×™×ª ×—×“×©×”</button>
  </div>
  <div id="campaignContent"></div>
</div>

<!-- â•â•â•â• FUTURE PAGE â•â•â•â• -->
<div class="page" id="pageFuture">
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
    <h2 style="font-family:'Frank Ruhl Libre',serif;font-size:22px">â­ ×ª×¨×•××•×ª ×¢×ª×™×“×™×•×ª ××ª×•×›× × ×•×ª</h2>
  </div>
  <div class="toolbar" style="gap:8px">
    <input type="text" class="search-input" id="futureSearch" placeholder="ğŸ” ×—×™×¤×•×© ×©× / ×”×¢×¨×•×ª..." oninput="renderFuturePage()" style="max-width:280px">
    <select class="filter-select" id="futureSort" onchange="renderFuturePage()">
      <option value="date">××™×•×Ÿ: ×ª××¨×™×š</option><option value="name">××™×•×Ÿ: ×©×</option><option value="amount">××™×•×Ÿ: ×¡×›×•×</option>
    </select>
    <select class="filter-select" id="futureSortDir" onchange="renderFuturePage()">
      <option value="asc">×¢×•×œ×” â†‘</option><option value="desc">×™×•×¨×“ â†“</option>
    </select>
    <span id="futureCount" style="font-size:13px;color:var(--muted)"></span>
  </div>
  <div class="table-wrap">
    <div class="table-scroll">
      <table>
        <thead><tr>
          <th onclick="setFSort('name')"><span class="si">â‡…</span>×©× ×ª×•×¨×</th>
          <th>×§×•×“</th><th>×©×™×•×š</th>
          <th onclick="setFSort('date')"><span class="si">â‡…</span>×ª××¨×™×š ×™×¢×“</th>
          <th>×ª××¨×™×š ×¢×‘×¨×™</th>
          <th onclick="setFSort('amount')"><span class="si">â‡…</span>×¡×›×•× ×¦×¤×•×™</th>
          <th>×”×¢×¨×•×ª</th><th>×¡×œ×•×œ×¨×™</th><th>×¤×¢×•×œ×•×ª</th>
        </tr></thead>
        <tbody id="futureBody"></tbody>
      </table>
    </div>
  </div>
</div>


<!-- â•â•â•â• FUNDRAISERS PAGE â•â•â•â• -->
<div class="page" id="pageFundraisers">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px">
    <h2 style="font-family:'Frank Ruhl Libre',serif;font-size:24px">ğŸ“ ××ª×¨×™××™×</h2>
    <div style="display:flex;gap:8px" id="frBtns">
      <button class="btn btn-outline" onclick="openGroupModal()">ğŸ‘¥ ×§×‘×•×¦×” ×—×“×©×”</button>
      <button class="btn btn-gold" onclick="openFRModal()">+ ×”×•×¡×£ ××ª×¨×™×</button>
    </div>
  </div>
  <!-- Sub-tabs -->
  <div class="modal-tabs" style="margin-bottom:16px">
    <div class="modal-tab active" id="frtab-list" onclick="switchFRTab('list')">ğŸ“‹ ×¨×©×™××ª ××ª×¨×™××™×</div>
    <div class="modal-tab" id="frtab-groups" onclick="switchFRTab('groups')">ğŸ‘¥ ×§×‘×•×¦×•×ª</div>
  </div>

  <!-- LIST TAB -->
  <div id="frcontent-list">
    <div class="toolbar" style="gap:8px">
      <input type="text" class="search-input" id="frSearch" placeholder="ğŸ” ×©×, ×§×•×“, ×•×•×¢×“..." oninput="renderFRList()" style="max-width:260px">
      <select class="filter-select" id="frVaad" onchange="renderFRList()">
        <option value="">×›×œ ×”×•×•×¢×“×™×</option>
        <option>×•×•×¢×“ ×</option><option>×•×•×¢×“ ×‘</option><option>×•×•×¢×“ ×’</option>
        <option>×•×•×¢×“ ×“</option><option>×•×•×¢×“ ×”</option><option>×•×•×¢×“ ×•</option>
      </select>
      <label class="btn btn-outline btn-sm" style="cursor:pointer" title="×¤×•×¨××˜ ××§×¡×œ × ×“×¨×©: ×§×•×“ | ×©× ×¤×¨×˜×™ | ×©× ××©×¤×—×” | ×•×•×¢×“ | ×§×•×“ ×§×‘×•×¦×” | ×˜×œ×¤×•×Ÿ ×‘×™×ª | ×¤×œ××¤×•×Ÿ | ×™×¢×“">
        ğŸ“¥ ×™×™×‘×•× ××§×¡×œ â„¹
        <input type="file" accept=".xlsx,.xls" style="display:none" onchange="importFR(this)">
      </label>
      <button class="btn btn-outline btn-sm" onclick="showFRImportFormat()" title="××” ×¤×•×¨××˜ ×”×§×•×‘×¥?">ğŸ“‹ ×¤×•×¨××˜ ×§×•×‘×¥</button>
      <span id="frCountLabel" style="font-size:12px;color:var(--muted)"></span>
    </div>
    <div class="table-wrap">
      <div class="table-scroll">
        <table>
          <thead><tr>
            <th onclick="sortFRL('code')"><span class="sort-icon">â‡…</span>×§×•×“</th>
            <th onclick="sortFRL('name')"><span class="sort-icon">â‡…</span>×©×</th>
            <th onclick="sortFRL('vaad')"><span class="sort-icon">â‡…</span>×•×•×¢×“</th>
            <th onclick="sortFRL('groupCode')"><span class="sort-icon">â‡…</span>×§×•×“ ×§×‘×•×¦×”</th>
            <th>×˜×œ×¤×•×Ÿ ×‘×™×ª</th>
            <th>×¤×œ××¤×•×Ÿ</th>
            <th>×˜×œ' ×–××™×Ÿ</th>
            <th onclick="sortFRL('target')"><span class="sort-icon">â‡…</span>×™×¢×“ ××™×©×™</th>
            <th onclick="sortFRL('raised')"><span class="sort-icon">â‡…</span>×’×™×™×¡</th>
            <th>×”×ª×§×“××•×ª</th>
            <th>×¤×¢×•×œ×•×ª</th>
          </tr></thead>
          <tbody id="frListBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- GROUPS TAB -->
  <div id="frcontent-groups" style="display:none">
    <div class="toolbar" style="gap:8px">
      <input type="text" class="search-input" id="grpSearch" placeholder="ğŸ” ×—×™×¤×•×© ×§×‘×•×¦×”..." oninput="renderGroupsList()" style="max-width:260px">
    </div>
    <div id="groupsListContainer"></div>
  </div>
</div>


<!-- â•â•â•â• DONATIONS PAGE â•â•â•â• -->
<div class="page" id="pageDonations">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px">
    <h2 style="font-family:'Frank Ruhl Libre',serif;font-size:22px">ğŸ’° ×¤×× ×œ ×ª×¨×•××•×ª</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-outline btn-sm" id="donsPanelExport" onclick="exportDonationsPanel()">ğŸ“¤ ×™×™×¦×•×</button>
    </div>
  </div>
  <div class="toolbar" style="gap:8px;flex-wrap:wrap">
    <input type="text" class="search-input" id="donsSearch" placeholder="ğŸ” ×©× ×ª×•×¨× / ×”×¢×¨×•×ª..." oninput="renderDonationsPanel()" style="max-width:200px">
    <select class="filter-select" id="donsCamp" onchange="renderDonationsPanel()">
      <option value="">×›×œ ×”××’×‘×™×•×ª</option>
    </select>
    <select class="filter-select" id="donsMethod" onchange="renderDonationsPanel()">
      <option value="">×›×œ ××•×¤× ×™ ×ª×©×œ×•×</option>
      <option>××–×•××Ÿ</option><option>××©×¨××™</option><option>×¦'×§</option><option>×”×¢×‘×¨×” ×‘× ×§××™×ª</option>
    </select>
    <select class="filter-select" id="donsFR" onchange="renderDonationsPanel()">
      <option value="">×›×œ ×”××ª×¨×™××™×</option>
    </select>
    <input type="date" class="filter-select" id="donsFrom" onchange="renderDonationsPanel()" style="width:130px" title="××ª××¨×™×š">
    <input type="date" class="filter-select" id="donsTo" onchange="renderDonationsPanel()" style="width:130px" title="×¢×“ ×ª××¨×™×š">
    <span id="donsPanelCount" style="font-size:12px;color:var(--muted);margin-right:6px"></span>
  </div>
  
  <!-- Summary cards -->
  <div class="sg" style="grid-template-columns:repeat(4,1fr);margin:12px 0" id="donsPanelStats"></div>
  
  <div class="table-wrap">
    <div class="table-scroll">
      <table id="donsPanelTable">
        <thead><tr>
          <th onclick="sortDonsPanel('date')">×ª××¨×™×š â‡…</th>
          <th>×ª' ×¢×‘×¨×™</th>
          <th onclick="sortDonsPanel('donor')">×ª×•×¨× â‡…</th>
          <th onclick="sortDonsPanel('amount')">×¡×›×•× â‡…</th>
          <th>××•×¤×Ÿ</th>
          <th>××’×‘×™×ª</th>
          <th>××ª×¨×™× / ×§×‘×•×¦×”</th>
          <th>×”×¢×¨×•×ª</th>
          <th></th>
        </tr></thead>
        <tbody id="donsPanelBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â•â• ADMIN PAGE â•â•â•â• -->
<div class="page" id="pageAdmin">
  <h2 style="font-family:'Frank Ruhl Libre',serif;font-size:24px;margin-bottom:20px">âš™ï¸ ×¤×× ×œ × ×™×”×•×œ</h2>
  <div class="admin-grid">
    <div class="admin-card" onclick="openUsersModal()"><div class="ac-icon">ğŸ‘¤</div><h3>× ×™×”×•×œ ××©×ª××©×™×</h3><p>×”×•×¡×¤×”, ×¢×¨×™×›×”, ×”×¨×©××•×ª</p></div>
    <div class="admin-card" onclick="openSettingsModal()"><div class="ac-icon">ğŸ“‹</div><h3>× ×ª×•× ×™× ×§×©×™×—×™×</h3><p>×¢×¨×™×›×ª ×¨×©×™××•×ª</p></div>
    <div class="admin-card" onclick="openImportModal()"><div class="ac-icon">ğŸ“¥</div><h3>×™×™×‘×•× ×××§×¡×œ</h3><p>×˜×¢×™× ×ª ×ª×•×¨××™×</p></div>
    <div class="admin-card" onclick="exportExcel()"><div class="ac-icon">ğŸ“¤</div><h3>×™×™×¦×•× ×œ××§×¡×œ</h3><p>×›×œ ×”××™×“×¢</p></div>
    <div class="admin-card" onclick="openReportsModal()"><div class="ac-icon">ğŸ“Š</div><h3>×“×•×—×•×ª ×•×¡×™× ×•×Ÿ</h3><p>×¤×™×œ×•×— ××ª×§×“× ×¢× ×™×™×¦×•×</p></div>
    <div class="admin-card" onclick="showPage('campaign')"><div class="ac-icon">ğŸ¯</div><h3>××’×‘×™×•×ª</h3><p>× ×™×”×•×œ ××’×‘×™×•×ª ×©× ×ª×™×•×ª</p></div>
    <div class="admin-card" onclick="openPrintModal()"><div class="ac-icon">ğŸ–¨ï¸</div><h3>×”×“×¤×¡×•×ª</h3><p>××“×‘×§×•×ª, ×’×™×œ×™×•× ×•×ª, ×“×•×—×•×ª</p></div>
    <div class="admin-card" onclick="openExportWizard()"><div class="ac-icon">ğŸ§™</div><h3>××©×£ ×™×™×¦×•×</h3><p>×‘×—×™×¨×ª ×¢××•×“×•×ª ×•×¡×™× ×•×Ÿ</p></div>
  </div>
</div>

<!-- â•â•â•â• REPORT PAGE â•â•â•â• -->
<div class="page" id="pageReport">
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
    <button class="btn btn-outline btn-sm" onclick="showPage('admin')">â† ×—×–×¨×”</button>
    <h2 style="font-family:'Frank Ruhl Libre',serif;font-size:22px">ğŸ“Š ×“×•×—×•×ª ×•×¤×™×œ×•×—×™×</h2>
  </div>
  <div class="toolbar" style="flex-direction:column;align-items:flex-start;gap:14px">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <select class="filter-select" id="rpt_affil"><option value="">×›×œ ×”×©×™×•×›×™×</option><option>×ª×œ××™×“</option><option>×‘×•×’×¨</option><option>×”×•×¨×” ×ª×œ××™×“</option><option>×”×•×¨×” ×‘×•×’×¨</option><option>××›×¨</option><option>×¢×¡×§×™</option></select>
      <select class="filter-select" id="rpt_pref"><option value="">×›×œ ××•×¢×“×™ ×ª×¨××”</option><option>×˜×œ×¤×•× ×™ ×œ×¤× ×™ ×¤×•×¨×™×</option><option>×¤×•×¨×™× ×‘×‘×™×ª</option><option>×˜×œ×¤×•× ×™ ×‘×¤×•×¨×™×</option></select>
      <select class="filter-select" id="rpt_camp"><option value="">×›×œ ×”××’×‘×™×•×ª</option></select>
      <select class="filter-select" id="rpt_min"><option value="">×œ×œ× ××™× ×™××•×</option><option value="500">××¢×œ â‚ª500</option><option value="1000">××¢×œ â‚ª1,000</option><option value="5000">××¢×œ â‚ª5,000</option></select>
      <input type="date" class="filter-select" id="rpt_fromDate" title="××ª××¨×™×š">
      <input type="date" class="filter-select" id="rpt_toDate" title="×¢×“ ×ª××¨×™×š">
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-navy" onclick="generateReport()">ğŸ“Š ×”×¤×§ ×“×•×—</button>
      <button class="btn btn-outline" onclick="exportReport()">ğŸ“¤ ×™×™×¦×•×</button>
      <button class="btn btn-outline btn-sm" onclick="window.print()">ğŸ–¨ï¸</button>
    <button class="btn btn-outline btn-sm" onclick="openLabelsModal()">ğŸ·ï¸ ××“×‘×§×•×ª</button>
    </div>
  </div>
  <div id="reportOutput"></div>
</div>


<!-- FUNDRAISER MODAL -->
<div class="modal-overlay" id="frModal">
  <div class="modal" style="width:600px">
    <div class="modal-header"><h3 id="frModalTitle">×”×•×¡×¤×ª ××ª×¨×™×</h3><button class="modal-close" onclick="closeModal('frModal')">âœ•</button></div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
        <div class="fg"><label class="form-label">×§×•×“ ××ª×¨×™×</label><input class="form-control" id="fr_code" readonly></div>
        <div class="fg"><label class="form-label">×©× ×¤×¨×˜×™ <span class="required">*</span></label><input class="form-control" id="fr_firstName" placeholder="×©× ×¤×¨×˜×™" onkeydown="if(event.key==='Enter')saveFR()"></div>
        <div class="fg"><label class="form-label">×©× ××©×¤×—×” <span class="required">*</span></label><input class="form-control" id="fr_lastName" placeholder="×©× ××©×¤×—×”" onkeydown="if(event.key==='Enter')saveFR()"></div>
        <div class="fg"><label class="form-label">×•×•×¢×“ (×©×™×¢×•×¨)</label>
          <select class="form-control" id="fr_vaad">
            <option value="">-</option>
            <option>×•×•×¢×“ ×</option><option>×•×•×¢×“ ×‘</option><option>×•×•×¢×“ ×’</option>
            <option>×•×•×¢×“ ×“</option><option>×•×•×¢×“ ×”</option><option>×•×•×¢×“ ×•</option>
            <option>×•×•×¢×“ ×–</option><option>×•×•×¢×“ ×—</option><option>×•×•×¢×“ ×˜</option>
          </select>
        </div>
        <div class="fg"><label class="form-label">×§×•×“ ×§×‘×•×¦×”</label><input class="form-control" id="fr_groupCode" placeholder="×œ××©×œ: 101" maxlength="3" onkeydown="if(event.key==='Enter')saveFR()"></div>
        <div class="fg"><label class="form-label">×™×¢×“ ××™×©×™ (â‚ª)</label><input class="form-control" id="fr_target" type="number" placeholder="0" min="0" onkeydown="if(event.key==='Enter')saveFR()"></div>
        <div class="fg"><label class="form-label">×˜×œ×¤×•×Ÿ ×‘×™×ª</label><input class="form-control" id="fr_homePhone" onkeydown="if(event.key==='Enter')saveFR()"></div>
        <div class="fg"><label class="form-label">×¤×œ××¤×•×Ÿ</label><input class="form-control" id="fr_mobile" onkeydown="if(event.key==='Enter')saveFR()"></div>
        <div class="fg"><label class="form-label">×˜×œ×¤×•×Ÿ ×–××™×Ÿ</label>
          <select class="form-control" id="fr_availPhone">
            <option value="mobile">×¤×œ××¤×•×Ÿ</option>
            <option value="home">×˜×œ×¤×•×Ÿ ×‘×™×ª</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger btn-sm" id="frDeleteBtn" onclick="deleteFR()" style="margin-left:auto;display:none">ğŸ—‘ï¸ ××—×§</button>
      <button class="btn btn-outline btn-sm" onclick="closeModal('frModal')">×‘×™×˜×•×œ</button>
      <button class="btn btn-outline btn-sm" onclick="saveFRandNew()">ğŸ’¾ ×©××•×¨ ×•×—×“×©</button>
      <button class="btn btn-navy" onclick="saveFR()">×©××•×¨</button>
      <input type="hidden" id="fr_editId">
    </div>
  </div>
</div>

<!-- GROUP MODAL -->
<div class="modal-overlay" id="groupModal">
  <div class="modal modal-lg">
    <div class="modal-header"><h3 id="grpModalTitle">×§×‘×•×¦×” ×—×“×©×”</h3><button class="modal-close" onclick="closeModal('groupModal')">âœ•</button></div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:18px">
        <div class="fg"><label class="form-label">×§×•×“ ×§×‘×•×¦×”</label><input class="form-control" id="grp_code" readonly></div>
        <div class="fg" style="grid-column:span 2"><label class="form-label">×©× ×§×‘×•×¦×” <span class="required">*</span></label><input class="form-control" id="grp_name" placeholder="×©× ×”×§×‘×•×¦×”" onkeydown="if(event.key==='Enter')saveGroup()"></div>
        <div class="fg"><label class="form-label">×•×•×¢×“ ×¢×™×§×¨×™</label>
          <select class="form-control" id="grp_vaad" onchange="updateGrpCode()">
            <option value="">××¢×•×¨×‘ (9xx)</option>
            <option>×•×•×¢×“ ×</option><option>×•×•×¢×“ ×‘</option><option>×•×•×¢×“ ×’</option>
            <option>×•×•×¢×“ ×“</option><option>×•×•×¢×“ ×”</option><option>×•×•×¢×“ ×•</option>
          </select>
        </div>
        <div class="fg"><label class="form-label">×™×¢×“ ×§×‘×•×¦×ª×™ (â‚ª)</label><input class="form-control" id="grp_target" type="number" placeholder="0" min="0" onkeydown="if(event.key==='Enter')saveGroup()"></div>
        <div class="fg"><label class="form-label">×”×¢×¨×•×ª</label><input class="form-control" id="grp_notes" onkeydown="if(event.key==='Enter')saveGroup()"></div>
      </div>

      <!-- Members section -->
      <div style="margin-bottom:18px">
        <strong style="font-size:14px">×—×‘×¨×™ ×”×§×‘×•×¦×” (<span id="grpMemberCount">0</span>)</strong>
        <div style="display:flex;gap:6px;margin-top:8px;margin-bottom:6px">
          <input class="form-control" id="grp_member_search" placeholder="×”×•×¡×£ ××ª×¨×™× ×œ×¤×™ ×©× ××• ×§×•×“..." oninput="searchFRforGroup()" style="flex:1">
        </div>
        <div class="pick-results" id="grp_member_results"></div>
        <div id="grpMembersList" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px"></div>
      </div>

      <!-- Donors section -->
      <div>
        <strong style="font-size:14px">×ª×•×¨××™× ××©×•×™×™×›×™× (<span id="grpDonorCount">0</span>)</strong>
        <div style="display:flex;gap:6px;margin-top:8px;margin-bottom:6px">
          <input class="form-control" id="grp_donor_search" placeholder="×”×•×¡×£ ×ª×•×¨× ×œ×¤×™ ×©×, ×›×ª×•×‘×ª ××• ×§×•×“..." oninput="searchDonorForGroup()" style="flex:1">
        </div>
        <div class="pick-results" id="grp_donor_results"></div>
        <div id="grpDonorsList" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger btn-sm" id="grpDeleteBtn" onclick="deleteGroup()" style="margin-left:auto;display:none">ğŸ—‘ï¸ ××—×§ ×§×‘×•×¦×”</button>
      <button class="btn btn-outline btn-sm" onclick="closeModal('groupModal')">×‘×™×˜×•×œ</button>
      <button class="btn btn-navy" onclick="saveGroup()">×©××•×¨ ×§×‘×•×¦×”</button>
      <input type="hidden" id="grp_editId">
    </div>
  </div>
</div>

<!-- SWITCH USER MODAL -->
<div class="modal-overlay" id="switchUserModal">
  <div class="modal modal-sm">
    <div class="modal-header"><h3>ğŸ”„ ××¢×‘×¨ ××”×™×¨ ×œ××©×ª××©</h3><button class="modal-close" onclick="closeModal('switchUserModal')">âœ•</button></div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--muted);margin-bottom:16px">×‘×—×¨ ××©×ª××© ×œ×”×ª×—×‘×¨×•×ª ×™×©×™×¨×”</p>
      <div class="fg" style="margin-bottom:12px"><label class="form-label">×¡×™×¡××”</label><input class="form-control" type="password" id="switchPass" placeholder="×”×–×Ÿ ×¡×™×¡××”..."></div>
      <div id="switchUserList"></div>
    </div>
  </div>
</div>


<!-- EXPORT WIZARD MODAL -->
<div class="modal-overlay" id="exportWizard">
  <div class="modal modal-lg">
    <div class="modal-header"><h3>ğŸ“¤ ××©×£ ×™×™×¦×•×</h3><button class="modal-close" onclick="closeModal('exportWizard')">âœ•</button></div>
    <div class="modal-body">
      <h4 style="font-size:13px;font-weight:700;margin-bottom:12px">×¤×™×œ×˜×¨×™×</h4>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">
        <div class="fg"><label class="form-label">×©×™×•×š</label>
          <select class="form-control" id="ex_affil"><option value="">×”×›×œ</option></select></div>
        <div class="fg"><label class="form-label">××’×‘×™×ª</label>
          <select class="form-control" id="ex_camp"><option value="">×”×›×œ</option></select></div>
        <div class="fg"><label class="form-label">×¡×›×•× ××™× ×™××œ×™ ×›×•×œ×œ (â‚ª)</label>
          <input class="form-control" id="ex_minTotal" type="number" placeholder="0" min="0"></div>
        <div class="fg"><label class="form-label">×¡×›×•× ××™× ' ×‘××’×‘×™×ª (â‚ª)</label>
          <input class="form-control" id="ex_minCamp" type="number" placeholder="0" min="0"></div>
        <div class="fg"><label class="form-label">××ª××¨×™×š</label>
          <input class="form-control" id="ex_from" type="date"></div>
        <div class="fg"><label class="form-label">×¢×“ ×ª××¨×™×š</label>
          <input class="form-control" id="ex_to" type="date"></div>
      </div>
      <h4 style="font-size:13px;font-weight:700;margin-bottom:8px">×¢××•×“×•×ª ×œ×™×™×¦×•×</h4>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px" id="ex_cols">
        <label class="col-pick"><input type="checkbox" value="×§×•×“" checked> ×§×•×“</label>
        <label class="col-pick"><input type="checkbox" value="×©×" checked> ×©×</label>
        <label class="col-pick"><input type="checkbox" value="×©×™×•×š" checked> ×©×™×•×š</label>
        <label class="col-pick"><input type="checkbox" value="×›×ª×•×‘×ª" checked> ×›×ª×•×‘×ª</label>
        <label class="col-pick"><input type="checkbox" value="×˜×œ×¤×•×Ÿ" checked> ×˜×œ×¤×•×Ÿ</label>
        <label class="col-pick"><input type="checkbox" value="×¡×œ×•×œ×¨×™" checked> ×¡×œ×•×œ×¨×™</label>
        <label class="col-pick"><input type="checkbox" value="××™×™×œ"> ××™×™×œ</label>
        <label class="col-pick"><input type="checkbox" value="××•×¢×“ ×ª×¨××”"> ××•×¢×“ ×ª×¨××”</label>
        <label class="col-pick"><input type="checkbox" value="×¡×š ×ª×¨×•××•×ª" checked> ×¡×š ×ª×¨×•××•×ª</label>
        <label class="col-pick"><input type="checkbox" value="×ª×¨×•××” ×’×‘×•×”×”"> ×ª×¨×•××” ×’×‘×•×”×”</label>
        <label class="col-pick"><input type="checkbox" value="××¡×¤×¨ ×ª×¨×•××•×ª"> ××¡×¤×¨ ×ª×¨×•××•×ª</label>
        <label class="col-pick"><input type="checkbox" value="×”×¢×¨×•×ª"> ×”×¢×¨×•×ª</label>
      </div>
      <div id="ex_preview" style="font-size:12px;background:var(--cream);padding:8px 12px;border-radius:7px;color:var(--muted)">×œ×—×¥ ×¢×œ ×ª×¦×•×’×” ××§×“×™××” ×œ×¤× ×™ ×”×™×™×¦×•×</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-sm" onclick="closeModal('exportWizard')">×‘×™×˜×•×œ</button>
      <button class="btn btn-outline btn-sm" onclick="previewExport()">ğŸ‘ ×ª×¦×•×’×” ××§×“×™××”</button>
      <button class="btn btn-navy" onclick="runExportWizard()">ğŸ“¥ ×™×™×¦× ×œ××§×¡×œ</button>
    </div>
  </div>
</div>

<!-- REPORTS MODAL -->
<div class="modal-overlay" id="reportsModal">
  <div class="modal modal-xl" style="width:780px">
    <div class="modal-header"><h3>ğŸ“Š ×“×•×—×•×ª ×•×¡×™× ×•×Ÿ ××ª×§×“×</h3><button class="modal-close" onclick="closeModal('reportsModal')">âœ•</button></div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px">
        <div class="fg"><label class="form-label">×¢×™×¨</label><input class="form-control" id="rpt_city" placeholder="×ª×œ ××‘×™×‘..."></div>
        <div class="fg"><label class="form-label">×©×›×•× ×” / ×¨×—×•×‘</label><input class="form-control" id="rpt_neigh" placeholder="×©×›×•× ×” / ×¨×—×•×‘..."></div>
        <div class="fg"><label class="form-label">××¡×¤×¨ ×§×‘×•×¦×”</label><input class="form-control" id="rpt_grpcode" placeholder="101..."></div>
        <div class="fg"><label class="form-label">×©× ×ª×•×¨×</label><input class="form-control" id="rpt_name" placeholder="×—×œ×§ ××©×..."></div>
        <div class="fg"><label class="form-label">×©×™×•×š</label><select class="form-control" id="rpt_affil"><option value="">×”×›×œ</option></select></div>
        <div class="fg"><label class="form-label">×”×ª×××•×ª (×§×©×¨)</label><select class="form-control" id="rpt_reltype"><option value="">×”×›×œ</option></select></div>
        <div class="fg"><label class="form-label">××•×¢×“ ×ª×¨××”</label><select class="form-control" id="rpt_preftime"><option value="">×”×›×œ</option></select></div>
        <div class="fg"><label class="form-label">××’×‘×™×ª</label><select class="form-control" id="rpt_camp"><option value="">×”×›×œ</option></select></div>
        <div class="fg"><label class="form-label">×ª×¨×•××” ××™× ' (â‚ª)</label><input class="form-control" id="rpt_minamt" type="number" placeholder="0" min="0"></div>
        <div class="fg"><label class="form-label">×”×•×¡×£ ×-×ª××¨×™×š</label><input class="form-control" id="rpt_addfrom" type="date"></div>
        <div class="fg"><label class="form-label">×”×•×¡×£ ×¢×“-×ª××¨×™×š</label><input class="form-control" id="rpt_addto" type="date"></div>
        <div class="fg"><label class="form-label">×ª×¨×•××” ××—×¨×•× ×” ×-</label><input class="form-control" id="rpt_lastfrom" type="date"></div>
      </div>
      <div id="rpt_count" style="font-size:13px;color:var(--muted);margin-bottom:10px"></div>
      <div style="overflow-x:auto;max-height:300px;overflow-y:auto">
        <table id="rpt_table" style="width:100%;min-width:600px;border-collapse:collapse;font-size:12px">
          <thead style="background:var(--navy);color:white;position:sticky;top:0">
            <tr>
              <th style="padding:7px 10px;text-align:right">×©×</th>
              <th style="padding:7px 10px;text-align:right">×›×ª×•×‘×ª</th>
              <th style="padding:7px 10px;text-align:right">×˜×œ×¤×•×Ÿ</th>
              <th style="padding:7px 10px;text-align:right">×©×™×•×š</th>
              <th style="padding:7px 10px;text-align:right">×¡×š ×ª×¨×•××•×ª</th>
              <th style="padding:7px 10px;text-align:right">×ª×¨×•××” ××—×¨×•× ×”</th>
            </tr>
          </thead>
          <tbody id="rpt_body"></tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-sm" onclick="closeModal('reportsModal')">×¡×’×•×¨</button>
      <button class="btn btn-outline btn-sm" onclick="runReport()">ğŸ” ×”×¤×¢×œ ×¡×™× ×•×Ÿ</button>
      <button class="btn btn-outline btn-sm" onclick="exportReport()">ğŸ“¥ ×™×™×¦×•× ×œ××§×¡×œ</button>
      <button class="btn btn-navy" onclick="printReport()">ğŸ–¨ï¸ ×”×“×¤×¡×”</button>
    </div>
  </div>
</div>

<!-- PRINT MODAL -->
<div class="modal-overlay" id="printModal">
  <div class="modal" style="width:560px">
    <div class="modal-header"><h3>ğŸ–¨ï¸ ××¨×›×– ×”×“×¤×¡×•×ª</h3><button class="modal-close" onclick="closeModal('printModal')">âœ•</button></div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        
        <div class="admin-card" onclick="openLabelsWizard()" style="cursor:pointer">
          <div class="ac-icon">ğŸ·ï¸</div>
          <div class="ac-title">××“×‘×§×•×ª</div>
          <div class="ac-sub">Tanex â€” ×‘×—×™×¨×ª × ×ª×•× ×™× ×•×¢×™×¦×•×‘</div>
        </div>
        
        <div class="admin-card" onclick="openFundraisingPrint()" style="cursor:pointer">
          <div class="ac-icon">ğŸ“‹</div>
          <div class="ac-title">×’×™×œ×™×•×Ÿ ×”×ª×¨××”</div>
          <div class="ac-sub">×œ×¤×™ ×¢×™×¨ / ×©×›×•× ×” / ×§×‘×•×¦×”</div>
        </div>
        
        <div class="admin-card" onclick="printGroupsOverview()" style="cursor:pointer">
          <div class="ac-icon">ğŸ‘¥</div>
          <div class="ac-title">×¡×§×™×¨×ª ×§×‘×•×¦×•×ª</div>
          <div class="ac-sub">×›×œ ×”×§×‘×•×¦×•×ª ×•×”×—×‘×¨×™×</div>
        </div>
        
        <div class="admin-card" onclick="printCampaignSummary()" style="cursor:pointer">
          <div class="ac-icon">ğŸ“ˆ</div>
          <div class="ac-title">×¡×™×›×•× ××’×‘×™×ª</div>
          <div class="ac-sub">× ×ª×•× ×™ ×”××’×‘×™×ª ×”×¤×¢×™×œ×”</div>
        </div>
        
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-sm" onclick="closeModal('printModal')">×¡×’×•×¨</button>
    </div>
  </div>
</div>

<!-- LABELS WIZARD MODAL -->
<div class="modal-overlay" id="labelsWizardModal">
  <div class="modal modal-lg" style="width:680px">
    <div class="modal-header"><h3>ğŸ·ï¸ ××©×£ ×”×“×¤×¡×ª ××“×‘×§×•×ª</h3><button class="modal-close" onclick="closeModal('labelsWizardModal')">âœ•</button></div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div>
          <h4 style="font-size:13px;font-weight:700;margin-bottom:10px">1. ××§×•×¨ × ×ª×•× ×™×</h4>
          <select class="form-control" id="lb_source" style="margin-bottom:8px">
            <option value="all">×›×œ ×”×ª×•×¨××™×</option>
            <option value="filtered">×ª×•×¨××™× ××¡×•× × ×™× (×œ×¤×™ ×¤×× ×œ × ×™×”×•×œ)</option>
            <option value="group">×§×‘×•×¦×” ×¡×¤×¦×™×¤×™×ª</option>
          </select>
          <select class="form-control" id="lb_group_sel" style="display:none;margin-bottom:8px">
            <option value="">-- ×‘×—×¨ ×§×‘×•×¦×” --</option>
          </select>
          
          <h4 style="font-size:13px;font-weight:700;margin:10px 0 8px">2. ×¤×•×¨××˜ Tanex</h4>
          <div style="display:flex;flex-direction:column;gap:6px">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:7px;border:1px solid var(--border);border-radius:7px">
              <input type="radio" name="lb_fmt" value="70x42" checked> 
              <div><strong>70Ã—42 ×"×</strong> â€” 21 ××“×‘×§×•×ª ×œ×“×£ (3Ã—7)</div>
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:7px;border:1px solid var(--border);border-radius:7px">
              <input type="radio" name="lb_fmt" value="70x29">
              <div><strong>70Ã—29.7 ×"×</strong> â€” 30 ××“×‘×§×•×ª ×œ×“×£ (3Ã—10)</div>
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:7px;border:1px solid var(--border);border-radius:7px">
              <input type="radio" name="lb_fmt" value="105x42">
              <div><strong>105Ã—42 ×"×</strong> â€” 14 ××“×‘×§×•×ª ×œ×“×£ (2Ã—7)</div>
            </label>
          </div>
        </div>
        <div>
          <h4 style="font-size:13px;font-weight:700;margin-bottom:10px">3. ×ª×•×›×Ÿ ×”××“×‘×§×”</h4>
          <div style="display:flex;flex-direction:column;gap:5px" id="lb_fields">
            <label class="lb-field-opt"><input type="checkbox" id="lbf_greeting" checked> ×¤×ª×™×— (×œ×›×‘×•×“...)</label>
            <label class="lb-field-opt"><input type="checkbox" id="lbf_title" checked> ×ª×•××¨</label>
            <label class="lb-field-opt"><input type="checkbox" id="lbf_name" checked> ×©× ××œ×</label>
            <label class="lb-field-opt"><input type="checkbox" id="lbf_closing" checked> ×©× ×¡×’×™×¨×”</label>
            <label class="lb-field-opt"><input type="checkbox" id="lbf_address" checked> ×›×ª×•×‘×ª</label>
            <label class="lb-field-opt"><input type="checkbox" id="lbf_city"> ×¢×™×¨ ×‘× ×¤×¨×“</label>
            <label class="lb-field-opt"><input type="checkbox" id="lbf_phone"> ×˜×œ×¤×•×Ÿ</label>
          </div>
          <h4 style="font-size:13px;font-weight:700;margin:12px 0 8px">4. ×¢×™×¦×•×‘</h4>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px">
            <div class="fg"><label class="form-label">×’×•×“×œ ×’×•×¤×Ÿ</label>
              <select class="form-control" id="lb_fontsize">
                <option value="8">8pt</option><option value="9" selected>9pt</option><option value="10">10pt</option><option value="11">11pt</option>
              </select>
            </div>
            <div class="fg"><label class="form-label">×’×•×¤×Ÿ</label>
              <select class="form-control" id="lb_font">
                <option value="Arial" selected>Arial</option><option value="David">David</option><option value="Tahoma">Tahoma</option>
              </select>
            </div>
          </div>
          <div id="lb_preview_box" style="margin-top:10px;border:1px solid var(--border);border-radius:7px;padding:10px;background:white;font-size:12px;min-height:60px">
            <div style="font-size:10px;color:var(--muted);margin-bottom:4px">×ª×¦×•×’×” ××§×“×™××”:</div>
            <div id="lb_preview"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-sm" onclick="closeModal('labelsWizardModal')">×‘×™×˜×•×œ</button>
      <button class="btn btn-outline btn-sm" onclick="previewLabel()">ğŸ‘ ×ª×¦×•×’×” ××§×“×™××”</button>
      <button class="btn btn-navy" onclick="runPrintLabels()">ğŸ–¨ï¸ ×”×“×¤×¡</button>
    </div>
  </div>
</div>

<!-- FUNDRAISING PRINT MODAL -->
<div class="modal-overlay" id="frPrintModal">
  <div class="modal modal-lg" style="width:640px">
    <div class="modal-header"><h3>ğŸ“‹ ×”×“×¤×¡×ª ×’×™×œ×™×•×Ÿ ×”×ª×¨××”</h3><button class="modal-close" onclick="closeModal('frPrintModal')">âœ•</button></div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="fg"><label class="form-label">×¡×•×’ ×—×œ×•×§×”</label>
          <select class="form-control" id="frp_type" onchange="onFrpTypeChange()">
            <option value="group">×œ×¤×™ ×§×‘×•×¦×”</option>
            <option value="city">×œ×¤×™ ×¢×™×¨</option>
            <option value="neigh">×œ×¤×™ ×©×›×•× ×” / ×¨×—×•×‘</option>
          </select>
        </div>
        <div class="fg" id="frp_group_row">
          <label class="form-label">×§×‘×•×¦×”</label>
          <select class="form-control" id="frp_group">
            <option value="">×›×œ ×”×§×‘×•×¦×•×ª</option>
          </select>
        </div>
        <div class="fg" id="frp_city_row" style="display:none">
          <label class="form-label">×¢×™×¨</label>
          <input class="form-control" id="frp_city" placeholder="×ª×œ ××‘×™×‘...">
        </div>
        <div class="fg" id="frp_neigh_row" style="display:none">
          <label class="form-label">×©×›×•× ×” / ×¨×—×•×‘</label>
          <input class="form-control" id="frp_neigh" placeholder="×©×›×•× ×”...">
        </div>
        <div class="fg" style="grid-column:span 2">
          <label class="form-label">××’×‘×™×ª (×œ×”×¦×’×ª × ×ª×•× ×™×)</label>
          <select class="form-control" id="frp_camp">
            <option value="">××’×‘×™×ª ×¤×¢×™×œ×”</option>
          </select>
        </div>
      </div>
      <div id="frp_preview" style="margin-top:10px;font-size:12px;color:var(--muted)"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-sm" onclick="closeModal('frPrintModal')">×‘×™×˜×•×œ</button>
      <button class="btn btn-outline btn-sm" onclick="previewFrPrint()">ğŸ‘ ×ª×¦×•×’×” ××§×“×™××”</button>
      <button class="btn btn-navy" onclick="runFrPrint()">ğŸ–¨ï¸ ×”×“×¤×¡</button>
    </div>
  </div>
</div>

</div><!-- /app -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- DONOR MODAL -->
<div class="modal-overlay" id="donorModal">
  <div class="modal modal-lg">
    <div class="modal-header">
      <h3 id="donorModalTitle">×ª×•×¨× ×—×“×©</h3>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-danger btn-sm" id="deleteDonorBtn" onclick="deleteCurrentDonor()" style="display:none">ğŸ—‘ï¸ ××—×§</button>
        <button class="btn btn-outline btn-sm" id="saveNewDonorBtn" onclick="saveDonorAndNew()" style="background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.4);color:white">ğŸ’¾ ×©××•×¨ + ×—×“×©</button>
        <button class="btn btn-gold btn-sm" id="saveDonorBtnTop" onclick="saveDonor()">âœ” ×©××•×¨</button>
        <button class="modal-close" onclick="closeModal('donorModal')">âœ•</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="tabs">
        <div class="tab active" id="dt-details" onclick="switchDTab('details')">ğŸ“‹ ×¤×¨×˜×™×</div>
        <div class="tab" id="dt-donations" onclick="switchDTab('donations')">ğŸ’° ×ª×¨×•××•×ª</div>
        <div class="tab" id="dt-future" onclick="switchDTab('future')">â­ ×¢×ª×™×“×™×•×ª</div>
        <div class="tab" id="dt-relations" onclick="switchDTab('relations')">ğŸ”— ×”×ª×××•×ª</div>
      </div>

      <!-- DETAILS TAB -->
      <div id="dc-details">
        <div class="fg3">
          <div class="fg"><label class="form-label">×§×•×“ ×ª×•×¨×</label><input class="form-control" id="f_code" readonly></div>
          <div class="fg"><label class="form-label">×ª×•××¨</label>
            <select class="form-control" id="f_title" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('f_firstName').focus()}"><option value="">×œ×œ×</option><option>×”×¨×‘</option><option>×“"×¨</option><option>×¤×¨×•×¤'</option><option>××¨</option><option>×’×‘'</option><option>×”×¨×‘× ×™×ª</option><option>×”××“××•"×¨</option></select>
          </div>
          <div class="fg"><label class="form-label">×©× ×¤×¨×˜×™ <span class="req">*</span></label><input class="form-control" id="f_firstName" placeholder="×©× ×¤×¨×˜×™" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('f_lastName').focus()}"></div>
          <div class="fg"><label class="form-label">×©× ××©×¤×—×” <span class="req">*</span></label><input class="form-control" id="f_lastName" placeholder="×©× ××©×¤×—×”" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('f_closingName').focus()}"></div>
          <div class="fg"><label class="form-label">×©× ×¡×’×™×¨×”</label>
            <select class="form-control" id="f_closingName" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('f_affil').focus()}"><option value="">-</option><option>×‘×‘×¨×›×”</option><option>×‘×›×‘×•×“ ×¨×‘</option><option>×‘×”×•×§×¨×”</option><option>×‘×™×“×™×“×•×ª</option><option>×‘×ª×•×“×”</option><option>×™×™×©×¨ ×›×—</option></select>
          </div>
          <div class="fg"><label class="form-label">×©×™×•×š</label>
            <select class="form-control" id="f_affil" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('f_address').focus()}"><option value="">-</option><option>×ª×œ××™×“</option><option>×‘×•×’×¨</option><option>×”×•×¨×” ×ª×œ××™×“</option><option>×”×•×¨×” ×‘×•×’×¨</option><option>××›×¨</option><option>×¢×¡×§×™</option><option>××—×¨</option></select>
          </div>
          <div class="fg half"><label class="form-label">×›×ª×•×‘×ª ××œ××”</label>
            <div style="position:relative">
              <input class="form-control" id="f_address" placeholder="×¨×—×•×‘, ××¡×¤×¨, ×¢×™×¨" autocomplete="off" oninput="addressAutocomplete(this.value)" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('f_entrance').focus()}">
              <div id="addressSuggestions" style="position:absolute;top:100%;right:0;left:0;background:white;border:1.5px solid var(--border);border-top:none;border-radius:0 0 8px 8px;z-index:100;max-height:200px;overflow-y:auto;display:none"></div>
            </div>
            <div id="addressMapPreview" style="margin-top:6px;display:none;border-radius:8px;overflow:hidden;height:120px"></div>
          </div>
          <div class="fg"><label class="form-label">×›× ×™×¡×” / ×§×•××”</label><input class="form-control" id="f_entrance" placeholder="×›× ×™×¡×” ×', ×§×•××” 3" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('f_phone').focus()}"></div>
          <div class="fg"><label class="form-label">×˜×œ×¤×•×Ÿ</label><input class="form-control" id="f_phone" placeholder="02-..." onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('f_mobile').focus()}"></div>
          <div class="fg"><label class="form-label">×¡×œ×•×œ×¨×™</label>
            <div class="ig"><input class="form-control" id="f_mobile" placeholder="05X-..." onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('f_email').focus()}"><button class="btn-icon wa" onclick="openWA()" title="WhatsApp">ğŸ’¬</button></div>
          </div>
          <div class="fg"><label class="form-label">××™×™×œ</label>
            <div class="ig"><input class="form-control" id="f_email" placeholder="email@example.com" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('f_prefTime').focus()}"><button class="btn-icon em" onclick="openMail()" title="×©×œ×— ××™×™×œ">âœ‰ï¸</button></div>
          </div>
          <div class="fg"><label class="form-label">××•×¢×“ ×ª×¨××” ×¨×¦×•×™</label>
            <select class="form-control" id="f_prefTime" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('f_marriageYear').focus()}"><option value="">×œ× × ×§×‘×¢</option><option>×˜×œ×¤×•× ×™ ×œ×¤× ×™ ×¤×•×¨×™×</option><option>×¤×•×¨×™× ×‘×‘×™×ª</option><option>×˜×œ×¤×•× ×™ ×‘×¤×•×¨×™×</option></select>
          </div>
          <div class="fg"><label class="form-label">×©× ×ª × ×™×©×•××™×Ÿ (×¢×‘×¨×™)</label><input class="form-control" id="f_marriageYear" placeholder="×ª×©× ×´×”" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('f_cohort').focus()}"></div>
          <div class="fg"><label class="form-label">××—×–×•×¨ (×©× ×” ×¢×‘×¨×™×ª)</label><input class="form-control" id="f_cohort" placeholder="×ª×©× ×´×”" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('f_createdAt').focus()}"></div>
          <div class="fg"><label class="form-label">×ª××¨×™×š ×™×¦×™×¨×”</label><input class="form-control" id="f_createdAt" type="date" onkeydown="if(event.key==='Enter'){event.preventDefault();document.getElementById('f_notes').focus()}"></div>
          <div class="fg full"><label class="form-label">×”×¢×¨×•×ª</label><textarea class="form-control" id="f_notes" rows="2" placeholder="×”×¢×¨×•×ª..."></textarea></div>
        </div>
      </div>

      <!-- DONATIONS TAB -->
      <div id="dc-donations" style="display:none">
        <div class="d-stats" id="donorStatsBox"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong style="font-size:14px">×”×™×¡×˜×•×¨×™×™×ª ×ª×¨×•××•×ª</strong>
          <button class="btn btn-gold btn-sm" onclick="toggleDonForm()" id="donFormBtn">+ ×”×•×¡×£ ×ª×¨×•××”</button>
        </div>
        <div id="donationFormBox" style="display:none;transition:all .2s;background:var(--cream);border-radius:10px;padding:16px;margin-bottom:14px">
          <div style="font-size:13px;font-weight:700;color:var(--navy);margin-bottom:10px">ğŸ’° <span id="donFormTitle">×”×•×¡×¤×ª ×ª×¨×•××”</span></div>
          <div class="fg2" style="gap:10px;margin-bottom:10px">
            <div class="fg"><label class="form-label">×¡×›×•× (â‚ª) <span class="req">*</span></label><input class="form-control" id="nd_amount" type="number" placeholder="0" min="0"></div>
            <div class="fg"><label class="form-label">×ª××¨×™×š ×ª×¨×•××”</label><input class="form-control" id="nd_date" type="date"></div>
            <div class="fg"><label class="form-label">××•×¤×Ÿ ×ª×¨×•××”</label>
              <select class="form-control" id="nd_method"><option>××–×•××Ÿ</option><option>××©×¨××™</option><option>×¦'×§</option><option>×”×¢×‘×¨×” ×‘× ×§××™×ª</option><option>××—×¨</option></select>
            </div>
            <div class="fg"><label class="form-label">××’×‘×™×ª</label><select class="form-control" id="nd_campaign"></select></div>
            <div class="fg"><label class="form-label">×©×™×•×š ×ª×¨×•××”</label>
              <select class="form-control" id="nd_don_type" onchange="toggleDonAssignType()">
                <option value="fr">××ª×¨×™× ×¡×¤×¦×™×¤×™</option>
                <option value="group">×§×‘×•×¦×” (×—×œ×•×§×” ×©×•×•×”)</option>
                <option value="none">×œ×œ× ×©×™×•×š</option>
              </select>
            </div>
            <div id="nd_fr_box" class="fg"><label class="form-label">×©×™×™×š ×œ: 
                <span style="font-size:11px;font-weight:400">
                  <label style="cursor:pointer"><input type="radio" name="nd_mode" value="fr" checked onchange="toggleDonMode('nd')"> ××ª×¨×™×</label> &nbsp;
                  <label style="cursor:pointer"><input type="radio" name="nd_mode" value="grp" onchange="toggleDonMode('nd')"> ×§×‘×•×¦×”</label>
                </span>
              </label>
              <div id="nd_fr_wrap">
              <div class="input-group">
                <input class="form-control" id="nd_fr_search" placeholder="×—×¤×© ×©× / ×§×•×“ ××ª×¨×™×..." oninput="searchFRinForm('nd_fr_search','nd_fr_results','nd_fr_id')">
                <button class="btn btn-outline btn-sm" onclick="clearFRSel('nd_fr_search','nd_fr_results','nd_fr_id')">âœ•</button>
              </div>
              </div>
              <div class="pick-results" id="nd_fr_results"></div>
              <input type="hidden" id="nd_fr_id">
              </div><!-- /nd_fr_wrap -->
              <div id="nd_grp_wrap" style="display:none">
                <input class="form-control" id="nd_grp_search" placeholder="×—×¤×© ×©× ×§×‘×•×¦×” / ×§×•×“..." oninput="searchGroupInForm('nd_grp')" style="margin-bottom:5px">
                <div id="nd_grp_results" class="pick-results" style="max-height:140px"></div>
                <input type="hidden" id="nd_grp_id">
                <div id="nd_grp_info" style="font-size:11px;color:var(--teal,#0891b2);margin-top:4px;padding:5px 8px;background:var(--cream);border-radius:5px;display:none"></div>
              </div>
            </div>
            <div id="nd_grp_box" class="fg" style="display:none"><label class="form-label">×§×‘×•×¦×”</label>
              <div class="input-group">
                <input class="form-control" id="nd_grp_search" placeholder="×—×¤×© ×§×‘×•×¦×”..." oninput="searchGroupInForm()">
                <button class="btn btn-outline btn-sm" onclick="clearGrpSel()">âœ•</button>
              </div>
              <div class="pick-results" id="nd_grp_results"></div>
              <input type="hidden" id="nd_grp_id">
              <div id="nd_grp_info" style="font-size:11px;color:var(--muted);margin-top:4px"></div>
            </div>
            <div class="fg full"><label class="form-label">×”×¢×¨×•×ª</label><input class="form-control" id="nd_notes" placeholder="×”×¢×¨×•×ª" onkeydown="if(event.key==='Enter')saveDonation()"></div>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn btn-outline btn-sm" onclick="cancelDonForm()">×‘×™×˜×•×œ</button>
            <button class="btn btn-gold btn-sm" onclick="saveDonation()">×©××•×¨ ×ª×¨×•××”</button>
          </div>
          <input type="hidden" id="nd_editIdx" value="">
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:13px">
          <thead style="background:var(--cream)"><tr>
            <th style="padding:8px 10px;text-align:right;font-size:11px;font-weight:700;color:var(--muted);border-bottom:2px solid var(--border)">×ª××¨×™×š</th>
            <th style="padding:8px 10px;text-align:right;font-size:11px;font-weight:700;color:var(--muted);border-bottom:2px solid var(--border)">×ª' ×¢×‘×¨×™</th>
            <th style="padding:8px 10px;text-align:right;font-size:11px;font-weight:700;color:var(--muted);border-bottom:2px solid var(--border)">×¡×›×•×</th>
            <th style="padding:8px 10px;text-align:right;font-size:11px;font-weight:700;color:var(--muted);border-bottom:2px solid var(--border)">××•×¤×Ÿ</th>
            <th style="padding:8px 10px;text-align:right;font-size:11px;font-weight:700;color:var(--muted);border-bottom:2px solid var(--border)">××’×‘×™×ª</th>
            <th style="padding:8px 10px;text-align:right;font-size:11px;font-weight:700;color:var(--muted);border-bottom:2px solid var(--border)">××ª×¨×™×</th>
            <th style="padding:8px 10px;text-align:right;font-size:11px;font-weight:700;color:var(--muted);border-bottom:2px solid var(--border)">×”×¢×¨×•×ª</th>
            <th style="padding:8px 10px;border-bottom:2px solid var(--border)"></th>
          </tr></thead>
          <tbody id="donationsBody"></tbody>
        </table>
      </div>

      <!-- FUTURE DONATIONS TAB -->
      <div id="dc-future" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <strong style="font-size:14px">×ª×¨×•××•×ª ×¢×ª×™×“×™×•×ª / ×ª×–×›×•×¨×•×ª</strong>
          <button class="btn btn-purple btn-sm" onclick="toggleFutureForm()" id="futureFormBtn">â­ ×”×•×¡×£ ×ª×¨×•××” ×¢×ª×™×“×™×ª</button>
        </div>
        <div id="futureFormBox" style="display:none;background:var(--purple-bg);border:1px solid #c4b5fd;border-radius:10px;padding:16px;margin-bottom:14px">
          <div style="font-size:13px;font-weight:700;color:var(--purple);margin-bottom:10px">â­ <span id="futureFormTitle">×”×•×¡×¤×ª ×ª×¨×•××” ×¢×ª×™×“×™×ª</span></div>
          <div class="fg3" style="gap:10px;margin-bottom:10px">
            <div class="fg"><label class="form-label">×ª××¨×™×š ×™×¢×“ <span class="req">*</span></label><input class="form-control" id="nf_date" type="date"></div>
            <div class="fg"><label class="form-label">×¡×›×•× ×¦×¤×•×™ (â‚ª)</label><input class="form-control" id="nf_amount" type="number" placeholder="×œ× ×—×•×‘×”" min="0"></div>
            <div class="fg"><label class="form-label">××’×‘×™×ª</label><select class="form-control" id="nf_campaign"></select></div>
            <div class="fg full"><label class="form-label">×”×¢×¨×•×ª / ×ª×–×›×•×¨×ª</label><input class="form-control" id="nf_notes" placeholder="×œ××©×œ: ×œ×ª×× ×œ××—×¨ ×¤×•×¨×™×..."></div>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn btn-outline btn-sm" onclick="cancelFutureForm()">×‘×™×˜×•×œ</button>
            <button class="btn btn-purple btn-sm" onclick="saveFutureDonation()">×©××•×¨</button>
          </div>
          <input type="hidden" id="nf_editIdx" value="">
        </div>
        <div id="futureItemsList"></div>
      </div>

      <!-- RELATIONS TAB -->
      <div id="dc-relations" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
          <strong>×”×ª×××•×ª â€” ×§×©×¨×™× ×¢× ×ª×•×¨××™× ××—×¨×™×</strong>
          <button class="btn btn-gold btn-sm" onclick="showRelSearch()">ğŸ”— ×”×•×¡×£ ×”×ª×××”</button>
        </div>
        <div id="relSearchBox" style="display:none;background:var(--cream);border-radius:10px;padding:14px;margin-bottom:14px">
          <div class="fg" style="margin-bottom:10px"><label class="form-label">×—×™×¤×•×© ×ª×•×¨×</label><input class="form-control" id="relSearch" placeholder="×—×¤×© ×œ×¤×™ ×©× ××• ×§×•×“..." oninput="searchRelDonors()"></div>
          <div id="relResults" style="max-height:180px;overflow-y:auto;margin-bottom:10px"></div>
          <div id="relSelected" style="display:none">
            <div class="fg" style="margin-bottom:10px"><label class="form-label">×¡×™×‘×ª ×©×™×•×š</label>
              <select class="form-control" id="relType"><option>×”×•×¨×”</option><option>×¡×‘×</option><option>×‘×Ÿ</option><option>×©×•×•×¢×¨</option><option>××—</option><option>×§×¨×•×‘</option></select>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button class="btn btn-outline btn-sm" onclick="cancelRel()">×‘×™×˜×•×œ</button>
              <button class="btn btn-gold btn-sm" onclick="confirmRel()">×”×•×¡×£ ×©×™×•×š</button>
            </div>
          </div>
        </div>
        <div id="relList"></div>
      </div>
    </div>
    <!-- footer replaced: buttons in header -->
  </div>
</div>

<!-- QUICK DONATION MODAL -->
<div class="modal-overlay" id="quickDonModal">
  <div class="modal modal-sm">
    <div class="modal-header"><h3>ğŸ’° ×”×•×¡×¤×ª ×ª×¨×•××” ××”×™×¨×”</h3><button class="modal-close" onclick="closeModal('quickDonModal')">âœ•</button></div>
    <div class="modal-body">
      <div class="fg" style="margin-bottom:12px">
        <label class="form-label">×—×™×¤×•×© ×ª×•×¨× <span class="req">*</span></label>
        <input class="form-control" id="qd_search" placeholder="×”×–×Ÿ ×©× ××• ×§×•×“ ×ª×•×¨×..." oninput="searchQDDonor()">
        <div id="qd_results" style="max-height:150px;overflow-y:auto;margin-top:6px"></div>
        <div id="qd_selected" style="display:none;margin-top:6px;padding:8px;background:var(--success-bg);border-radius:7px;font-size:13px"></div>
      </div>
      <div class="fg2" style="gap:10px;margin-bottom:10px">
        <div class="fg"><label class="form-label">×¡×›×•× (â‚ª) <span class="req">*</span></label><input class="form-control" id="qd_amount" type="number" placeholder="0" min="0"></div>
        <div class="fg"><label class="form-label">×ª××¨×™×š</label><input class="form-control" id="qd_date" type="date"></div>
        <div class="fg"><label class="form-label">××•×¤×Ÿ ×ª×¨×•××”</label>
          <select class="form-control" id="qd_method"><option>××–×•××Ÿ</option><option>××©×¨××™</option><option>×¦'×§</option><option>×”×¢×‘×¨×” ×‘× ×§××™×ª</option><option>××—×¨</option></select>
        </div>
        <div class="fg"><label class="form-label">××’×‘×™×ª</label><select class="form-control" id="qd_campaign"></select></div>
        <div class="fg"><label class="form-label">××ª×¨×™×</label>
          <div style="font-size:12px;margin-bottom:5px">
            <label style="cursor:pointer"><input type="radio" name="qd_mode" value="fr" checked onchange="toggleDonMode('qd')"> ğŸ‘¤ ××ª×¨×™× ×¡×¤×¦×™×¤×™</label>&nbsp;&nbsp;
            <label style="cursor:pointer"><input type="radio" name="qd_mode" value="grp" onchange="toggleDonMode('qd')"> ğŸ‘¥ ×§×‘×•×¦×”</label>
          </div>
          <div id="qd_fr_wrap">
            <div class="input-group">
              <input class="form-control" id="qd_fr_search" placeholder="×—×¤×© ××ª×¨×™×..." oninput="searchFRinForm('qd_fr_search','qd_fr_results','qd_fr_id')">
              <button class="btn btn-outline btn-sm" onclick="clearFRSel('qd_fr_search','qd_fr_results','qd_fr_id')" title="× ×§×”">âœ•</button>
            </div>
            <div class="pick-results" id="qd_fr_results"></div>
            <input type="hidden" id="qd_fr_id">
          </div>
          <div id="qd_grp_wrap" style="display:none">
            <input class="form-control" id="qd_grp_search" placeholder="×—×¤×© ×©× ×§×‘×•×¦×” / ×§×•×“..." oninput="searchGroupInForm('qd_grp')" style="margin-bottom:5px">
            <div id="qd_grp_results" class="pick-results" style="max-height:130px"></div>
            <input type="hidden" id="qd_grp_id">
            <div id="qd_grp_info" style="font-size:11px;color:var(--teal,#0891b2);margin-top:4px;padding:5px 8px;background:var(--cream);border-radius:5px;display:none"></div>
          </div>
        </div>
        <div class="fg full"><label class="form-label">×”×¢×¨×•×ª</label><input class="form-control" id="qd_notes" placeholder="×”×¢×¨×•×ª" onkeydown="if(event.key==='Enter')saveQuickDonation()"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline btn-sm" onclick="closeModal('quickDonModal')">×‘×™×˜×•×œ</button>
      <button class="btn btn-outline btn-sm" onclick="saveQuickDonationAndNew()">ğŸ’¾ ×©××•×¨ ×•×—×“×©</button>
      <button class="btn btn-navy" onclick="saveQuickDonation()">×©××•×¨ ×ª×¨×•××”</button>
    </div>
  </div>
</div>

<!-- CAMPAIGN MODAL -->
<div class="modal-overlay" id="campaignModal">
  <div class="modal modal-sm">
    <div class="modal-header"><h3 id="campModalTitle">××’×‘×™×ª ×—×“×©×”</h3><button class="modal-close" onclick="closeModal('campaignModal')">âœ•</button></div>
    <div class="modal-body">
      <div class="fg3" style="gap:12px">
        <div class="fg half"><label class="form-label">×©× ×”××’×‘×™×ª <span class="req">*</span></label><input class="form-control" id="cm_name" placeholder="×œ××©×œ: ××’×‘×™×ª ×¤×•×¨×™× ×ª×©×¤"×”"></div>
        <div class="fg"><label class="form-label">×©× ×” ×¢×‘×¨×™×ª</label><input class="form-control" id="cm_year" placeholder="×ª×©×¤"×”"></div>
        <div class="fg"><label class="form-label">×¡×›×•× ×™×¢×“ (â‚ª)</label><input class="form-control" id="cm_goal" type="number" placeholder="0" min="0"></div>
        <div class="fg">
          <label class="form-label">×ª××¨×™×š ×™×¢×“</label>
          <div style="display:flex;gap:6px">
            <input class="form-control" id="cm_deadline" type="date" style="flex:2">
            <input class="form-control" id="cm_deadline_time" type="time" value="23:59" style="flex:1" placeholder="×©×¢×”">
          </div>
        </div>
        <div class="fg"><label class="form-label">×©×¢×ª ×™×¢×“</label><input class="form-control" id="cm_deadline_time" type="time" value="23:59"></div>
        <div class="fg"><label class="form-label">×¡×˜×˜×•×¡</label>
          <select class="form-control" id="cm_active">
            <option value="true">×¤×¢×™×œ×”</option>
            <option value="false">×œ× ×¤×¢×™×œ×”</option>
          </select>
        </div>
        <div class="fg full"><label class="form-label">×ª×™××•×¨</label><textarea class="form-control" id="cm_desc" rows="2" placeholder="×ª×™××•×¨ ×§×¦×¨..."></textarea></div>
      </div>
      <div style="background:var(--gold-bg);border-radius:8px;padding:10px;margin-top:12px;font-size:12px;color:#7a5c00">
        âš ï¸ ×¨×§ ××’×‘×™×ª ××—×ª ×™×›×•×œ×” ×œ×”×™×•×ª ×¤×¢×™×œ×” ×‘×• ×–×× ×™×ª. ×¡×™××•×Ÿ ××’×‘×™×ª ×–×• ×›×¤×¢×™×œ×” ×ª×‘×˜×œ ××ª ×”×¤×¢×™×œ×” ×”× ×•×›×—×™×ª.
      </div>
    </div>
    <div class="modal-footer">
      <input type="hidden" id="cm_editId">
      <button class="btn btn-outline btn-sm" onclick="closeModal('campaignModal')">×‘×™×˜×•×œ</button>
      <button class="btn btn-navy" onclick="saveCampaign()">×©××•×¨ ××’×‘×™×ª</button>
    </div>
  </div>
</div>

<!-- USERS MODAL -->
<div class="modal-overlay" id="usersModal">
  <div class="modal">
    <div class="modal-header"><h3>ğŸ‘¤ × ×™×”×•×œ ××©×ª××©×™×</h3><button class="modal-close" onclick="closeModal('usersModal')">âœ•</button></div>
    <div class="modal-body">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <p style="font-size:13px;color:var(--muted)">3 ×¨××•×ª ×”×¨×©××”: ×¨×©× (××œ×) | ×¢×•×¨×š | ××‘×§×¨</p>
        <button class="btn btn-gold btn-sm" onclick="addUserRow()">+ ××©×ª××© ×—×“×©</button>
      </div>
      <table class="users-table"><thead><tr><th>×©× ××©×ª××©</th><th>×©× ×œ×ª×¦×•×’×”</th><th>×¡×™×¡××”</th><th>×”×¨×©××”</th><th></th></tr></thead><tbody id="usersBody"></tbody></table>
    </div>
    <div class="modal-footer"><button class="btn btn-navy" onclick="saveUsers()">×©××•×¨</button></div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <div class="modal-header"><h3>ğŸ“‹ ×¢×¨×™×›×ª × ×ª×•× ×™× ×§×©×™×—×™×</h3><button class="modal-close" onclick="closeModal('settingsModal')">âœ•</button></div>
    <div class="modal-body" id="settingsBody"></div>
    <div class="modal-footer"><button class="btn btn-navy" onclick="saveSettings()">×©××•×¨ ×•×¡×’×•×¨</button></div>
  </div>
</div>

<!-- IMPORT MODAL -->
<div class="modal-overlay" id="importModal">
  <div class="modal modal-sm">
    <div class="modal-header"><h3>ğŸ“¥ ×™×™×‘×•× ×××§×¡×œ</h3><button class="modal-close" onclick="closeModal('importModal')">âœ•</button></div>
    <div class="modal-body">
      <div style="background:var(--cream);border-radius:10px;padding:14px;margin-bottom:16px;font-size:12px">
        <strong style="font-size:13px">ğŸ“‹ ××‘× ×” ×§×•×‘×¥ ×”××§×¡×œ ×œ×™×™×‘×•× ×ª×•×¨××™×:</strong>
        <div style="margin-top:8px;font-family:monospace;font-size:11px;background:white;border-radius:6px;padding:10px;overflow-x:auto;white-space:nowrap;border:1px solid var(--border)">
          ×§×•×“ ×ª×•×¨× | ×ª×•××¨ | ×©× ×¤×¨×˜×™ | ×©× ××©×¤×—×” | ×©× ×¡×’×™×¨×” | ×©×™×•×š | ×›×ª×•×‘×ª | ×›× ×™×¡×” ×§×•××” | ×˜×œ×¤×•×Ÿ | ×¡×œ×•×œ×¨×™ | ××™×™×œ | ×©× ×ª × ×™×©×•××™×Ÿ | ××—×–×•×¨ | ××•×¢×“ ×ª×¨××” | ×”×¢×¨×•×ª
        </div>
        <div style="margin-top:8px;color:var(--muted)">
          <strong>×©×“×•×ª ×—×•×‘×”:</strong> ×©× ×¤×¨×˜×™ ×•/××• ×©× ××©×¤×—×”<br>
          <strong>×§×•×“ ×ª×•×¨×:</strong> ×™×™×•×•×¦×¨ ××•×˜×•××˜×™×ª ×× ×¨×™×§<br>
          <strong>×©×™×•×š:</strong> ×ª×œ××™×“ / ×‘×•×’×¨ / ×”×•×¨×” ×ª×œ××™×“ / ×”×•×¨×” ×‘×•×’×¨ / ××›×¨ / ×¢×¡×§×™ / ××—×¨
        </div>
      </div>
      <label class="btn btn-outline" style="cursor:pointer;display:block;text-align:center;padding:20px">
        ğŸ“‚ ×‘×—×¨ ×§×•×‘×¥ Excel (.xlsx / .xls)
        <input type="file" accept=".xlsx,.xls" style="display:none" onchange="importExcel(this)">
      </label>
      <div id="importStatus" style="margin-top:12px;font-size:13px"></div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let DB = { donors:[], users:[], campaigns:[], nextCode:1001 };
let currentUser = null;
let currentDonorId = null;
let currentDTab = 'details';
let sortCol = 'name', sortDir = 1;
let filteredRows = [];
let qd_selectedId = null;
let rel_selectedId = null;
let editingDonorFinal = false;

const DEFAULT_USERS = [
  { username:'admin', displayName:'×× ×”×œ ×¨××©×™', password:'admin123', role:'admin' },
  { username:'editor', displayName:'×¢×•×¨×š', password:'edit123', role:'editor' },
  { username:'viewer', displayName:'××‘×§×¨', password:'view123', role:'viewer' },
];

function loadDB() {
  const s = localStorage.getItem('donorDB_v6');
  if (s) { try { DB = JSON.parse(s); } catch(e){} }
  // Try v5 data for migration
  if (!DB.donors || !DB.donors.length) {
    const old = localStorage.getItem('donorDB_v5');
    if (old) { try { const o = JSON.parse(old); DB = {...DB, ...o}; } catch(e){} }
  }
  if (!DB.users||!DB.users.length) DB.users = DEFAULT_USERS;
  if (!DB.donors) DB.donors = [];
  if (!DB.campaigns) DB.campaigns = [];
  if (!DB.fundraisers) DB.fundraisers = [];
  if (!DB.groups) DB.groups = [];
  if (!DB.nextCode) DB.nextCode = 1001;
  if (!DB.nextFRCode) DB.nextFRCode = 1;
  if (!DB.nextGrpSeq) DB.nextGrpSeq = {};
  if (!DB.settings) DB.settings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
}
function saveDB() { localStorage.setItem('donorDB_v6', JSON.stringify(DB)); }
function donorName(d){return dName(d);}
function genCode() { return 'T'+String(DB.nextCode++).padStart(4,'0'); }

// Global Enter key = Save in open modal (save-and-new as default for new records)
document.addEventListener('keydown', function(e) {
  if (e.key !== 'Enter') return;
  if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  const open = document.querySelector('.modal-overlay.open');
  if (!open) return;
  // Don't intercept if in pick-results or address suggestions
  if (e.target.closest('.pick-results') || e.target.closest('#addressSuggestions')) return;
  e.preventDefault();
  const id = open.id;
  if (id === 'donorModal') {
    // Save and new for new donors, just save for edits
    if (!currentDonorId) saveDonorAndNew(); else saveDonor();
  }
  else if (id === 'campaignModal') saveCampaign();
  else if (id === 'frModal') {
    if (!document.getElementById('fr_editId').value) saveFRandNew(); else saveFR();
  }
  else if (id === 'groupModal') saveGroup();
  else if (id === 'quickDonModal') saveQuickDonation();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ROLES = {admin:'×¨×©×',editor:'×¢×•×¨×š',viewer:'××‘×§×¨'};
function can(p) {
  if (!currentUser) return false;
  if (p==='view') return true;
  if (p==='edit') return ['admin','editor'].includes(currentUser.role);
  if (p==='export'||p==='import'||p==='admin') return currentUser.role==='admin';
  return false;
}

// Editor can add/edit donors and donations but NOT access admin panel or export
function setupNavForRole() {
  if (!can('admin')) {
    document.getElementById('navAdmin').style.display='none';
    if(document.getElementById('addCampBtn')) document.getElementById('addCampBtn').style.display='none';
  }
  if (!can('edit')) document.getElementById('dashActions').style.display='none';
  if (can('export')) document.getElementById('exportBtn').style.display='';
  // Editor can see frBtns (add fundraiser/group)
  if (!can('edit') && document.getElementById('frBtns')) document.getElementById('frBtns').style.display='none';
}

function doLogin() {
  loadDB();
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  const user = DB.users.find(x=>x.username===u&&x.password===p);
  if (!user) { document.getElementById('loginError').style.display='block'; return; }
  currentUser = user;
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('topUserName').textContent = user.displayName;
  document.getElementById('topUserRole').textContent = ROLES[user.role];
  setupNavForRole();
  loadDemoIfEmpty();
  showPage('dash');
}
function doLogout() {
  currentUser=null;
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('app').style.display='none';
  document.getElementById('loginUser').value='';
  document.getElementById('loginPass').value='';
  document.getElementById('loginError').style.display='none';
}

function openSwitchUserModal() {
  document.getElementById('switchPass').value='';
  const list = document.getElementById('switchUserList');
  list.innerHTML = DB.users.filter(u=>u.username!==currentUser.username).map(u=>`
    <div style="display:flex;align-items:center;justify-content:space-between;background:var(--cream);border-radius:9px;padding:11px 14px;margin-bottom:8px;cursor:pointer;border:1.5px solid var(--border)" 
         onclick="doSwitchUser('${u.username}')" onmouseover="this.style.borderColor='var(--navy)'" onmouseout="this.style.borderColor='var(--border)'">
      <div>
        <strong>${u.displayName}</strong>
        <span class="badge" style="background:var(--cream-d);color:var(--muted);margin-right:8px;font-size:10px">${ROLES[u.role]||u.role}</span>
      </div>
      <span style="font-size:12px;color:var(--muted)">${u.username}</span>
    </div>`).join('');
  openModal('switchUserModal');
}

function doSwitchUser(username) {
  const pass = document.getElementById('switchPass').value;
  const user = DB.users.find(x=>x.username===username&&x.password===pass);
  if (!user) { alert('×¡×™×¡××” ×©×’×•×™×”'); return; }
  currentUser = user;
  document.getElementById('topUserName').textContent = user.displayName;
  document.getElementById('topUserRole').textContent = ROLES[user.role];
  // Update nav visibility
  document.getElementById('navAdmin').style.display = can('admin') ? '' : 'none';
  if(document.getElementById('addCampBtn')) document.getElementById('addCampBtn').style.display = can('admin') ? '' : 'none';
  if(document.getElementById('frBtns')) document.getElementById('frBtns').style.display = can('edit') ? '' : 'none';
  document.getElementById('dashActions').style.display = can('edit') ? '' : 'none';
  document.getElementById('exportBtn').style.display = can('export') ? '' : 'none';
  closeModal('switchUserModal');
  showPage('dash');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toHeb(d) {
  if (!d) return '';
  try {
    const dt = new Date(d+'T12:00:00');
    if (isNaN(dt)) return '';
    const parts = new Intl.DateTimeFormat('he-IL-u-ca-hebrew',{
      day:'numeric', month:'long', year:'numeric'
    }).formatToParts(dt);
    let day='', month='', year='';
    parts.forEach(p => {
      if(p.type==='day') day=p.value;
      if(p.type==='month') month=p.value;
      if(p.type==='year') year=p.value;
    });
    // Convert day number to Hebrew letters (×™×“, ×›, ×œ...)
    const hebDay = numToHebLet(parseInt(day));
    // Year: Intl may return numeric (5785) or already Hebrew - ensure Hebrew
    const hebYear = /^[0-9]+$/.test(year.trim()) ? gregToHebYear(parseInt(year)) : year;
    return hebDay + ' ' + month + ' ' + hebYear;
  } catch(e){ return ''; }
}
function numToHebLet(n) {
  // Converts numbers 1-30 to Hebrew day letters
  if (!n || n<=0) return '';
  const tbl=['','×','×‘','×’','×“','×”','×•','×–','×—','×˜','×™','×™×','×™×‘','×™×’','×™×“','×˜×•','×˜×–','×™×–','×™×—','×™×˜','×›',
             '×›×','×›×‘','×›×’','×›×“','×›×”','×›×•','×›×–','×›×—','×›×˜','×œ'];
  return (n>=1&&n<=30) ? tbl[n] : String(n);
}
function gregToHebYear(hebNumericYear) {
  // Convert Hebrew numeric year (e.g. 5785) to Hebrew letter notation (×ª×©×¤"×”)
  const y = hebNumericYear % 1000; // take last 3 digits (e.g. 785)
  const hundreds = Math.floor(y/100); // 7
  const tens_ones = y % 100;           // 85
  const H = ['','×§','×¨','×©','×ª'];    // 100-400
  const hundreds5 = ['','×ª×§','×ª×¨','×ª×©','×ª×ª','×ª×ª×§']; // 500-900
  let prefix = '';
  if (hundreds <= 4) prefix = H[hundreds];
  else prefix = hundreds5[Math.round(hundreds/1)] || H[4]; // fallback
  // Actually handle 100-999 properly:
  const H2 = {1:'×§',2:'×¨',3:'×©',4:'×ª',5:'×ª×§',6:'×ª×¨',7:'×ª×©',8:'×ª×ª',9:'×ª×ª×§'};
  prefix = H2[hundreds] || '';
  const T = {
    1:'×',2:'×‘',3:'×’',4:'×“',5:'×”',6:'×•',7:'×–',8:'×—',9:'×˜',
    10:'×™',11:'×™×',12:'×™×‘',13:'×™×’',14:'×™×“',15:'×˜×•',16:'×˜×–',
    17:'×™×–',18:'×™×—',19:'×™×˜',20:'×›',21:'×›×',22:'×›×‘',23:'×›×’',
    24:'×›×“',25:'×›×”',26:'×›×•',27:'×›×–',28:'×›×—',29:'×›×˜',30:'×œ',
    31:'×œ×',32:'×œ×‘',33:'×œ×’',34:'×œ×“',35:'×œ×”',36:'×œ×•',37:'×œ×–',
    38:'×œ×—',39:'×œ×˜',40:'×',41:'××',42:'××‘',43:'××’',44:'××“',
    45:'××”',46:'××•',47:'××–',48:'××—',49:'××˜',50:'× ',51:'× ×',
    52:'× ×‘',53:'× ×’',54:'× ×“',55:'× ×”',56:'× ×•',57:'× ×–',58:'× ×—',
    59:'× ×˜',60:'×¡',61:'×¡×',62:'×¡×‘',63:'×¡×’',64:'×¡×“',65:'×¡×”',
    66:'×¡×•',67:'×¡×–',68:'×¡×—',69:'×¡×˜',70:'×¢',71:'×¢×',72:'×¢×‘',
    73:'×¢×’',74:'×¢×“',75:'×¢×”',76:'×¢×•',77:'×¢×–',78:'×¢×—',79:'×¢×˜',
    80:'×¤',81:'×¤×',82:'×¤×‘',83:'×¤×’',84:'×¤×“',85:'×¤×”',86:'×¤×•',
    87:'×¤×–',88:'×¤×—',89:'×¤×˜',90:'×¦',91:'×¦×',92:'×¦×‘',93:'×¦×’',
    94:'×¦×“',95:'×¦×”',96:'×¦×•',97:'×¦×–',98:'×¦×—',99:'×¦×˜'
  };
  const suffix = tens_ones > 0 ? (T[tens_ones]||String(tens_ones)) : '';
  let result = '×”\''+prefix+suffix;
  // Add geresh: insert " before last letter
  if (result.length > 2) {
    result = result.slice(0,-1) + '"' + result.slice(-1);
  }
  return result;
}
function toHebYear(gregYear) {
  // Convert Gregorian year to approximate Hebrew year text
  if (!gregYear) return '';
  const n = parseInt(gregYear);
  if (isNaN(n)) return gregYear; // already Hebrew text
  // Hebrew year offset: add 3760 for years before Tishrei, 3761 after
  const hy = n + 3760;
  return hebYearStr(hy);
}
const HEB_ONES=['','×','×‘','×’','×“','×”','×•','×–','×—','×˜'];
const HEB_TENS=['','×™','×›','×œ','×','× ','×¡','×¢','×¤','×¦'];
const HEB_HUNDREDS=['','×§','×¨','×©','×ª','×ª×§','×ª×¨','×ª×©','×ª×ª','×ª×ª×§'];
function hebYearStr(n) {
  if (!n) return '';
  n = n % 1000; // last 3 digits in current millennium
  let s='';
  const h=Math.floor(n/100); n%=100;
  const t=Math.floor(n/10); n%=10;
  s+=HEB_HUNDREDS[h]||'';
  // skip 15=×˜×•, 16=×˜×–
  if(t===1&&n===5){s+='×˜×•';}
  else if(t===1&&n===6){s+='×˜×–';}
  else{s+=(HEB_TENS[t]||'')+(HEB_ONES[n]||'');}
  return '×ª×©'+s.slice(2)||s; // just return as is
}
function toHebYearLabel(val) {
  if (!val) return '';
  // If it looks like a 4-digit Gregorian year, convert
  if (/^\d{4}$/.test(val.toString().trim())) {
    const hy = parseInt(val) + 3760;
    return '×ª×©' + numberToHebLetters(hy % 1000);
  }
  return val; // already Hebrew
}
function numberToHebLetters(n) {
  if (n<=0) return '';
  const hundreds=['','×§','×¨','×©','×ª'];
  const rest=n%100;
  const h=Math.floor(n/100);
  let s=(h>0&&h<=4)?hundreds[h]:'';
  if(rest===15) s+='×˜×•';
  else if(rest===16) s+='×˜×–';
  else {
    const t=Math.floor(rest/10), o=rest%10;
    const tens=['','×™','×›','×œ','×','× ','×¡','×¢','×¤','×¦'];
    const ones=['','×','×‘','×’','×“','×”','×•','×–','×—','×˜'];
    s+=(tens[t]||'')+(ones[o]||'');
  }
  return s;
}
function fmt(d) { if(!d) return ''; const p=d.split('-'); return p[2]+'/'+p[1]+'/'+p[0]; }
function dateCell(d) { if(!d) return ''; return `<div class="date-cell"><span>${fmt(d)}</span><span class="date-heb">${toHeb(d)}</span></div>`; }
function today() { return new Date().toISOString().split('T')[0]; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getTotal(d) { return (d.donations||[]).reduce((s,x)=>s+parseFloat(x.amount||0),0); }
function getMax(d) { const a=(d.donations||[]).map(x=>parseFloat(x.amount||0)); return a.length?Math.max(...a):0; }
function dName(d) { return `${d.title?d.title+' ':''}${d.firstName||''} ${d.lastName||''}`.trim(); }
function activeCampaign() { return DB.campaigns.find(c=>c.active===true||c.active==='true'); }
function campName(id) { if(!id) return ''; const c=DB.campaigns.find(x=>x.id===id); return c?c.name:''; }
function methodBadge(m) {
  const map={'××–×•××Ÿ':'cash','××©×¨××™':'credit',"×¦'×§":'check','×”×¢×‘×¨×” ×‘× ×§××™×ª':'bank','××—×¨':'other'};
  return `<span class="badge b-${map[m]||'other'}">${m||''}</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const pg = document.getElementById('page'+name.charAt(0).toUpperCase()+name.slice(1));
  if(pg) pg.classList.add('active');
  const nb = document.getElementById('nav'+name.charAt(0).toUpperCase()+name.slice(1));
  if(nb) nb.classList.add('active');
  if(name==='dash') renderDash();
  if(name==='donors') renderAll();
  if(name==='campaign') renderCampaignPage();
  if(name==='future') { setTimeout(renderFuturePage,50); }
  if(name==='fundraisers') { renderFRPage(); }
  if(name==='donations') { renderDonationsPanel(); }
  if(name==='campaign') { setTimeout(startCampaignCountdown, 200); }
  if(name==='report') populateReportCampaigns();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDash() {
  const now = new Date();
  document.getElementById('dashGreet').textContent = `×©×œ×•×, ${currentUser.displayName}!`;
  document.getElementById('dashDate').textContent = now.toLocaleDateString('he-IL',{weekday:'long',year:'numeric',month:'long',day:'numeric'}) + ' | ' + toHeb(today());
  renderGlobalStats();

  // Active campaign mini
  const ac = activeCampaign();
  const box = document.getElementById('dashCampaignBox');
  if (ac) {
    const raised = DB.donors.reduce((s,d)=>{
      return s+(d.donations||[]).filter(dn=>dn.campaignId===ac.id).reduce((ss,dn)=>ss+parseFloat(dn.amount||0),0);
    },0);
    const goal = parseFloat(ac.goal)||0;
    const pct = goal>0?Math.min((raised/goal)*100,100):0;
    const over = raised>=goal&&goal>0;
    box.innerHTML = `<div class="card" style="margin-bottom:20px">
      <div class="card-header"><h3>ğŸ¯ ××’×‘×™×ª ×¤×¢×™×œ×”: ${ac.name}</h3><button class="btn btn-outline btn-sm" onclick="showPage('campaign')">×œ×¤×× ×œ ×”××’×‘×™×ª</button></div>
      <div class="card-body">${typeof countdownHtml !== 'undefined' ? countdownHtml : ''}
        <div class="stat-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:12px">
          <div class="stat-card ${over?'green':'red'}" style="padding:12px 16px">
            <div class="sv ${over?'green':'red'}" style="font-size:22px">${goal>0?'â‚ª'+goal.toLocaleString():'-'}</div><div class="sl">×™×¢×“</div>
          </div>
          <div class="stat-card gold" style="padding:12px 16px">
            <div class="sv gold" style="font-size:22px">â‚ª${raised.toLocaleString()}</div><div class="sl">× ×ª×¨× ×¢×“ ×›×”</div>
          </div>
          <div class="stat-card" style="padding:12px 16px">
            <div class="sv" style="font-size:22px;color:${over?'var(--success)':'var(--danger)'}">â‚ª${Math.abs(goal-raised).toLocaleString()}</div><div class="sl">${over?'×¢×‘×¨× ×• ××ª ×”×™×¢×“ ×‘':'× ×•×ª×¨ ×œ××™×¡×•×£'}</div>
          </div>
          <div class="stat-card" style="padding:12px 16px">
            <div class="sv" style="font-size:22px">${Math.round(pct)}%</div><div class="sl">×××—×•×– ×”×™×¢×“</div>
          </div>
        </div>
        <div class="progress-bar"><div class="progress-fill ${over?'over':''}" style="width:${pct}%"></div></div>
      </div>
    </div>`;
  } else { box.innerHTML = ''; }

  // Recent donations
  const allDons = [];
  DB.donors.forEach(d=>(d.donations||[]).forEach(dn=>allDons.push({...dn,donor:d})));
  allDons.sort((a,b)=>(b.date||'').localeCompare(a.date||''));
  const recent = allDons.slice(0,8);
  document.getElementById('recentDonations').innerHTML = recent.length===0
    ? '<tr><td colspan="6" style="text-align:center;padding:24px;color:var(--muted)">××™×Ÿ ×ª×¨×•××•×ª ×¨×©×•××•×ª</td></tr>'
    : recent.map(dn=>`<tr>
        <td><strong>${donorName(dn.donor)}</strong></td>
        <td style="font-size:12px;color:var(--muted)">${campName(dn.campaignId)||'-'}</td>
        <td style="font-size:12px;color:var(--muted)">${frNameById(dn.fundraiserId)||dn.groupId?grpNameById(dn.groupId||''):''||'-'}</td>
        <td><strong>â‚ª${parseFloat(dn.amount||0).toLocaleString()}</strong></td>
        <td>${dateCell(dn.date)}</td>
        <td>${methodBadge(dn.method)}</td>
      </tr>`).join('');
  startCampaignCountdown();
}

// â”€â”€ Live campaign countdown (ticks every second) â”€â”€
let _cdTimer = null;
function startCampaignCountdown() {
  if(_cdTimer) clearInterval(_cdTimer);
  const ac = activeCampaign();
  const el = document.getElementById('campCountdown');
  if(!el || !ac || !ac.deadline) return;
  
  function tick() {
    const deadline = new Date(ac.deadline + 'T' + (ac.deadlineTime||'23:59') + ':00');
    const now = new Date();
    const diff = deadline - now;
    if(diff <= 0) {
      el.innerHTML = '<div style="font-weight:700;color:var(--danger)">â° ×”××’×‘×™×ª ×”×¡×ª×™×™××”!</div>';
      clearInterval(_cdTimer); return;
    }
    const days  = Math.floor(diff / 86400000);
    const hrs   = Math.floor((diff % 86400000) / 3600000);
    const mins  = Math.floor((diff % 3600000) / 60000);
    const secs  = Math.floor((diff % 60000) / 1000);
    const urg   = days < 2 ? 'var(--danger)' : days < 7 ? 'var(--gold)' : 'var(--teal,#0891b2)';
    el.innerHTML = `<span style="font-size:22px">â³</span>
      <div>
        <div style="font-weight:700;color:var(--navy);font-size:12px">× ×•×ª×¨×• ×œ×¡×™×•× ×”××’×‘×™×ª</div>
        <div style="display:flex;gap:10px;align-items:baseline">
          <span style="font-size:24px;font-weight:900;color:${urg}">${days}</span><span style="font-size:11px;color:var(--muted)">×™××™×</span>
          <span style="font-size:20px;font-weight:300;color:var(--muted)">:</span>
          <span style="font-size:24px;font-weight:900;color:${urg}">${String(hrs).padStart(2,'0')}</span><span style="font-size:11px;color:var(--muted)">×©×¢×•×ª</span>
          <span style="font-size:20px;font-weight:300;color:var(--muted)">:</span>
          <span style="font-size:24px;font-weight:900;color:${urg}">${String(mins).padStart(2,'0')}</span><span style="font-size:11px;color:var(--muted)">×“×§×•×ª</span>
          <span style="font-size:20px;font-weight:300;color:var(--muted)">:</span>
          <span style="font-size:20px;font-weight:700;color:${urg}">${String(secs).padStart(2,'0')}</span><span style="font-size:10px;color:var(--muted)">×©× ×™×•×ª</span>
        </div>
      </div>`;
  }
  tick();
  _cdTimer = setInterval(tick, 1000);
}

function renderGlobalStats() {
  const allTotal = DB.donors.reduce((s,d)=>s+getTotal(d),0);
  const allDonCount = DB.donors.reduce((s,d)=>s+(d.donations||[]).length,0);
  const futureCount = DB.donors.reduce((s,d)=>s+(d.futureDonations||[]).length,0);
  document.getElementById('ds-count').textContent = DB.donors.length;
  document.getElementById('ds-total').textContent = 'â‚ª'+allTotal.toLocaleString();
  document.getElementById('ds-donations').textContent = allDonCount;
  document.getElementById('ds-future').textContent = futureCount;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DONORS TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll() { renderGlobalStats(); applyFilters(); }

function applyFilters() {
  const q=(document.getElementById('mainSearch')?.value||'').trim().toLowerCase();
  const fA=document.getElementById('fAffil')?.value||'';
  const fP=document.getElementById('fPref')?.value||'';
  const fM=parseFloat(document.getElementById('fMinDon')?.value||'0')||0;

  filteredRows = DB.donors.filter(d=>{
    const total=getTotal(d);
    const txt=[d.code,d.title,d.firstName,d.lastName,d.affil,d.address,d.phone,d.mobile,d.email,d.cohort,d.notes,d.prefTime].join(' ').toLowerCase();
    return (!q||txt.includes(q))&&(!fA||d.affil===fA)&&(!fP||d.prefTime===fP)&&(total>=fM);
  });

  filteredRows.sort((a,b)=>{
    let av,bv;
    if(sortCol==='name'){av=donorName(a);bv=donorName(b);}
    else if(sortCol==='total'){av=getTotal(a);bv=getTotal(b);}
    else if(sortCol==='maxDon'){av=getMax(a);bv=getMax(b);}
    else if(sortCol==='createdAt'){av=a.createdAt||'';bv=b.createdAt||'';}
    else{av=a[sortCol]||'';bv=b[sortCol]||'';}
    return av<bv?-sortDir:av>bv?sortDir:0;
  });

  const filtTotal=filteredRows.reduce((s,d)=>s+getTotal(d),0);
  const el=document.getElementById('tableCount'); if(el) el.textContent=filteredRows.length+' ×ª×•×¨××™×';
  const se=document.getElementById('tableSum'); if(se) se.textContent=filteredRows.length<DB.donors.length?'×¡×š: â‚ª'+filtTotal.toLocaleString():'';

  const body=document.getElementById('donorsBody'); if(!body) return;
  const ce=can('edit');
  body.innerHTML=filteredRows.map(d=>{
    const total=getTotal(d), maxD=getMax(d);
    const waBtn=d.mobile?`<button class="btn-icon wa" style="width:26px;height:26px;font-size:12px" onclick="openWAfor('${d.mobile}');event.stopPropagation()" title="WhatsApp">ğŸ’¬</button>`:'';
    const emBtn=d.email?`<button class="btn-icon em" style="width:26px;height:26px;font-size:12px" onclick="openMailfor('${d.email}');event.stopPropagation()" title="××™×™×œ">âœ‰ï¸</button>`:'';
    const cbHtml = can('admin') ? `<td style="width:36px;padding:4px;text-align:center" onclick="event.stopPropagation()"><input type="checkbox" class="donor-row-cb" data-id="${d.id}" onchange="updateBulkBar()" style="cursor:pointer;transform:scale(1.1)"></td>` : '<td></td>';
    return `<tr onclick="openDonorModal('${d.id}')">
      ${cbHtml}
      <td><strong>${d.code||''}</strong></td>
      <td>${donorName(d)}</td>
      <td><span class="badge" style="background:var(--cream-d);color:var(--muted)">${d.affil||''}</span></td>
      <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis">${d.address||''}${d.entrance?' '+d.entrance:''}</td>
      <td><div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap">${d.phone?`<span style="font-size:11px">${d.phone}</span>`:''} ${d.mobile?`<span style="font-size:11px">${d.mobile}</span>`:''} ${waBtn}</div></td>
      <td><div style="display:flex;gap:4px;align-items:center">${d.email?`<span style="font-size:11px;max-width:130px;overflow:hidden;text-overflow:ellipsis;display:block">${d.email}</span>`:''} ${emBtn}</div></td>
      <td>${d.prefTime||''}</td>
      <td><strong style="color:var(--success)">â‚ª${total.toLocaleString()}</strong></td>
      <td>â‚ª${maxD.toLocaleString()}</td>
      <td>${dateCell(d.createdAt?.split('T')[0]||'')}</td>
      <td onclick="event.stopPropagation()"><div class="row-actions">
        ${ce?`<button class="btn btn-outline btn-sm" onclick="openDonorModal('${d.id}')">âœï¸</button>`:''}
        ${ce?`<button class="btn btn-danger btn-sm" onclick="deleteDonorRow('${d.id}')">ğŸ—‘ï¸</button>`:''}
      </div></td>
    </tr>`;
  }).join('')||`<tr><td colspan="11" style="text-align:center;padding:32px;color:var(--muted)">××™×Ÿ ×ª×•×¨××™× ×œ×”×¦×’×”</td></tr>`;
}

function sortTable(col) {
  if(sortCol===col) sortDir*=-1; else{sortCol=col;sortDir=1;}
  document.querySelectorAll('th[data-col]').forEach(th=>{
    th.classList.toggle('sorted',th.dataset.col===col);
    th.querySelector('.si').textContent=th.dataset.col===col?(sortDir===1?'â†‘':'â†“'):'â‡…';
  });
  applyFilters();
}
function clearFilters() {
  ['mainSearch'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  ['fAffil','fPref','fMinDon'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  applyFilters();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DONOR MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openNewDonorModal() {
  // Reset pending buffers
  _pendingDonations = [];
  _pendingFuture = [];
  _pendingRelations = [];
  currentDonorId = '__new__';
  if(!can('edit')) return;
  currentDonorId=null; currentDTab='details';
  document.getElementById('donorModalTitle').textContent='×ª×•×¨× ×—×“×©';
  document.getElementById('deleteDonorBtn').style.display='none';
  document.getElementById('saveDonorBtnTop').style.display='';
  fillForm({});
  document.getElementById('f_code').value=genCode(); saveDB();
  document.getElementById('f_createdAt').value=today();
  switchDTab('details');
  openModal('donorModal'); setTimeout(initSelectsAddable, 100);
}

function openDonorModal(id) {
  const d=DB.donors.find(x=>x.id===id); if(!d) return;
  currentDonorId=id; currentDTab='details';
  document.getElementById('donorModalTitle').textContent=donorName(d);
  document.getElementById('deleteDonorBtn').style.display=can('edit')?'':'none';
  document.getElementById('saveDonorBtnTop').style.display=can('edit')?'':'none';
  fillForm(d);
  switchDTab('details');
  openModal('donorModal');
}

function fillForm(d) {
  ['code','title','firstName','lastName','closingName','affil','address','entrance','phone','mobile','email','prefTime','marriageYear','cohort','notes'].forEach(k=>{
    const e=document.getElementById('f_'+k); if(e) e.value=d[k]||'';
  });
  document.getElementById('f_createdAt').value=d.createdAt?d.createdAt.split('T')[0]:today();
  window._lastGeoLat = d.lat || null;
  window._lastGeoLng = d.lng || null;
  // Show map if coordinates exist
  const mapDiv = document.getElementById('addressMapPreview');
  if(mapDiv) {
    if(d.lat && d.lng) {
      mapDiv.innerHTML = `<iframe width="100%" height="120" frameborder="0" scrolling="no" src="https://www.openstreetmap.org/export/embed.html?bbox=${d.lng-.01},${d.lat-.01},${d.lng+.01},${d.lat+.01}&layer=mapnik&marker=${d.lat},${d.lng}" style="border-radius:8px"></iframe>`;
      mapDiv.style.display='';
    } else {
      mapDiv.style.display='none';
    }
  }
  const sugg = document.getElementById('addressSuggestions');
  if(sugg) sugg.style.display='none';
}

function switchDTab(tab) {
  currentDTab=tab;
  ['details','donations','future','relations'].forEach(t=>{
    document.getElementById('dc-'+t).style.display=t===tab?'':'none';
    document.getElementById('dt-'+t).classList.toggle('active',t===tab);
  });
  if(tab==='donations'&&currentDonorId) renderDonationsTab();
  if(tab==='future'&&currentDonorId) renderFutureTab();
  if(tab==='relations'&&currentDonorId) renderRelTab();
}

function saveDonor() {
  if(!can('edit')) return;
  const fn=document.getElementById('f_firstName').value.trim();
  const ln=document.getElementById('f_lastName').value.trim();
  if(!fn&&!ln){alert('×—×•×‘×” ×œ×”×–×™×Ÿ ×©×');return;}
  const data={};
  ['code','title','firstName','lastName','closingName','affil','address','entrance','phone','mobile','email','prefTime','marriageYear','cohort','notes'].forEach(k=>{
    const e=document.getElementById('f_'+k);if(e)data[k]=e.value.trim();
  });
  // Save geo data if available
  if(window._lastGeoLat) data.lat = window._lastGeoLat;
  if(window._lastGeoLng) data.lng = window._lastGeoLng;
  const ca=document.getElementById('f_createdAt').value;
  data.createdAt=ca?ca+'T00:00:00':new Date().toISOString();
  if(currentDonorId){
    const idx=DB.donors.findIndex(x=>x.id===currentDonorId);
    if(idx>=0) DB.donors[idx]={...DB.donors[idx],...data};
  } else {
    const nd={id:'D'+Date.now(),...data,donations:[],futureDonations:[],relations:[]};
    DB.donors.push(nd); currentDonorId=nd.id;
    document.getElementById('donorModalTitle').textContent=donorName(nd);
    document.getElementById('deleteDonorBtn').style.display='';
  }
  flushPendingToNewDonor(currentDonorId); saveDB(); renderAll(); renderGlobalStats();
  const btn=document.getElementById('saveDonorBtnTop');
  btn.textContent='âœ“ × ×©××¨'; btn.style.background='var(--success)'; btn.style.color='white';
  setTimeout(()=>{btn.textContent='×©××•×¨';btn.style.background='';btn.style.color='';},1500);
}

function saveDonorAndNew() {
  if(!can('edit')) return;
  const fn=document.getElementById('f_firstName').value.trim();
  const ln=document.getElementById('f_lastName').value.trim();
  if(!fn&&!ln){alert('×—×•×‘×” ×œ×”×–×™×Ÿ ×©×');return;}
  const data={};
  ['code','title','firstName','lastName','closingName','affil','address','entrance','phone','mobile','email','prefTime','marriageYear','cohort','notes'].forEach(k=>{
    const e=document.getElementById('f_'+k);if(e)data[k]=e.value.trim();
  });
  if(window._lastGeoLat) data.lat = window._lastGeoLat;
  if(window._lastGeoLng) data.lng = window._lastGeoLng;
  const ca=document.getElementById('f_createdAt').value;
  data.createdAt=ca?ca+'T00:00:00':new Date().toISOString();
  if(currentDonorId){
    const idx=DB.donors.findIndex(x=>x.id===currentDonorId);
    if(idx>=0) DB.donors[idx]={...DB.donors[idx],...data};
  } else {
    const nd={id:'D'+Date.now(),...data,donations:[],futureDonations:[],relations:[]};
    DB.donors.push(nd);
  }
  saveDB(); renderAll(); renderGlobalStats();
  // Reset for new donor
  currentDonorId = null;
  document.getElementById('donorModalTitle').textContent='×ª×•×¨× ×—×“×©';
  document.getElementById('deleteDonorBtn').style.display='none';
  fillForm({});
  document.getElementById('f_code').value=genCode(); saveDB();
  document.getElementById('f_createdAt').value=today();
  window._lastGeoLat=null; window._lastGeoLng=null;
  document.getElementById('addressMapPreview').style.display='none';
  switchDTab('details');
  setTimeout(()=>document.getElementById('f_firstName').focus(), 50);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADDRESS AUTOCOMPLETE (Google Maps / Nominatim fallback)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _addrTimer = null;
function addressAutocomplete(val) {
  clearTimeout(_addrTimer);
  const box = document.getElementById('addressSuggestions');
  if (!val || val.length < 3) { box.style.display='none'; return; }
  _addrTimer = setTimeout(async ()=>{
    try {
      const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&countrycodes=il&limit=6&addressdetails=1`,{headers:{'Accept-Language':'he'}});
      const data = await resp.json();
      if (!data.length) { box.innerHTML='<div style="padding:8px 12px;font-size:12px;color:var(--muted)">×œ× × ××¦××• ×›×ª×•×‘×•×ª</div>'; box.style.display=''; return; }
      box.innerHTML = data.map(r=>`<div class="pick-item" style="font-size:12px" onclick="selectAddress('${encodeURIComponent(r.display_name)}','${r.lat}','${r.lon}')">${r.display_name}</div>`).join('');
      box.style.display='';
    } catch(e){}
  }, 400);
}
function selectAddress(encName, lat, lng) {
  const name = decodeURIComponent(encName);
  document.getElementById('f_address').value = name;
  document.getElementById('addressSuggestions').style.display='none';
  window._lastGeoLat = parseFloat(lat);
  window._lastGeoLng = parseFloat(lng);
  // Show map preview using OpenStreetMap embed
  const mapDiv = document.getElementById('addressMapPreview');
  mapDiv.innerHTML = `<iframe width="100%" height="120" frameborder="0" scrolling="no" src="https://www.openstreetmap.org/export/embed.html?bbox=${parseFloat(lng)-.01},${parseFloat(lat)-.01},${parseFloat(lng)+.01},${parseFloat(lat)+.01}&layer=mapnik&marker=${lat},${lng}" style="border-radius:8px"></iframe>`;
  mapDiv.style.display='';
}
// Close suggestions when clicking outside
document.addEventListener('click', function(e){
  const box = document.getElementById('addressSuggestions');
  if(box && !box.contains(e.target) && e.target.id!=='f_address') box.style.display='none';
});

function deleteCurrentDonor() {
  if(!can('edit')||!confirm('×œ××—×•×§ ×ª×•×¨× ×–×” ×œ×¦××™×ª×•×ª?'))return;
  DB.donors=DB.donors.filter(x=>x.id!==currentDonorId);
  saveDB(); renderAll(); closeModal('donorModal');
}
function deleteDonorRow(id) {
  if(!can('edit')||!confirm('×œ××—×•×§ ×ª×•×¨× ×–×”?'))return;
  DB.donors=DB.donors.filter(x=>x.id!==id);
  saveDB(); renderAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DONATIONS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDonationsTab() {
  if(isNewDonor()) { renderPendingDonations(); return; }
  const d=DB.donors.find(x=>x.id===currentDonorId); if(!d) return;
  const total=getTotal(d), maxD=getMax(d), cnt=(d.donations||[]).length;
  document.getElementById('donorStatsBox').innerHTML=`
    <div class="d-stat"><div class="sv">â‚ª${total.toLocaleString()}</div><div class="sl">×¡×š ×ª×¨×•××•×ª</div></div>
    <div class="d-stat"><div class="sv" style="color:var(--gold)">â‚ª${maxD.toLocaleString()}</div><div class="sl">×ª×¨×•××” ×’×‘×•×”×”</div></div>
    <div class="d-stat"><div class="sv">${cnt}</div><div class="sl">××¡×¤×¨ ×ª×¨×•××•×ª</div></div>`;
  populateCampaignSelect('nd_campaign');
  const body=document.getElementById('donationsBody');
  const ce=can('edit');
  body.innerHTML=(d.donations||[]).length===0
    ?`<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--muted)">××™×Ÿ ×ª×¨×•××•×ª</td></tr>`
    :(d.donations||[]).map((dn,i)=>`<tr>
        <td>${fmt(dn.date)}</td>
        <td style="font-size:11px;color:var(--muted)">${toHeb(dn.date)}</td>
        <td><strong>â‚ª${parseFloat(dn.amount||0).toLocaleString()}</strong></td>
        <td>${methodBadge(dn.method)}</td>
        <td style="font-size:12px;color:var(--muted)">${campName(dn.campaignId)||''}</td>
        <td style="font-size:12px;color:var(--muted)">${frNameById(dn.fundraiserId)||''}</td>
        <td>${dn.notes||''}</td>
        <td style="white-space:nowrap">${ce?`<button class="btn btn-outline btn-sm" onclick="editDonation(${i})">âœï¸</button> <button class="btn btn-danger btn-sm" onclick="deleteDonation(${i})">ğŸ—‘ï¸</button>`:''}</td>
      </tr>`).join('');
}

function toggleDonForm() {
  const box=document.getElementById('donationFormBox');
  const open=box.style.display!=='none'&&box.style.display!=='';
  if(open){cancelDonForm();return;}
  document.getElementById('nd_editIdx').value='';
  document.getElementById('donFormTitle').textContent='×”×•×¡×¤×ª ×ª×¨×•××”';
  document.getElementById('nd_amount').value='';
  document.getElementById('nd_date').value=today();
  document.getElementById('nd_method').value='××–×•××Ÿ';
  document.getElementById('nd_notes').value='';
  if(document.getElementById('nd_fr_search')){document.getElementById('nd_fr_search').value='';document.getElementById('nd_fr_id').value='';document.getElementById('nd_fr_results').innerHTML='';}
  if(document.getElementById('nd_don_type')){document.getElementById('nd_don_type').value='fr';toggleDonAssignType();}
  if(document.getElementById('nd_grp_id')){document.getElementById('nd_grp_id').value='';document.getElementById('nd_grp_search').value='';document.getElementById('nd_grp_info').textContent='';}
  const ac=activeCampaign();
  populateCampaignSelect('nd_campaign');
  if(ac) document.getElementById('nd_campaign').value=ac.id;
  box.style.display='';
}
function cancelDonForm() {
  const box = document.getElementById('donationFormBox');
  if(box) { box.style.display='none'; box.style.opacity='0'; }
  const ei = document.getElementById('nd_editIdx');
  if(ei) ei.value='';
  // Reset form fields
  ['nd_amount','nd_date','nd_notes'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  // Reset attribution mode
  const frRad = document.querySelector('input[name="nd_mode"][value="fr"]');
  if(frRad) { frRad.checked=true; toggleDonMode('nd'); }
}

function editDonation(idx) {
  const d=DB.donors.find(x=>x.id===currentDonorId); if(!d) return;
  const dn=d.donations[idx]; if(!dn) return;
  document.getElementById('nd_editIdx').value=idx;
  document.getElementById('donFormTitle').textContent='×¢×¨×™×›×ª ×ª×¨×•××”';
  document.getElementById('nd_amount').value=dn.amount||'';
  document.getElementById('nd_date').value=dn.date||'';
  document.getElementById('nd_notes').value=dn.notes||'';
  populateCampaignSelect('nd_campaign');
  document.getElementById('nd_campaign').value=dn.campaignId||'';
  document.getElementById('nd_method').value=dn.method||'××–×•××Ÿ';
  // Restore assignment type
  if(document.getElementById('nd_don_type')) {
    if(dn.groupId) { document.getElementById('nd_don_type').value='group'; }
    else if(dn.fundraiserId) { document.getElementById('nd_don_type').value='fr'; }
    else { document.getElementById('nd_don_type').value='none'; }
    toggleDonAssignType();
  }
  if(document.getElementById('nd_fr_search')){
    const frn=frNameById(dn.fundraiserId||'');
    document.getElementById('nd_fr_search').value=frn;
    document.getElementById('nd_fr_id').value=dn.fundraiserId||'';
    document.getElementById('nd_fr_results').innerHTML='';
  }
  if(document.getElementById('nd_grp_id') && dn.groupId) {
    document.getElementById('nd_grp_id').value=dn.groupId;
    document.getElementById('nd_grp_search').value=grpNameById(dn.groupId);
  }
  document.getElementById('donationFormBox').style.display='';
}

function saveDonation() {
  const amount=parseFloat(document.getElementById('nd_amount').value);
  if(!amount||amount<=0){alert('×™×© ×œ×”×–×™×Ÿ ×¡×›×•× ×ª×§×™×Ÿ');return;}
  const attrib = getDonAttribution('nd');
  const obj={
    amount,
    date:document.getElementById('nd_date').value,
    method:document.getElementById('nd_method').value,
    campaignId:document.getElementById('nd_campaign').value||'',
    fundraiserId:attrib.fundraiserId,
    groupId:attrib.groupId,
    notes:document.getElementById('nd_notes').value.trim()
  };

  // If donor not yet saved â€” buffer it
  if(isNewDonor()) {
    const editIdx = document.getElementById('nd_editIdx').value;
    if(editIdx!=='') _pendingDonations[parseInt(editIdx)]=obj;
    else _pendingDonations.push(obj);
    cancelDonForm();
    renderPendingDonations();
    toast('âœ“ ×ª×¨×•××” × ×•×¡×¤×” â€” ×ª×™×©××¨ ×¢× ×©××™×¨×ª ×”×ª×•×¨×');
    return;
  }

  const d=DB.donors.find(x=>x.id===currentDonorId); if(!d) return;
  if(!d.donations) d.donations=[];
  const editIdx=document.getElementById('nd_editIdx').value;
  if(editIdx!=='') d.donations[parseInt(editIdx)]=obj;
  else d.donations.push(obj);
  cancelDonForm(); saveDB(); renderDonationsTab(); renderGlobalStats();
  toast('âœ“ ×ª×¨×•××” × ×©××¨×”');
  // Remove future-donation if confirming
  if(window._confirmFutureDonorId && window._confirmFutureIdx !== undefined) {
    const fd=DB.donors.find(x=>x.id===window._confirmFutureDonorId);
    if(fd && fd.futureDonations) {
      fd.futureDonations.splice(window._confirmFutureIdx,1);
      saveDB();
      renderFutureTab && renderFutureTab();
    }
    window._confirmFutureDonorId=null; window._confirmFutureIdx=undefined;
    const b=document.getElementById('futurConfirmBanner'); if(b) b.remove();
  }
  if(document.getElementById('pageDash').classList.contains('active')) renderDash();
}

function deleteDonation(idx) {
  const d=DB.donors.find(x=>x.id===currentDonorId); if(!d||!confirm('×œ××—×•×§ ×ª×¨×•××”?'))return;
  d.donations.splice(idx,1);
  saveDB(); renderDonationsTab(); renderGlobalStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUTURE DONATIONS TAB (multiple)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFutureTab() {
  if(isNewDonor()) { renderPendingFuture(); return; }
  const d=DB.donors.find(x=>x.id===currentDonorId); if(!d) return;
  const futs=d.futureDonations||[];
  populateCampaignSelect('nf_campaign');
  document.getElementById('futureItemsList').innerHTML=futs.length===0
    ?`<p style="color:var(--muted);font-size:13px">××™×Ÿ ×ª×¨×•××•×ª ×¢×ª×™×“×™×•×ª ×¨×©×•××•×ª</p>`
    :futs.map((f,i)=>`<div class="future-item">
        <div class="future-item-info">
          <div class="fi-date">${f.date?fmt(f.date):'×ª××¨×™×š ×œ× × ×§×‘×¢'}</div>
          ${f.date?`<div class="fi-heb">${toHeb(f.date)}</div>`:''}
          ${f.expectedAmount?`<div class="fi-amount">ğŸ’° ×¡×›×•× ×¦×¤×•×™: <strong>â‚ª${parseFloat(f.expectedAmount).toLocaleString()}</strong></div>`:''}
          ${campName(f.campaignId)?`<div class="fi-amount" style="font-size:12px;color:var(--muted)">ğŸ¯ ${campName(f.campaignId)}</div>`:''}
          ${f.notes?`<div class="fi-notes">ğŸ“ ${f.notes}</div>`:''}
        </div>
        ${can('edit')?`<div class="future-item-actions">
          <button class="btn btn-outline btn-sm" onclick="editFuture(${i})">âœï¸</button>
          <button class="btn btn-danger btn-sm" onclick="deleteFuture(${i})">ğŸ—‘ï¸</button>
        </div>`:''}
      </div>`).join('');
}

function toggleFutureForm() {
  const box=document.getElementById('futureFormBox');
  const open=box.style.display!=='none'&&box.style.display!=='';
  if(open){cancelFutureForm();return;}
  document.getElementById('nf_editIdx').value='';
  document.getElementById('futureFormTitle').textContent='×”×•×¡×¤×ª ×ª×¨×•××” ×¢×ª×™×“×™×ª';
  document.getElementById('nf_date').value='';
  document.getElementById('nf_amount').value='';
  document.getElementById('nf_notes').value='';
  const ac=activeCampaign();
  populateCampaignSelect('nf_campaign');
  if(ac) document.getElementById('nf_campaign').value=ac.id;
  box.style.display='';
}
function cancelFutureForm() { document.getElementById('futureFormBox').style.display='none'; document.getElementById('nf_editIdx').value=''; }

function editFuture(idx) {
  const d=DB.donors.find(x=>x.id===currentDonorId); if(!d) return;
  const f=(d.futureDonations||[])[idx]; if(!f) return;
  document.getElementById('nf_editIdx').value=idx;
  document.getElementById('futureFormTitle').textContent='×¢×¨×™×›×ª ×ª×¨×•××” ×¢×ª×™×“×™×ª';
  document.getElementById('nf_date').value=f.date||'';
  document.getElementById('nf_amount').value=f.expectedAmount||'';
  document.getElementById('nf_notes').value=f.notes||'';
  populateCampaignSelect('nf_campaign');
  document.getElementById('nf_campaign').value=f.campaignId||'';
  document.getElementById('futureFormBox').style.display='';
}

function saveFutureDonation() {
  const date=document.getElementById('nf_date').value;
  const notes=document.getElementById('nf_notes').value.trim();
  if(!date&&!notes){alert('×™×© ×œ×”×–×™×Ÿ ×œ×¤×—×•×ª ×ª××¨×™×š ×™×¢×“');return;}
  const obj={date,expectedAmount:document.getElementById('nf_amount').value?parseFloat(document.getElementById('nf_amount').value):null,campaignId:document.getElementById('nf_campaign').value||'',notes};
  const ei=document.getElementById('nf_editIdx').value;

  if (isNewDonor()) {
    if(ei!=='') _pendingFuture[parseInt(ei)]=obj;
    else _pendingFuture.push(obj);
    cancelFutureForm();
    renderPendingFuture();
    toast('âœ“ ×ª×¨×•××” ×¢×ª×™×“×™×ª × ×•×¡×¤×” ×œ×‘×•×¤×¨');
    return;
  }

  const d=DB.donors.find(x=>x.id===currentDonorId); if(!d) return;
  if(!d.futureDonations) d.futureDonations=[];
  if(ei!=='') d.futureDonations[parseInt(ei)]=obj;
  else d.futureDonations.push(obj);
  cancelFutureForm(); saveDB(); renderFutureTab(); renderGlobalStats();
  toast('âœ“ ×ª×¨×•××” ×¢×ª×™×“×™×ª × ×©××¨×”');
}

function deleteFuture(idx) {
  const d=DB.donors.find(x=>x.id===currentDonorId); if(!d||!confirm('×œ××—×•×§?'))return;
  d.futureDonations.splice(idx,1);
  saveDB(); renderFutureTab(); renderGlobalStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUTURE PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFSort(col) {
  const sd=document.getElementById('futureSortDir');
  const ss=document.getElementById('futureSort');
  if(ss.value===col) sd.value=sd.value==='asc'?'desc':'asc';
  else ss.value=col;
  renderFuturePage();
}

function renderFuturePage() {
  const q=(document.getElementById('futureSearch')?.value||'').trim().toLowerCase();
  const sortBy=document.getElementById('futureSort')?.value||'date';
  const dir=document.getElementById('futureSortDir')?.value||'asc';

  // Flatten: one row per future donation
  let rows=[];
  DB.donors.forEach(d=>{
    (d.futureDonations||[]).forEach((f,fi)=>{
      const name=donorName(d).toLowerCase();
      if(!q||name.includes(q)||(f.notes||'').toLowerCase().includes(q)||(d.code||'').toLowerCase().includes(q)){
        rows.push({donor:d, f, fi});
      }
    });
  });

  rows.sort((a,b)=>{
    let av,bv;
    if(sortBy==='name'){av=donorName(a.donor);bv=donorName(b.donor);}
    else if(sortBy==='amount'){av=parseFloat(a.f.expectedAmount||0);bv=parseFloat(b.f.expectedAmount||0);}
    else{av=a.f.date||'';bv=b.f.date||'';}
    return av<bv?(dir==='asc'?-1:1):av>bv?(dir==='asc'?1:-1):0;
  });

  const ce=document.getElementById('futureCount'); if(ce) ce.textContent=rows.length+' ×ª×¨×•××•×ª ×¢×ª×™×“×™×•×ª';

  const body=document.getElementById('futureBody'); if(!body) return;
  const canE=can('edit');
  body.innerHTML=rows.length===0
    ?`<tr><td colspan="9" style="text-align:center;padding:32px;color:var(--muted)">××™×Ÿ ×ª×¨×•××•×ª ×¢×ª×™×“×™×•×ª</td></tr>`
    :rows.map(({donor:d,f,fi})=>{
        const waBtn=d.mobile?`<button class="btn-icon wa" style="width:26px;height:26px;font-size:12px" onclick="openWAfor('${d.mobile}');event.stopPropagation()">ğŸ’¬</button>`:'';
        return `<tr style="cursor:pointer" onclick="openDonorAndFuture('${d.id}',${fi})">
          <td><strong>${donorName(d)}</strong></td>
          <td style="font-size:12px;color:var(--muted)">${d.code||''}</td>
          <td><span class="badge" style="background:var(--cream-d);color:var(--muted)">${d.affil||''}</span></td>
          <td>${f.date?`<strong>${fmt(f.date)}</strong>`:'<span style="color:var(--muted)">-</span>'}</td>
          <td style="font-size:11px;color:var(--muted)">${f.date?toHeb(f.date):''}</td>
          <td>${f.expectedAmount?`<strong style="color:var(--purple)">â‚ª${parseFloat(f.expectedAmount).toLocaleString()}</strong>`:'<span style="color:var(--muted)">×œ× ×¦×•×™×Ÿ</span>'}</td>
          <td style="max-width:200px;white-space:normal">${f.notes||''}</td>
          <td><div style="display:flex;gap:4px;align-items:center">${d.mobile?`<span style="font-size:11px">${d.mobile}</span>`:''} ${waBtn}</div></td>
          <td onclick="event.stopPropagation()">
            ${canE?`<div class="row-actions"><button class="btn btn-outline btn-sm" onclick="openDonorAndFuture('${d.id}',${fi})">âœï¸</button><button class="btn btn-gold btn-sm" onclick="confirmFutureDonation('${d.id}',${fi})" title="××™×©×•×¨ ×§×‘×œ×ª ×ª×¨×•××”">âœ… ××™×©×•×¨</button><button class="btn btn-danger btn-sm" onclick="deleteFutureFromPage('${d.id}',${fi})">ğŸ—‘ï¸</button></div>`:''}
          </td>
        </tr>`;
      }).join('');
}

function openDonorAndFuture(id, fi) {
  openDonorModal(id);
  setTimeout(()=>{ switchDTab('future'); setTimeout(()=>editFuture(fi),100); },100);
}

function deleteFutureFromPage(id, fi) {
  const d=DB.donors.find(x=>x.id===id); if(!d||!confirm('×œ××—×•×§ ×ª×¨×•××” ×¢×ª×™×“×™×ª?'))return;
  d.futureDonations.splice(fi,1);
  saveDB(); renderFuturePage(); renderGlobalStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RELATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRelTab() {
  const d=DB.donors.find(x=>x.id===currentDonorId); if(!d) return;
  const rels=d.relations||[];
  document.getElementById('relList').innerHTML=rels.length===0
    ?'<p style="color:var(--muted);font-size:13px">××™×Ÿ ×©×™×•×›×™×</p>'
    :rels.map((r,i)=>{
        const rel=DB.donors.find(x=>x.id===r.donorId); if(!rel) return '';
        return `<div style="display:flex;align-items:center;justify-content:space-between;background:var(--cream);border-radius:8px;padding:10px 13px;margin-bottom:7px">
          <div><strong>${donorName(rel)}</strong> <span class="badge" style="background:var(--cream-d);color:var(--muted);margin-right:8px">${r.type}</span><span style="font-size:11px;color:var(--muted)">${rel.code||''}</span></div>
          ${can('edit')?`<button class="btn btn-danger btn-sm" onclick="deleteRel(${i})">×”×¡×¨</button>`:''}
        </div>`;
      }).join('');
  document.getElementById('relSearchBox').style.display='none';
}
function showRelSearch() { document.getElementById('relSearchBox').style.display=''; document.getElementById('relSearch').value=''; document.getElementById('relResults').innerHTML=''; document.getElementById('relSelected').style.display='none'; rel_selectedId=null; }
function searchRelDonors() {
  const q=document.getElementById('relSearch').value.trim().toLowerCase();
  const res=q.length<1?[]:DB.donors.filter(d=>d.id!==currentDonorId&&(donorName(d).toLowerCase().includes(q)||(d.code||'').toLowerCase().includes(q))).slice(0,8);
  document.getElementById('relResults').innerHTML=res.map(d=>`<div style="padding:8px 10px;cursor:pointer;border-radius:7px;background:var(--white);margin-bottom:4px;border:1px solid var(--border)" onclick="pickRel('${d.id}')">${donorName(d)} <span style="color:var(--muted);font-size:11px">${d.code||''}</span></div>`).join('')||(q?'<p style="font-size:13px;color:var(--muted)">×œ× × ××¦××•</p>':'');
}
function pickRel(id) {
  rel_selectedId=id;
  const d=DB.donors.find(x=>x.id===id);
  document.getElementById('relResults').innerHTML=`<div style="padding:8px;background:var(--success-bg);border-radius:7px">âœ“ <strong>${donorName(d)}</strong></div>`;
  document.getElementById('relSelected').style.display='';
}
function cancelRel() { document.getElementById('relSearchBox').style.display='none'; rel_selectedId=null; }
function confirmRel() {
  if(!rel_selectedId) return;
  const d=DB.donors.find(x=>x.id===currentDonorId); if(!d.relations) d.relations=[];
  if(d.relations.find(r=>r.donorId===rel_selectedId)){alert('×©×™×•×š ×–×” ×›×‘×¨ ×§×™×™×');return;}
  d.relations.push({donorId:rel_selectedId,type:document.getElementById('relType').value});
  rel_selectedId=null; saveDB(); renderRelTab();
}
function deleteRel(idx) {
  const d=DB.donors.find(x=>x.id===currentDonorId); if(!d||!confirm('×œ×”×¡×™×¨?'))return;
  d.relations.splice(idx,1); saveDB(); renderRelTab();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUICK DONATION MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openQuickDonationModal() {
  if(!can('edit')) return;
  qd_selectedId=null;
  document.getElementById('qd_search').value='';
  document.getElementById('qd_results').innerHTML='';
  document.getElementById('qd_selected').style.display='none';
  document.getElementById('qd_amount').value='';
  document.getElementById('qd_date').value=today();
  document.getElementById('qd_method').value='××–×•××Ÿ';
  document.getElementById('qd_notes').value='';
  populateCampaignSelect('qd_campaign');
  const ac=activeCampaign(); if(ac) document.getElementById('qd_campaign').value=ac.id;
  openModal('quickDonModal'); setTimeout(initSelectsAddable, 100);
}


function openDonorById(id, tab) {
  const d = DB.donors.find(x=>x.id===id);
  if (!d) return;
  currentDonorId = id;
  fillDForm(d);
  if (tab) {
    currentDTab = tab;
    document.querySelectorAll('.modal-tab').forEach(el=>el.classList.remove('active'));
    document.querySelectorAll('#donorTabs .modal-tab').forEach(el=>{
      if(el.dataset.tab===tab) el.classList.add('active');
    });
  }
  openModal('donorModal');
  if(tab==='donations') setTimeout(renderDonationsTab,100);
}
function searchQDDonor() {
  const q=document.getElementById('qd_search').value.trim().toLowerCase();
  const res=q.length<1?[]:DB.donors.filter(d=>donorName(d).toLowerCase().includes(q)||(d.code||'').toLowerCase().includes(q)||(d.address||'').toLowerCase().includes(q)).slice(0,8);
  const notFoundBtn = q && res.length===0 ? `<div style="padding:8px 10px;cursor:pointer;border-radius:7px;background:var(--gold-bg);border:1px solid var(--gold);font-size:12px;color:var(--navy)" onclick="addDonorFromQD('${q.replace(/'/g,'\\\'')}')">â• ×œ× × ××¦× â€” ×”×•×¡×£ ×ª×•×¨× ×—×“×©</div>` : '';
  document.getElementById('qd_results').innerHTML=res.map(d=>`<div style="padding:8px 10px;cursor:pointer;border-radius:7px;background:var(--cream);margin-bottom:4px;border:1px solid var(--border)" onclick="pickQDDonor('${d.id}')">${donorName(d)} <span style="color:var(--muted);font-size:11px">${d.code||''} ${d.address?'| '+d.address:''}</span></div>`).join('') + notFoundBtn;
}
function addDonorFromQD(prefill) {
  window._qdResumeAfterDonor = true;
  window._qdPrefill = prefill;
  // Close QD modal first
  closeModal('quickDonModal');
  // Open donor modal for new donor
  setTimeout(() => {
    openNewDonorModal();
    // Pre-fill name from search text
    setTimeout(() => {
      if (prefill && document.getElementById('f_firstName')) {
        const parts = prefill.trim().split(' ');
        document.getElementById('f_firstName').value = parts[0]||'';
        if (parts.length > 1) document.getElementById('f_lastName').value = parts.slice(1).join(' ');
      }
      // Change the save button to "save and return to donation"
      const saveNewBtn = document.getElementById('saveNewDonorBtn');
      if (saveNewBtn) {
        saveNewBtn.textContent = 'ğŸ’¾ ×©××•×¨ ×•×—×–×•×¨ ×œ×ª×¨×•××” â†µ';
        saveNewBtn.onclick = saveDonorThenQD;
      }
      const saveBtn = document.getElementById('saveDonorBtnTop');
      if (saveBtn) {
        saveBtn.textContent = 'ğŸ’¾ ×©××•×¨ ×•×—×–×•×¨';
        saveBtn.onclick = saveDonorThenQD;
      }
      // Show a banner
      const banner = document.createElement('div');
      banner.id='qdResumeBanner';
      banner.style.cssText='background:var(--gold-bg,#fff9e6);border:1px solid var(--gold);color:var(--navy);font-size:12px;padding:8px 14px;border-radius:7px;margin-bottom:10px;text-align:center';
      banner.textContent='âœï¸ ××—×¨×™ ×”×©××™×¨×” ×ª×—×–×•×¨ ××•×˜×•××˜×™×ª ×œ×˜×•×¤×¡ ×”×ª×¨×•××”';
      const body = document.querySelector('#donorModal .modal-body');
      if (body && !document.getElementById('qdResumeBanner')) body.prepend(banner);
    }, 80);
  }, 50);
}
function saveDonorThenQD() {
  const fn = document.getElementById('f_firstName')?.value?.trim();
  const ln = document.getElementById('f_lastName')?.value?.trim();
  if (!fn && !ln) { alert('×™×© ×œ×”×–×™×Ÿ ×©×'); return; }
  saveDonor();
  setTimeout(() => {
    // Find the newly created donor (last one added)
    const newDonor = DB.donors[DB.donors.length-1];
    closeModal('donorModal');
    // Remove banner
    const b = document.getElementById('qdResumeBanner'); if(b) b.remove();
    // Reopen QD and pick the new donor
    setTimeout(() => {
      openModal('quickDonModal');
      setTimeout(() => {
        if (newDonor) {
          document.getElementById('qd_search').value = donorName(newDonor);
          pickQDDonor(newDonor.id);
        }
        window._qdResumeAfterDonor = false;
      }, 80);
    }, 50);
  }, 150);
}

function pickQDDonor(id) {
  qd_selectedId=id;
  const d=DB.donors.find(x=>x.id===id);
  document.getElementById('qd_results').innerHTML='';
  document.getElementById('qd_search').value=donorName(d);
  document.getElementById('qd_selected').style.display='';
  document.getElementById('qd_selected').innerHTML=`âœ“ <strong>${donorName(d)}</strong> <span style="color:var(--muted);font-size:11px">${d.code||''} | ${d.affil||''}</span>`;
}

function saveQuickDonation() {
  if(!qd_selectedId){alert('×™×© ×œ×‘×—×•×¨ ×ª×•×¨×');return;}
  const amount=parseFloat(document.getElementById('qd_amount').value);
  if(!amount||amount<=0){alert('×™×© ×œ×”×–×™×Ÿ ×¡×›×•× ×ª×§×™×Ÿ');return;}
  const d=DB.donors.find(x=>x.id===qd_selectedId); if(!d) return;
  if(!d.donations) d.donations=[];
  const qdAttrib = getDonAttribution('qd');
  d.donations.push({amount,date:document.getElementById('qd_date').value,method:document.getElementById('qd_method').value,campaignId:document.getElementById('qd_campaign').value||'',fundraiserId:qdAttrib.fundraiserId,groupId:qdAttrib.groupId,notes:document.getElementById('qd_notes').value.trim()});
  saveDB()(); renderGlobalStats(); closeModal('quickDonModal');
  if(document.getElementById('pageDash').classList.contains('active')) renderDash();
  alert(`×”×ª×¨×•××” ×©×œ â‚ª${amount.toLocaleString()} × ×©××¨×” ×¢×‘×•×¨ ${donorName(d)}`);
}

function saveQuickDonationAndNew() {
  if(!qd_selectedId){alert('×™×© ×œ×‘×—×•×¨ ×ª×•×¨×');return;}
  const amount=parseFloat(document.getElementById('qd_amount').value);
  if(!amount||amount<=0){alert('×™×© ×œ×”×–×™×Ÿ ×¡×›×•× ×ª×§×™×Ÿ');return;}
  const d=DB.donors.find(x=>x.id===qd_selectedId); if(!d) return;
  if(!d.donations) d.donations=[];
  const qdFrId=document.getElementById('qd_fr_id')?document.getElementById('qd_fr_id').value:'';
  d.donations.push({amount,date:document.getElementById('qd_date').value,method:document.getElementById('qd_method').value,campaignId:document.getElementById('qd_campaign').value||'',fundraiserId:qdFrId,notes:document.getElementById('qd_notes').value.trim()});
  saveDB(); renderGlobalStats();
  if(document.getElementById('pageDash').classList.contains('active')) renderDash();
  // Reset for new donation
  qd_selectedId=null;
  document.getElementById('qd_search').value='';
  document.getElementById('qd_results').innerHTML='';
  document.getElementById('qd_selected').style.display='none';
  document.getElementById('qd_amount').value='';
  document.getElementById('qd_notes').value='';
  if(document.getElementById('qd_fr_search')) { document.getElementById('qd_fr_search').value=''; document.getElementById('qd_fr_id').value=''; document.getElementById('qd_fr_results').innerHTML=''; }
  setTimeout(()=>document.getElementById('qd_search').focus(),50);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAMPAIGN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateCampaignSelect(elId) {
  const el=document.getElementById(elId); if(!el) return;
  const ac=activeCampaign();
  el.innerHTML=`<option value="">×œ×œ× ××’×‘×™×ª</option>`;
  DB.campaigns.forEach(c=>{
    el.innerHTML+=`<option value="${c.id}"${c.id===ac?.id?' style="font-weight:700"':''}>${c.name}${c.active?' â˜…':''}</option>`;
  });
}

function openNewCampaignModal() {
  document.getElementById('cm_editId').value='';
  document.getElementById('campModalTitle').textContent='××’×‘×™×ª ×—×“×©×”';
  document.getElementById('cm_name').value='';
  document.getElementById('cm_year').value='';
  document.getElementById('cm_goal').value='';
  document.getElementById('cm_deadline').value='';
  document.getElementById('cm_active').value='true';
  document.getElementById('cm_desc').value='';
  openModal('campaignModal');
}

function saveCampaign() {
  const name=document.getElementById('cm_name').value.trim();
  if(!name){alert('×™×© ×œ×”×–×™×Ÿ ×©×');return;}
  const isActive=document.getElementById('cm_active').value==='true';
  if(isActive) DB.campaigns.forEach(c=>c.active=false);
  const editId=document.getElementById('cm_editId').value;
  const obj={id:editId||'C'+Date.now(),name,year:document.getElementById('cm_year').value.trim(),goal:parseFloat(document.getElementById('cm_goal').value)||0,deadline:document.getElementById('cm_deadline').value,deadlineTime:document.getElementById('cm_deadline_time')?.value||'23:59',active:isActive,desc:document.getElementById('cm_desc').value.trim()};
  if(editId){const idx=DB.campaigns.findIndex(x=>x.id===editId);if(idx>=0)DB.campaigns[idx]=obj;}
  else DB.campaigns.push(obj);
  saveDB(); closeModal('campaignModal'); renderCampaignPage();
  populateReportCampaigns();
}


function frRaisedCamp(frId, campId) {
  let tot = 0;
  DB.donors.forEach(d => (d.donations||[]).forEach(dn => {
    if (dn.fundraiserId === frId && dn.campaignId === campId) tot += parseFloat(dn.amount||0);
  }));
  return tot;
}
function grpRaisedCamp(grp, campId) {
  return (grp.memberIds||[]).reduce((s,id) => s + frRaisedCamp(id, campId), 0);
}
function buildCampFRStats(campId) {
  const frStats = (DB.fundraisers||[]).map(f => ({f, r: frRaisedTotal(f.id, campId)})).sort((a,b)=>b.r-a.r).slice(0,10);
  const grpStats = (DB.groups||[]).map(g => ({g, r: grpRaisedCamp(g, campId)})).sort((a,b)=>b.r-a.r).slice(0,10);
  const vaadMap = {};
  (DB.fundraisers||[]).forEach(f => { const v = f.vaad||'?'; if(!vaadMap[v]) vaadMap[v]=0; vaadMap[v] += frRaisedCamp(f.id, campId); });
  const vaadTop = Object.entries(vaadMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
  return `<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:16px">
    <div>
      <h4 style="font-size:13px;font-weight:700;margin-bottom:8px">ğŸ† 10 ×”××ª×¨×™××™× ×”××•×‘×™×œ×™×</h4>
      <table class="t10"><thead><tr><th>#</th><th>×©×</th><th>×•×•×¢×“</th><th>×’×™×™×¡</th></tr></thead><tbody>
      ${frStats.map((x,i)=>`<tr><td class="rank">${i+1}</td><td>${(x.f.firstName||'')+' '+(x.f.lastName||'')}</td><td>${x.f.vaad||''}</td><td><strong style="color:var(--success)">â‚ª${x.r.toLocaleString()}</strong></td></tr>`).join('')||'<tr><td colspan="4" style="text-align:center;padding:10px;color:var(--muted)">××™×Ÿ × ×ª×•× ×™×</td></tr>'}
      </tbody></table>
    </div>
    <div>
      <h4 style="font-size:13px;font-weight:700;margin-bottom:8px">ğŸ‘¥ 10 ×”×§×‘×•×¦×•×ª ×”××•×‘×™×œ×•×ª</h4>
      <table class="t10"><thead><tr><th>#</th><th>×§×‘×•×¦×”</th><th>×§×•×“</th><th>×’×™×™×¡×”</th></tr></thead><tbody>
      ${grpStats.map((x,i)=>`<tr><td class="rank">${i+1}</td><td>${x.g.name}</td><td>${x.g.code||''}</td><td><strong style="color:var(--success)">â‚ª${x.r.toLocaleString()}</strong></td></tr>`).join('')||'<tr><td colspan="4" style="text-align:center;padding:10px;color:var(--muted)">××™×Ÿ ×§×‘×•×¦×•×ª</td></tr>'}
      </tbody></table>
    </div>
  </div>
  <div style="margin-top:14px">
    <h4 style="font-size:13px;font-weight:700;margin-bottom:8px">ğŸ“ ×’×™×•×¡ ×œ×¤×™ ×•×•×¢×“</h4>
    <table class="t10" style="width:auto"><thead><tr><th>×•×•×¢×“</th><th>×’×™×™×¡</th><th>××ª×¨×™××™×</th></tr></thead><tbody>
    ${vaadTop.map(([v,r])=>{
      const cnt = (DB.fundraisers||[]).filter(f=>f.vaad===v).length;
      return `<tr><td><strong>${v}</strong></td><td><strong style="color:var(--success)">â‚ª${r.toLocaleString()}</strong></td><td>${cnt}</td></tr>`;
    }).join('')||'<tr><td colspan="3" style="padding:10px;color:var(--muted)">××™×Ÿ × ×ª×•× ×™×</td></tr>'}
    </tbody></table>
  </div>`;
}

function renderCampaignPage() {
  if(!DB.campaigns.length){
    document.getElementById('campaignContent').innerHTML=`<div style="text-align:center;padding:60px;color:var(--muted)"><div style="font-size:48px;margin-bottom:12px">ğŸ¯</div><h3>××™×Ÿ ××’×‘×™×•×ª ×¢×“×™×™×Ÿ</h3><p>×œ×—×¥ ×¢×œ "××’×‘×™×ª ×—×“×©×”" ×œ×”×•×¡×¤×”</p></div>`;
    return;
  }
  const ac=activeCampaign();
  let html='';
  // Active campaign panel
  if(ac) {
    const raised=DB.donors.reduce((s,d)=>s+(d.donations||[]).filter(dn=>dn.campaignId===ac.id).reduce((ss,dn)=>ss+parseFloat(dn.amount||0),0),0);
    const donorsWho=DB.donors.filter(d=>(d.donations||[]).some(dn=>dn.campaignId===ac.id));
    const donCount=DB.donors.reduce((s,d)=>s+(d.donations||[]).filter(dn=>dn.campaignId===ac.id).length,0);
    const goal=parseFloat(ac.goal)||0;
    const pct=goal>0?Math.min((raised/goal)*100,100):0;
    const over=raised>=goal&&goal>0;
    const remaining=over?0:goal-raised;
    // Build countdown string
    let countdownHtml = '';
    if(ac.deadline) {
      const deadlineStr = ac.deadline + 'T' + (ac.deadlineTime||'23:59') + ':00';
      const dl = new Date(deadlineStr);
      const now = new Date();
      const diff = dl - now;
      if(diff > 0) {
        const days = Math.floor(diff / 86400000);
        const hrs = Math.floor((diff % 86400000) / 3600000);
        const mins = Math.floor((diff % 3600000) / 60000);
        countdownHtml = `<div id="campCountdown" style="display:flex;align-items:center;gap:10px;background:rgba(201,168,76,.15);border:1px solid var(--gold);border-radius:10px;padding:10px 16px;margin-bottom:14px;font-size:13px">
          <span style="font-size:22px">â³</span>
          <div>
            <div style="font-weight:700;color:var(--navy)">× ×•×ª×¨×• ×œ×¡×™×•× ×”××’×‘×™×ª</div>
            <div style="font-size:20px;font-weight:900;color:var(--gold)">${days} ×™××™×, ${hrs} ×©×¢×•×ª, ${mins} ×“×§×•×ª</div>
            <div style="font-size:11px;color:var(--muted)">×™×¢×“: ${new Date(deadlineStr).toLocaleDateString('he-IL',{day:'numeric',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
          </div>
        </div>`;
        // Start live update
        if(window._countdownTimer) clearInterval(window._countdownTimer);
        window._countdownTimer = setInterval(() => {
          const el=document.getElementById('campCountdown');
          if(!el){clearInterval(window._countdownTimer);return;}
          const d2=new Date(deadlineStr)-new Date();
          if(d2<=0){el.innerHTML='<span style="color:red;font-weight:700">â›” ×”××’×‘×™×ª ×”×¡×ª×™×™××”</span>';clearInterval(window._countdownTimer);return;}
          const dd=Math.floor(d2/86400000), hh=Math.floor((d2%86400000)/3600000), mm=Math.floor((d2%3600000)/60000);
          el.querySelector('div > div:nth-child(2)').textContent=dd+' ×™××™×, '+hh+' ×©×¢×•×ª, '+mm+' ×“×§×•×ª';
        }, 30000);
      } else {
        countdownHtml = '<div style="background:#fee2e2;border:1px solid #fca5a5;border-radius:8px;padding:10px;margin-bottom:12px;font-size:13px;color:#991b1b;font-weight:700">â›” ×”××’×‘×™×ª ×”×¡×ª×™×™××” ×‘-'+dl.toLocaleDateString("he-IL")+'</div>';
      }
    }
    html+=`<div class="card" style="border:2px solid var(--gold)">
      <div class="card-header" style="background:linear-gradient(135deg,var(--navy),#2a3f6b)">
        <h3>ğŸ¯ ${ac.name} ${ac.year?'â€” '+ac.year:''} <span style="background:var(--gold);color:var(--navy);font-size:11px;padding:2px 8px;border-radius:10px;font-weight:700;margin-right:8px">×¤×¢×™×œ×”</span></h3>
        ${can('admin')?`<div style="display:flex;gap:6px"><button class="btn btn-outline btn-sm" onclick="editCampaign('${ac.id}')">âœï¸ ×¢×¨×™×›×”</button></div>`:''}
      </div>
      <div class="card-body">
        <div class="camp-goal ${over?'over':'under'}">â‚ª${goal>0?goal.toLocaleString():'?'}</div>
        <div style="text-align:center;font-size:13px;color:var(--muted);margin-bottom:12px">×™×¢×“ ×”××’×‘×™×ª</div>
        <div class="progress-bar" style="height:20px;border-radius:12px"><div class="progress-fill ${over?'over':''}" style="width:${pct}%;border-radius:12px;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:11px;font-weight:700;color:white;min-width:${pct>10?'auto':'0'};transition:width 1s ease">${pct>=15?Math.round(pct)+'%':''}</div></div>
        <div style="display:flex;justify-content:space-between;font-size:12px;margin-top:4px">
          <span style="color:var(--success)">â‚ª${raised.toLocaleString()} × ×ª×¨×</span>
          <span style="font-weight:700;color:${over?'var(--success)':'var(--navy)'}">${Math.round(pct)}% ××”×™×¢×“</span>
          <span style="color:${over?'var(--success)':'var(--danger)'}">â‚ª${over?(raised-goal).toLocaleString():remaining.toLocaleString()} ${over?'××¢×œ ×™×¢×“':'× ×•×ª×¨'}</span>
        </div>
        <div class="stat-grid" style="grid-template-columns:repeat(4,1fr)">
          <div class="stat-card green" style="padding:14px"><div class="sv green" style="font-size:22px">â‚ª${raised.toLocaleString()}</div><div class="sl">× ×ª×¨× ×¢×“ ×›×”</div></div>
          <div class="stat-card ${over?'green':'red'}" style="padding:14px"><div class="sv ${over?'green':'red'}" style="font-size:22px">â‚ª${over?(raised-goal).toLocaleString():remaining.toLocaleString()}</div><div class="sl">${over?'××¢×‘×¨ ×œ×™×¢×“':'× ×•×ª×¨ ×œ××™×¡×•×£'}</div></div>
          <div class="stat-card" style="padding:14px"><div class="sv" style="font-size:22px">${donCount}</div><div class="sl">××¡×¤×¨ ×ª×¨×•××•×ª</div></div>
          <div class="stat-card" style="padding:14px"><div class="sv" style="font-size:22px">${donorsWho.length}</div><div class="sl">×ª×•×¨××™× ×©×ª×¨××•</div></div>
        </div>
        ${ac.deadline?`<div style="margin-top:12px;font-size:13px;color:var(--muted)">ğŸ“… ×ª××¨×™×š ×™×¢×“: <strong>${fmt(ac.deadline)}</strong> â€” ${toHeb(ac.deadline)}</div>`:''}
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:14px">
          <div style="background:var(--teal-bg);border-radius:9px;padding:12px;text-align:center"><div style="font-size:22px;font-weight:700;font-family:'Frank Ruhl Libre',serif;color:var(--teal)">${DB.fundraisers.length}</div><div style="font-size:11px;color:var(--muted)">××ª×¨×™××™×</div></div>
          <div style="background:#fff3e0;border-radius:9px;padding:12px;text-align:center"><div style="font-size:22px;font-weight:700;font-family:'Frank Ruhl Libre',serif;color:var(--warn)">${DB.groups.length}</div><div style="font-size:11px;color:var(--muted)">×§×‘×•×¦×•×ª</div></div>
        </div>
        ${buildCampFRStats(ac.id)}
      </div>
    </div>`;
  }

  // All campaigns list
  html+=`<div class="card"><div class="card-header"><h3>×›×œ ×”××’×‘×™×•×ª</h3></div><div class="card-body" style="padding:0">
    <table><thead><tr><th>×©×</th><th>×©× ×”</th><th>×™×¢×“</th><th>× ×ª×¨×</th><th>×ª××¨×™×š ×™×¢×“</th><th>×¡×˜×˜×•×¡</th><th></th></tr></thead><tbody>
    ${DB.campaigns.map(c=>{
      const raised=DB.donors.reduce((s,d)=>s+(d.donations||[]).filter(dn=>dn.campaignId===c.id).reduce((ss,dn)=>ss+parseFloat(dn.amount||0),0),0);
      return `<tr>
        <td><strong>${c.name}</strong></td>
        <td>${c.year||''}</td>
        <td>â‚ª${(parseFloat(c.goal)||0).toLocaleString()}</td>
        <td><strong style="color:var(--success)">â‚ª${raised.toLocaleString()}</strong></td>
        <td>${fmt(c.deadline)}</td>
        <td><span class="badge ${c.active?'b-cash':'b-other'}">${c.active?'×¤×¢×™×œ×”':'×œ× ×¤×¢×™×œ×”'}</span></td>
        <td>${can('admin')?`<div class="row-actions"><button class="btn btn-outline btn-sm" onclick="editCampaign('${c.id}')">âœï¸</button><button class="btn btn-danger btn-sm" onclick="deleteCampaign('${c.id}')">ğŸ—‘ï¸</button></div>`:''}</td>
      </tr>`;
    }).join('')}
    </tbody></table></div></div>`;

  document.getElementById('campaignContent').innerHTML=html;
}

function editCampaign(id) {
  const c=DB.campaigns.find(x=>x.id===id); if(!c) return;
  document.getElementById('cm_editId').value=id;
  document.getElementById('campModalTitle').textContent='×¢×¨×™×›×ª ××’×‘×™×ª';
  document.getElementById('cm_name').value=c.name||'';
  document.getElementById('cm_year').value=c.year||'';
  document.getElementById('cm_goal').value=c.goal||'';
  document.getElementById('cm_deadline').value=c.deadline||'';
  document.getElementById('cm_active').value=c.active?'true':'false';
  document.getElementById('cm_desc').value=c.desc||'';
  openModal('campaignModal');
}

function deleteCampaign(id) {
  if(!confirm('×œ××—×•×§ ××’×‘×™×ª ×–×•?')) return;
  DB.campaigns=DB.campaigns.filter(x=>x.id!==id);
  saveDB(); renderCampaignPage();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WA / MAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openWA(){const m=document.getElementById('f_mobile')?.value;if(m)openWAfor(m);}
function openMail(){const e=document.getElementById('f_email')?.value;if(e)openMailfor(e);}
function openWAfor(m){const n=m.replace(/\D/g,'');window.open('https://wa.me/'+(n.startsWith('0')?'972'+n.slice(1):n),'_blank');}
function openMailfor(e){window.open('mailto:'+e,'_blank');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USERS MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openUsersModal(){renderUsersTable();openModal('usersModal');}
function renderUsersTable(){
  const roles=[{v:'admin',l:'×¨×©× (××œ×)'},{v:'editor',l:'×¢×•×¨×š'},{v:'viewer',l:'××‘×§×¨'}];
  document.getElementById('usersBody').innerHTML=DB.users.map((u,i)=>`<tr>
    <td><input class="form-control" value="${u.username}" oninput="DB.users[${i}].username=this.value" style="width:120px"></td>
    <td><input class="form-control" value="${u.displayName}" oninput="DB.users[${i}].displayName=this.value" style="width:120px"></td>
    <td><input class="form-control" type="password" value="${u.password}" oninput="DB.users[${i}].password=this.value" style="width:110px"></td>
    <td><select class="form-control" onchange="DB.users[${i}].role=this.value" style="width:130px">
      ${roles.map(r=>`<option value="${r.v}"${u.role===r.v?' selected':''}>${r.l}</option>`).join('')}
    </select></td>
    <td><button class="btn btn-danger btn-sm" onclick="removeUser(${i})">×”×¡×¨</button></td>
  </tr>`).join('');
}
function addUserRow(){DB.users.push({username:'user'+Date.now(),displayName:'××©×ª××© ×—×“×©',password:'pass123',role:'viewer'});renderUsersTable();}
function removeUser(i){if(DB.users[i].username===currentUser.username){alert('×œ× × ×™×ª×Ÿ ×œ××—×•×§ ××ª ×”××©×ª××© ×”× ×•×›×—×™');return;}DB.users.splice(i,1);renderUsersTable();}
function saveUsers(){saveDB();closeModal('usersModal');alert('×”××©×ª××©×™× × ×©××¨×•');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS MODAL â€” fix save + dynamic dropdowns
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_SETTINGS = {
  titles: ['','×”×¨×‘','×“"×¨',"×¤×¨×•×¤'",'××¨',"×’×‘'",'×”×¨×‘× ×™×ª','×”××“××•"×¨'],
  affiliations: ['×ª×œ××™×“','×‘×•×’×¨','×”×•×¨×” ×ª×œ××™×“','×”×•×¨×” ×‘×•×’×¨','××›×¨','×¢×¡×§×™','××—×¨'],
  closingNames: ['×‘×‘×¨×›×”','×‘×›×‘×•×“ ×¨×‘','×‘×”×•×§×¨×”','×‘×™×“×™×“×•×ª','×‘×ª×•×“×”','×™×™×©×¨ ×›×—'],
  prefTimes: ['×˜×œ×¤×•× ×™ ×œ×¤× ×™ ×¤×•×¨×™×','×¤×•×¨×™× ×‘×‘×™×ª','×˜×œ×¤×•× ×™ ×‘×¤×•×¨×™×'],
  payMethods: ['××–×•××Ÿ','××©×¨××™',"×¦'×§",'×”×¢×‘×¨×” ×‘× ×§××™×ª','××—×¨'],
  relTypes: ['×”×•×¨×”','×¡×‘×','×‘×Ÿ','×©×•×•×¢×¨','××—','×§×¨×•×‘'],
};



function addToListAndRefresh(settingsKey, elId) {
  const val = prompt('×”×•×¡×£ ×¢×¨×š ×—×“×©:');
  if (!val || !val.trim()) return;
  const S = getSettings();
  const keyMap = {
    titles:'titles', affiliations:'affiliations', closings:'closingNames',
    prefTimes:'prefTimes', methods:'payMethods', relTypes:'relTypes', vaads:'vaads',
    payMethods:'payMethods', closingNames:'closingNames'
  };
  const sk = keyMap[settingsKey] || settingsKey;
  if (!S[sk]) S[sk] = [];
  S[sk].push(val.trim());
  DB.settings = S;
  saveDB();
  // Re-populate the specific select
  const el = document.getElementById(elId);
  if (el) {
    const opt = document.createElement('option');
    opt.value = val.trim();
    opt.textContent = val.trim();
    // Insert before last option (the + add option if any)
    el.insertBefore(opt, el.lastChild);
    el.value = val.trim();
  }
}
function HL(key) {
  const S = getSettings();
  // Map new keys to old settings keys
  const keyMap = {
    titles: 'titles', affiliations: 'affiliations', closings: 'closingNames',
    prefTimes: 'prefTimes', methods: 'payMethods', relTypes: 'relTypes', vaads: 'vaads'
  };
  const sk = keyMap[key] || key;
  return S[sk] || [];
}
function getSettings() {
  if (!DB.settings) DB.settings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));
  return DB.settings;
}

function openSettingsModal(){
  const S = getSettings();
  const lists = [
    {key:'titles', label:'×ª××¨×™×', vals: S.titles},
    {key:'affiliations', label:'×”×ª×××•×ª', vals: S.affiliations},
    {key:'closingNames', label:'×©××•×ª ×¡×’×™×¨×”', vals: S.closingNames},
    {key:'prefTimes', label:'××•×¢×“×™ ×ª×¨××”', vals: S.prefTimes},
    {key:'payMethods', label:'××•×¤×Ÿ ×ª×¨×•××”', vals: S.payMethods},
    {key:'relTypes', label:'×¡×™×‘×•×ª ×©×™×•×š', vals: S.relTypes},
  ];
  document.getElementById('settingsBody').innerHTML=lists.map((lst,li)=>`
    <div style="margin-bottom:18px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>${lst.label}</strong>
        <button class="btn btn-outline btn-sm" onclick="addSetting(${li})">+ ×”×•×¡×£</button>
      </div>
      <div id="slist_${li}">
        ${lst.vals.map(v=>`<div class="setting-item" data-key="${lst.key}"><input class="form-control" value="${v}" style="flex:1"><button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">âœ•</button></div>`).join('')}
      </div>
    </div>`).join('');
  openModal('settingsModal');
}

function addSetting(li){
  const d=document.createElement('div');
  d.className='setting-item';
  const keys = ['titles','affiliations','closingNames','prefTimes','payMethods','relTypes'];
  d.dataset.key = keys[li]||'';
  d.innerHTML=`<input class="form-control" style="flex:1" placeholder="×¢×¨×š ×—×“×©..."><button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">âœ•</button>`;
  document.getElementById('slist_'+li).appendChild(d);
  d.querySelector('input').focus();
}

function saveSettings() {
  const S = getSettings();
  const keys = ['titles','affiliations','closingNames','prefTimes','payMethods','relTypes'];
  keys.forEach((key,li) => {
    const items = document.querySelectorAll(`#slist_${li} .setting-item input`);
    S[key] = Array.from(items).map(i=>i.value.trim()).filter(Boolean);
  });
  DB.settings = S;
  saveDB();
  // Refresh dropdowns
  refreshSelectsFromSettings();
  closeModal('settingsModal');
  alert('×”× ×ª×•× ×™× ×”×§×©×™×—×™× × ×©××¨×•');
}

function refreshSelectsFromSettings() {
  const S = getSettings();
  // Title
  const updateSelect = (id, vals, emptyLabel) => {
    const el = document.getElementById(id); if(!el) return;
    const cur = el.value;
    el.innerHTML = (emptyLabel ? `<option value="">${emptyLabel}</option>` : '') + vals.map(v=>`<option value="${v}">${v}</option>`).join('');
    if(vals.includes(cur)) el.value = cur;
  };
  updateSelect('f_title', S.titles, '×œ×œ×');
  updateSelect('f_affil', S.affiliations, '-');
  updateSelect('f_closingName', S.closingNames, '-');
  updateSelect('f_prefTime', S.prefTimes, '×œ× × ×§×‘×¢');
  updateSelect('nd_method', S.payMethods, '');
  updateSelect('qd_method', S.payMethods, '');
  updateSelect('relType', S.relTypes, '');
}

function populateSelectFromSettings(id, key, emptyLabel) {
  const S = getSettings();
  const el = document.getElementById(id); if(!el) return;
  const vals = S[key] || DEFAULT_SETTINGS[key] || [];
  el.innerHTML = (emptyLabel !== undefined ? `<option value="">${emptyLabel}</option>` : '') + vals.map(v=>`<option value="${v}">${v}</option>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPORT / EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openImportModal(){openModal('importModal');document.getElementById('importStatus').innerHTML='';}
function importExcel(input){
  if(!can('import')){alert('××™×Ÿ ×”×¨×©××”');return;}
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    let added=0;
    rows.forEach(row=>{
      const code=String(row['×§×•×“ ×ª×•×¨×']||genCode());
      if(DB.donors.find(d=>d.code===code))return;
      DB.donors.push({id:'D'+Date.now()+Math.random(),code,title:row['×ª×•××¨']||'',firstName:row['×©× ×¤×¨×˜×™']||'',lastName:row['×©× ××©×¤×—×”']||'',closingName:row['×©× ×¡×’×™×¨×”']||'',affil:row['×©×™×•×š']||'',address:row['×›×ª×•×‘×ª']||'',entrance:row['×›× ×™×¡×” ×§×•××”']||'',phone:row['×˜×œ×¤×•×Ÿ']||'',mobile:row['×¡×œ×•×œ×¨×™']||'',email:row['××™×™×œ']||'',marriageYear:row['×©× ×ª × ×™×©×•××™×Ÿ']||'',cohort:row['××—×–×•×¨']||'',prefTime:row['××•×¢×“ ×ª×¨××”']||'',notes:row['×”×¢×¨×•×ª']||'',createdAt:new Date().toISOString(),donations:[],futureDonations:[],relations:[]});
      added++;
    });
    saveDB();renderAll();
    document.getElementById('importStatus').innerHTML=`<div style="color:var(--success)">âœ“ ×™×•×‘××• ${added} ×ª×•×¨××™×</div>`;
    input.value='';
  };
  reader.readAsArrayBuffer(file);
}

function exportTable(){
  if(!can('export')){alert('××™×Ÿ ×”×¨×©××ª ×™×™×¦×•×');return;}
  const rows=filteredRows.map(d=>({'×§×•×“ ×ª×•×¨×':d.code,'×ª×•××¨':d.title,'×©× ×¤×¨×˜×™':d.firstName,'×©× ××©×¤×—×”':d.lastName,'×©×™×•×š':d.affil,'×›×ª×•×‘×ª':d.address,'×˜×œ×¤×•×Ÿ':d.phone,'×¡×œ×•×œ×¨×™':d.mobile,'××™×™×œ':d.email,'××•×¢×“ ×ª×¨××”':d.prefTime,'×”×¢×¨×•×ª':d.notes,'×¡×š ×ª×¨×•××•×ª':getTotal(d),'×ª×¨×•××” ×’×‘×•×”×”':getMax(d)}));
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(rows),'×ª×•×¨××™×');
  XLSX.writeFile(wb,`×ª×•×¨××™×_${today()}.xlsx`);
}

function exportExcel(){
  if(!can('export')){alert('××™×Ÿ ×”×¨×©××ª ×™×™×¦×•×');return;}
  const wb=XLSX.utils.book_new();
  const donorRows=DB.donors.map(d=>({'×§×•×“':d.code,'×ª×•××¨':d.title,'×©× ×¤×¨×˜×™':d.firstName,'×©× ××©×¤×—×”':d.lastName,'×©×™×•×š':d.affil,'×›×ª×•×‘×ª':d.address,'×˜×œ×¤×•×Ÿ':d.phone,'×¡×œ×•×œ×¨×™':d.mobile,'××™×™×œ':d.email,'××•×¢×“ ×ª×¨××”':d.prefTime,'×”×¢×¨×•×ª':d.notes,'×¡×š ×ª×¨×•××•×ª':getTotal(d),'×ª×¨×•××” ×’×‘×•×”×”':getMax(d),'×ª××¨×™×š ×™×¦×™×¨×”':fmt(d.createdAt?.split('T')[0]||'')}));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(donorRows),'×ª×•×¨××™×');
  const donRows=[];
  DB.donors.forEach(d=>(d.donations||[]).forEach(dn=>donRows.push({'×§×•×“':d.code,'×©×':donorName(d),'×¡×›×•×':dn.amount,'×ª××¨×™×š':fmt(dn.date),'××•×¤×Ÿ':dn.method,'××’×‘×™×ª':campName(dn.campaignId),'×”×¢×¨×•×ª':dn.notes})));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(donRows),'×ª×¨×•××•×ª');
  const futRows=[];
  DB.donors.forEach(d=>(d.futureDonations||[]).forEach(f=>futRows.push({'×§×•×“':d.code,'×©×':donorName(d),'×ª××¨×™×š ×™×¢×“':fmt(f.date),'×¡×›×•× ×¦×¤×•×™':f.expectedAmount||'','××’×‘×™×ª':campName(f.campaignId),'×”×¢×¨×•×ª':f.notes})));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(futRows),'×ª×¨×•××•×ª ×¢×ª×™×“×™×•×ª');
  XLSX.writeFile(wb,`××œ×_${today()}.xlsx`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateReportCampaigns(){
  const el=document.getElementById('rpt_camp');if(!el)return;
  el.innerHTML=`<option value="">×›×œ ×”××’×‘×™×•×ª</option>`+DB.campaigns.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
}

function generateReport(){
  const affil=document.getElementById('rpt_affil').value;
  const pref=document.getElementById('rpt_pref').value;
  const campId=document.getElementById('rpt_camp').value;
  const min=parseFloat(document.getElementById('rpt_min').value)||0;
  const from=document.getElementById('rpt_fromDate').value;
  const to=document.getElementById('rpt_toDate').value;

  // Get donors that have donations matching filters
  const filtered=DB.donors.filter(d=>{
    const dons=(d.donations||[]).filter(dn=>(!campId||dn.campaignId===campId)&&(!from||dn.date>=from)&&(!to||dn.date<=to));
    const total=dons.reduce((s,x)=>s+parseFloat(x.amount||0),0);
    return (!affil||d.affil===affil)&&(!pref||d.prefTime===pref)&&total>=min;
  });

  const reportTotal=filtered.reduce((s,d)=>{
    const dons=(d.donations||[]).filter(dn=>(!campId||dn.campaignId===campId)&&(!from||dn.date>=from)&&(!to||dn.date<=to));
    return s+dons.reduce((ss,dn)=>ss+parseFloat(dn.amount||0),0);
  },0);

  document.getElementById('reportOutput').innerHTML=`<div class="card" style="margin-top:16px">
    <div class="card-header"><h3>×ª×•×¦××•×ª ×”×“×•×—</h3><div style="display:flex;gap:8px">
      <span class="badge" style="background:var(--cream-d);color:var(--muted)">${filtered.length} ×ª×•×¨××™×</span>
      <span class="badge b-cash">â‚ª${reportTotal.toLocaleString()} ×¡×”"×›</span>
    </div></div>
    <div class="card-body" style="padding:0"><div class="table-scroll"><table>
      <thead><tr><th>×§×•×“</th><th>×©×</th><th>×©×™×•×š</th><th>××•×¢×“ ×ª×¨××”</th><th>×¡×œ×•×œ×¨×™</th><th>×¡×š ×ª×¨×•××•×ª</th><th>×’×‘×•×”×”</th><th>××¡' ×ª×¨×•××•×ª</th></tr></thead>
      <tbody>${filtered.map(d=>{
        const dons=(d.donations||[]).filter(dn=>(!campId||dn.campaignId===campId)&&(!from||dn.date>=from)&&(!to||dn.date<=to));
        const t=dons.reduce((s,x)=>s+parseFloat(x.amount||0),0);
        const mx=dons.length?Math.max(...dons.map(x=>parseFloat(x.amount||0))):0;
        return `<tr><td>${d.code||''}</td><td>${donorName(d)}</td><td>${d.affil||''}</td><td>${d.prefTime||''}</td><td>${d.mobile||''}</td><td><strong>â‚ª${t.toLocaleString()}</strong></td><td>â‚ª${mx.toLocaleString()}</td><td>${dons.length}</td></tr>`;
      }).join('')}</tbody>
    </table></div></div></div>`;
}

function exportReport(){
  if(!can('export')){alert('××™×Ÿ ×”×¨×©××ª ×™×™×¦×•×');return;}
  generateReport();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEMO DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNDRAISERS (××ª×¨×™××™×)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let frSortCol = 'name', frSortDir = 1;
let grpTempMembers = []; // temp member IDs when editing group
let grpTempDonors = [];  // temp donor IDs when editing group

// â”€â”€ Generate codes â”€â”€
const VAAD_PREFIX = {'×•×•×¢×“ ×':1,'×•×•×¢×“ ×‘':2,'×•×•×¢×“ ×’':3,'×•×•×¢×“ ×“':4,'×•×•×¢×“ ×”':5,'×•×•×¢×“ ×•':6,'×•×•×¢×“ ×–':7,'×•×•×¢×“ ×—':8,'×•×•×¢×“ ×˜':9};
function genFRCode() {
  if (!DB.nextFRCode) DB.nextFRCode = 1;
  return 'M' + String(DB.nextFRCode++).padStart(4,'0');
}
function genGrpCode(vaad) {
  const prefix = VAAD_PREFIX[vaad] ? String(VAAD_PREFIX[vaad]) : '9';
  if (!DB.nextGrpSeq) DB.nextGrpSeq = {};
  if (!DB.nextGrpSeq[prefix]) DB.nextGrpSeq[prefix] = 1;
  const seq = String(DB.nextGrpSeq[prefix]++).padStart(2,'0');
  return prefix + seq;
}

// â”€â”€ Helper: get name of FR â”€â”€
function frNameById(id) {
  if (!id) return '';
  const f = DB.fundraisers.find(x => x.id === id);
  return f ? (f.firstName||'') + ' ' + (f.lastName||'') : '';
}

// â”€â”€ How much a fundraiser raised (optionally for a specific campaign) â”€â”€


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DONATIONS PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let donsPanelSort = { col:'date', dir:-1 };
let donsPanelRows = [];

function renderDonationsPanel() {
  // Populate filters
  const campSel = document.getElementById('donsCamp');
  if (campSel && campSel.options.length <= 1) {
    DB.campaigns.forEach(c => { const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; campSel.appendChild(o); });
  }
  const frSel = document.getElementById('donsFR');
  if (frSel && frSel.options.length <= 1) {
    DB.fundraisers.forEach(f => { const o=document.createElement('option'); o.value=f.id; o.textContent=frNameById(f.id); frSel.appendChild(o); });
  }
  
  const q = (document.getElementById('donsSearch')?.value||'').toLowerCase().trim();
  const campId = document.getElementById('donsCamp')?.value||'';
  const method = document.getElementById('donsMethod')?.value||'';
  const frId = document.getElementById('donsFR')?.value||'';
  const from = document.getElementById('donsFrom')?.value||'';
  const to = document.getElementById('donsTo')?.value||'';
  
  // Flatten all donations
  let rows = [];
  DB.donors.forEach(donor => {
    (donor.donations||[]).forEach((dn,idx) => {
      if (campId && dn.campaignId !== campId) return;
      if (method && dn.method !== method) return;
      if (frId && dn.fundraiserId !== frId && dn.groupId !== frId) return;
      if (from && dn.date < from) return;
      if (to && dn.date > to) return;
      if (q && !donorName(donor).toLowerCase().includes(q) && !(dn.notes||'').toLowerCase().includes(q)) return;
      rows.push({ donor, dn, donorIdx: DB.donors.indexOf(donor), idx });
    });
  });
  
  // Sort
  rows.sort((a,b) => {
    let av, bv;
    if (donsPanelSort.col==='date') { av=a.dn.date||''; bv=b.dn.date||''; }
    else if (donsPanelSort.col==='amount') { av=parseFloat(a.dn.amount||0); bv=parseFloat(b.dn.amount||0); }
    else if (donsPanelSort.col==='donor') { av=donorName(a.donor); bv=donorName(b.donor); }
    else { av=''; bv=''; }
    return av<bv?donsPanelSort.dir:-donsPanelSort.dir;
  });
  
  donsPanelRows = rows;
  
  // Stats
  const totalAmt = rows.reduce((s,r)=>s+parseFloat(r.dn.amount||0),0);
  const avgAmt = rows.length ? totalAmt/rows.length : 0;
  const maxAmt = rows.reduce((m,r)=>Math.max(m,parseFloat(r.dn.amount||0)),0);
  const uniqueDonors = new Set(rows.map(r=>r.donor.id)).size;
  document.getElementById('donsPanelStats').innerHTML = [
    {v:'â‚ª'+Math.round(totalAmt).toLocaleString(), l:'×¡×”"×›', cl:'green'},
    {v:rows.length, l:'××¡×¤×¨ ×ª×¨×•××•×ª', cl:''},
    {v:uniqueDonors, l:'×ª×•×¨××™× ×©×•× ×™×', cl:''},
    {v:'â‚ª'+Math.round(avgAmt).toLocaleString(), l:'×××•×¦×¢', cl:''},
  ].map(s=>`<div class="stat-card ${s.cl}" style="padding:12px 14px"><div class="stat-val">${s.v}</div><div class="stat-lbl">${s.l}</div></div>`).join('');
  
  document.getElementById('donsPanelCount').textContent = rows.length + ' ×ª×¨×•××•×ª';
  
  // Render table
  const body = document.getElementById('donsPanelBody');
  body.innerHTML = rows.length === 0
    ? '<tr><td colspan="9" style="text-align:center;padding:24px;color:var(--muted)">××™×Ÿ ×ª×¨×•××•×ª ×ª×•×××•×ª</td></tr>'
    : rows.map(({donor,dn,donorIdx,idx}) => {
        const frLabel = dn.fundraiserId ? frNameById(dn.fundraiserId) :
                        dn.groupId ? ('ğŸ‘¥ '+(DB.groups.find(g=>g.id===dn.groupId)?.name||'')) : '';
        return `<tr onclick="openDonorById('${donor.id}')" style="cursor:pointer">
          <td style="white-space:nowrap">${fmt(dn.date)}</td>
          <td style="font-size:11px;color:var(--muted)">${toHeb(dn.date)}</td>
          <td><strong>${donorName(donor)}</strong><br><span style="font-size:10px;color:var(--muted)">${donor.code||''}</span></td>
          <td><strong style="color:var(--success)">â‚ª${parseFloat(dn.amount||0).toLocaleString()}</strong></td>
          <td>${methodBadge ? methodBadge(dn.method) : (dn.method||'')}</td>
          <td style="font-size:11px">${campName(dn.campaignId)||''}</td>
          <td style="font-size:11px;color:var(--muted)">${frLabel}</td>
          <td style="font-size:11px">${dn.notes||''}</td>
          <td onclick="event.stopPropagation()">${can('edit')?`<button class="btn btn-outline btn-sm" onclick="editDonInPanel('${donor.id}',${idx})">âœï¸</button>`:''}
          </td>
        </tr>`;
      }).join('');
}

function sortDonsPanel(col) {
  if (donsPanelSort.col===col) donsPanelSort.dir*=-1; else { donsPanelSort.col=col; donsPanelSort.dir=1; }
  renderDonationsPanel();
}

function exportDonationsPanel() {
  if (!can('admin')) { alert('××™×Ÿ ×”×¨×©××”'); return; }
  const data = [['×ª××¨×™×š','×ª. ×¢×‘×¨×™','×ª×•×¨×','×¡×›×•×','××•×¤×Ÿ','××’×‘×™×ª','××ª×¨×™×/×§×‘×•×¦×”','×”×¢×¨×•×ª'],
    ...donsPanelRows.map(({donor,dn})=>[
      fmt(dn.date), toHeb(dn.date), donorName(donor),
      dn.amount, dn.method||'',
      campName(dn.campaignId)||'',
      dn.fundraiserId ? frNameById(dn.fundraiserId) : (dn.groupId ? (DB.groups.find(g=>g.id===dn.groupId)?.name||'') : ''),
      dn.notes||''
    ])
  ];
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '×ª×¨×•××•×ª');
  XLSX.writeFile(wb, 'donations_'+today()+'.xlsx');
}

function editDonInPanel(donorId, idx) {
  openDonorById(donorId, 'donations');
  setTimeout(() => editDonation(idx), 400);
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRINT REPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ORG_NAME = '×¢×–×¨ ×ª×•×¨×” â€“ ×ª×•×©×™×” ×ª×¤×¨×—';

function printGroupReport(grpId) {
  const grp = DB.groups.find(g=>g.id===grpId); if(!grp) return;
  const ac = activeCampaign();
  const members = (grp.memberIds||[]).map(id=>{
    const f=DB.fundraisers.find(x=>x.id===id);
    return f ? (f.firstName||'')+' '+(f.lastName||'') : '';
  }).filter(Boolean);
  const w = window.open('','_blank','width=800,height=600');
  w.document.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8">
    <title>×“×•×— ×§×‘×•×¦×” â€” ${grp.name}</title>
    <style>
      body{font-family:Arial,sans-serif;margin:40px;color:#1a2744;direction:rtl}
      .org{font-size:22px;font-weight:900;color:#1a2744;border-bottom:3px solid #c9a84c;padding-bottom:8px;margin-bottom:6px}
      .camp{font-size:14px;color:#555;margin-bottom:20px}
      .grp-title{font-size:18px;font-weight:700;margin-bottom:4px}
      .grp-code{font-size:13px;color:#888;margin-bottom:16px}
      .member{display:inline-block;background:#f0f4ff;border:1px solid #1a2744;border-radius:6px;padding:5px 14px;margin:4px;font-size:13px}
      @media print{body{margin:20px}tr{page-break-inside:avoid}td{white-space:normal!important;line-height:1.35;max-height:calc(3 * 1.35em);overflow:hidden}}
    </style></head><body>
    <div class="org">${ORG_NAME}</div>
    <div class="camp">${ac?'××’×‘×™×ª: '+ac.name+' '+( ac.year||''):''}</div>
    <div class="grp-title">×§×‘×•×¦×”: ${grp.name}</div>
    <div class="grp-code">×§×•×“ ×§×‘×•×¦×”: ${grp.code||'â€”'} | ×•×•×¢×“: ${grp.vaad||'â€”'}</div>
    <h3 style="margin-top:20px;font-size:14px">×—×‘×¨×™ ×”×§×‘×•×¦×” (${members.length})</h3>
    <div>${members.map(m=>`<span class="member">${m}</span>`).join('')}</div>
    <div style="margin-top:30px;font-size:12px;color:#aaa">×”×•×“×¤×¡: ${new Date().toLocaleDateString('he-IL')}</div>
    <script>window.onload=()=>window.print();<\/script>
    </body></html>`);
  w.document.close();
}

function printFundraisingSheet(grpId) {
  const grp = DB.groups.find(g=>g.id===grpId); if(!grp) return;
  const ac = activeCampaign();
  // Get previous 3 campaigns
  const sortedCamps = [...DB.campaigns].sort((a,b)=>(b.year||'').localeCompare(a.year||'')).filter(c=>!c.active);
  const prev3 = sortedCamps.slice(0,3);
  
  const members = (grp.memberIds||[]).map(id=>{
    const f=DB.fundraisers.find(x=>x.id===id);
    return f?(f.firstName||'')+' '+(f.lastName||''):'';
  }).filter(Boolean);
  
  const donors = (grp.donorIds||[]).map(id=>DB.donors.find(d=>d.id===id)).filter(Boolean);
  
  const donorRows = donors.map(d=>{
    const tots = (d.donations||[]).reduce((s,dn)=>s+parseFloat(dn.amount||0),0);
    const maxDon = Math.max(0,...(d.donations||[]).map(dn=>parseFloat(dn.amount||0)));
    const prev3Tots = prev3.map(c=>(d.donations||[]).filter(dn=>dn.campaignId===c.id).reduce((s,dn)=>s+parseFloat(dn.amount||0),0));
    const addr = (d.address||'')+(d.entrance?' '+d.entrance:'');
    const tel = [d.phone,d.mobile].filter(Boolean).join(' | ');
    return `<tr>
      <td>${d.title||''} ${donorName(d)}</td>
      <td style="font-size:11px">${addr}</td>
      <td style="font-size:11px">${tel}</td>
      <td style="font-size:11px">${d.notes||''}</td>
      <td style="text-align:center;font-weight:700">${maxDon>0?'â‚ª'+maxDon.toLocaleString():''}</td>
      ${prev3Tots.map(t=>`<td style="text-align:center">${t>0?'â‚ª'+t.toLocaleString():''}</td>`).join('')}
    </tr>`;
  }).join('');
  
  // Build map URL for donors with coordinates
  const coords = donors.filter(d=>d.lat&&d.lng).map(d=>`${d.lat},${d.lng}`);
  const mapSection = coords.length > 0 ? `
    <div style="margin-top:20px;page-break-inside:avoid">
      <h3 style="font-size:13px;margin-bottom:8px">ğŸ—º ××¤×ª ×”××™×¡×•×£</h3>
      <iframe src="https://maps.google.com/maps?q=${encodeURIComponent(donors.filter(d=>d.lat).map(d=>d.address||'').join('|'))}&output=embed&z=15" 
        width="100%" height="300" style="border:1px solid #ccc;border-radius:8px" loading="lazy"></iframe>
    </div>` : '';
  
  const w = window.open('','_blank','width=900,height=700');
  w.document.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8">
    <title>×§×‘×•×¦×” ×œ×”×ª×¨××” â€” ${grp.name}</title>
    <style>
      body{font-family:Arial,sans-serif;margin:30px;color:#1a2744;direction:rtl;font-size:12px}
      .org{font-size:20px;font-weight:900;color:#1a2744;border-bottom:3px solid #c9a84c;padding-bottom:6px;margin-bottom:4px}
      .sub{font-size:12px;color:#555;margin-bottom:14px}
      .members{background:#f8f4ed;padding:7px 12px;border-radius:6px;font-size:11px;margin-bottom:14px}
      table{width:100%;border-collapse:collapse;font-size:11px}
      th{background:#1a2744;color:white;padding:6px 8px;text-align:right;font-size:10px}
      td{padding:5px 8px;border-bottom:1px solid #eee;vertical-align:top}
      tr:nth-child(even) td{background:#f9f9f9}
      @media print{body{margin:15px}.no-print{display:none}}
    </style></head><body>
    <div class="org">${ORG_NAME}</div>
    <div class="sub">${ac?'××’×‘×™×ª: '+ac.name+' '+(ac.year||''):''} | ×§×‘×•×¦×”: ${grp.name} | ×§×•×“: ${grp.code||''}</div>
    <div class="members">ğŸ‘¥ ×—×‘×¨×™ ×”×§×‘×•×¦×”: ${members.join(', ')}</div>
    <table>
      <thead><tr>
        <th>×©× ×ª×•×¨×</th><th>×›×ª×•×‘×ª</th><th>×˜×œ×¤×•×Ÿ</th><th>×”×¢×¨×•×ª</th>
        <th>×ª×¨×•××” ×’×‘×•×”×”</th>
        ${prev3.map(c=>`<th>${c.name}</th>`).join('')}
      </tr></thead>
      <tbody>${donorRows}</tbody>
    </table>
    ${mapSection}
    <div style="margin-top:16px;font-size:10px;color:#aaa">×”×•×“×¤×¡: ${new Date().toLocaleDateString('he-IL')}</div>
    <script>window.onload=()=>window.print();<\/script>
    </body></html>`);
  w.document.close();
}

// Tanex label formats
const TANEX_FORMATS = {
  '70x42': { cols:3, rows:7, w:70, h:42, label:'70Ã—42 ×"× (21 ×œ×“×£)' },
  '70x29': { cols:3, rows:10, w:70, h:29.7, label:'70Ã—29.7 ×"× (30 ×œ×“×£)' },
  '105x42': { cols:2, rows:7, w:105, h:42, label:'105Ã—42 ×"× (14 ×œ×“×£)' },
};

function openLabelsModal() {
  // Show donor selection + format picker
  if(!document.getElementById('labelsModal')) {
    const modal = document.createElement('div');
    modal.id='labelsModal';
    modal.className='modal-overlay';
    modal.innerHTML=`<div class="modal" style="width:520px">
      <div class="modal-header"><h3>ğŸ·ï¸ ×”×“×¤×¡×ª ××“×‘×§×•×ª</h3><button class="modal-close" onclick="closeModal('labelsModal')">âœ•</button></div>
      <div class="modal-body">
        <div class="fg"><label class="form-label">×¤×•×¨××˜ ××“×‘×§×”</label>
          <select class="form-control" id="lb_format">
            ${Object.entries(TANEX_FORMATS).map(([k,v])=>`<option value="${k}">${v.label}</option>`).join('')}
          </select>
        </div>
        <div class="fg" style="margin-top:10px"><label class="form-label">×ª×•×¨××™×</label>
          <select class="form-control" id="lb_source">
            <option value="filtered">××•×¦×’×™× ×›×¨×’×¢ ×‘×˜×‘×œ×”</option>
            <option value="all">×›×œ ×”×ª×•×¨××™×</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline btn-sm" onclick="closeModal('labelsModal')">×‘×™×˜×•×œ</button>
        <button class="btn btn-navy" onclick="printLabels()">ğŸ–¨ï¸ ×”×“×¤×¡ ××“×‘×§×•×ª</button>
      </div>
    </div>`;
    document.getElementById('app').appendChild(modal);
  }
  openModal('labelsModal');
}

function printLabels() {
  const fmt = TANEX_FORMATS[document.getElementById('lb_format')?.value||'70x42'];
  const source = document.getElementById('lb_source')?.value||'filtered';
  const donors = source==='filtered' && filteredRows?.length ? filteredRows : DB.donors;
  
  const S = getSettings();
  // Build label HTML
  const pageW = 210, pageH = 297;
  const marginL = (pageW - fmt.cols*fmt.w) / 2;
  const marginT = (pageH - fmt.rows*fmt.h) / 2;
  
  const labels = donors.map((d,i) => {
    const closing = d.closingName || '';
    const title = d.title||'';
    const name = donorName(d);
    const addr = d.address||'';
    const city = '';  // parse city from address if needed
    return `<div class="label" style="position:absolute;
      left:${marginL + (i%fmt.cols)*fmt.w}mm;
      top:${marginT + Math.floor(i/fmt.cols)*fmt.h}mm;
      width:${fmt.w-4}mm;height:${fmt.h-3}mm;
      overflow:hidden;padding:2mm 3mm;box-sizing:border-box">
      <div style="font-size:9pt;font-weight:700">×œ×›×‘×•×“ ${title} ${name}</div>
      <div style="font-size:8pt;margin-top:1mm">${addr}</div>
      ${closing?`<div style="font-size:7pt;color:#555;margin-top:1mm">${closing}</div>`:''}
    </div>`;
  });
  
  // Group into pages
  const perPage = fmt.cols * fmt.rows;
  const pages = [];
  for(let p=0; p<Math.ceil(labels.length/perPage); p++) {
    pages.push(`<div style="position:relative;width:210mm;height:297mm;page-break-after:always">
      ${labels.slice(p*perPage,(p+1)*perPage).join('')}
    </div>`);
  }
  
  const w = window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8">
    <title>××“×‘×§×•×ª</title>
    <style>
      *{box-sizing:border-box}
      body{margin:0;padding:0;font-family:Arial,sans-serif;direction:rtl}
      .label{border:0.5pt dotted #ccc}
      @page{size:A4;margin:0}
      @media print{.label{border:none}}
    </style></head><body>
    ${pages.join('')}
    <script>window.onload=()=>window.print();<\/script>
    </body></html>`);
  w.document.close();
  closeModal('labelsModal');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REPORTS MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let rptRows = [];

function openReportsModal() {
  const S = getSettings();
  const fills = [
    ['rpt_affil', S.affiliations||[]],
    ['rpt_reltype', S.relTypes||[]],
    ['rpt_preftime', S.prefTimes||[]],
  ];
  fills.forEach(([id, vals]) => {
    const el = document.getElementById(id);
    if(!el) return;
    el.innerHTML = '<option value="">×”×›×œ</option>' + vals.map(v=>`<option>${v}</option>`).join('');
  });
  const campEl = document.getElementById('rpt_camp');
  if(campEl) campEl.innerHTML = '<option value="">×”×›×œ</option>' + DB.campaigns.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  runReport();
  openModal('reportsModal');
}

function runReport() {
  const city = (document.getElementById('rpt_city')?.value||'').toLowerCase().trim();
  const neigh = (document.getElementById('rpt_neigh')?.value||'').toLowerCase().trim();
  const grpcode = (document.getElementById('rpt_grpcode')?.value||'').toLowerCase().trim();
  const name = (document.getElementById('rpt_name')?.value||'').toLowerCase().trim();
  const affil = document.getElementById('rpt_affil')?.value||'';
  const preftime = document.getElementById('rpt_preftime')?.value||'';
  const campId = document.getElementById('rpt_camp')?.value||'';
  const minamt = parseFloat(document.getElementById('rpt_minamt')?.value||0)||0;
  const addFrom = document.getElementById('rpt_addfrom')?.value||'';
  const addTo = document.getElementById('rpt_addto')?.value||'';
  const lastFrom = document.getElementById('rpt_lastfrom')?.value||'';

  const grpDonorIds = grpcode ? new Set(DB.groups
    .filter(g=>(g.code||'').toLowerCase().includes(grpcode))
    .flatMap(g=>g.donorIds||[])) : null;

  rptRows = DB.donors.filter(d => {
    const addr = (d.address||'').toLowerCase();
    if (city && !addr.includes(city)) return false;
    if (neigh && !addr.includes(neigh)) return false;
    if (grpcode && grpDonorIds && !grpDonorIds.has(d.id)) return false;
    if (name && !donorName(d).toLowerCase().includes(name)) return false;
    if (affil && d.affil !== affil) return false;
    if (preftime && d.prefTime !== preftime) return false;
    if (addFrom && (d.createdAt||'') < addFrom) return false;
    if (addTo && (d.createdAt||'') > addTo) return false;
    const dons = d.donations||[];
    if (minamt > 0) {
      const tot = dons.reduce((s,dn)=>s+parseFloat(dn.amount||0),0);
      if (tot < minamt) return false;
    }
    if (campId) {
      const campTot = dons.filter(dn=>dn.campaignId===campId).reduce((s,dn)=>s+parseFloat(dn.amount||0),0);
      if (campTot <= 0) return false;
    }
    if (lastFrom && dons.length) {
      const lastDate = dons.map(dn=>dn.date||'').sort().pop();
      if (lastDate < lastFrom) return false;
    }
    return true;
  });

  const count = document.getElementById('rpt_count');
  if(count) count.textContent = `\u05e0\u05de\u05e6\u05d0\u05d5 ${rptRows.length} \u05ea\u05d5\u05e8\u05de\u05d9\u05dd`;

  const body = document.getElementById('rpt_body');
  if(!body) return;
  body.innerHTML = rptRows.length===0
    ? '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--muted)">\u05d0\u05d9\u05df \u05ea\u05d5\u05e6\u05d0\u05d5\u05ea</td></tr>'
    : rptRows.map(d => {
        const dons = d.donations||[];
        const tot = dons.reduce((s,dn)=>s+parseFloat(dn.amount||0),0);
        const lastDate = dons.map(dn=>dn.date||'').sort().pop()||'';
        return `<tr style="border-bottom:1px solid var(--cream-d);cursor:pointer" onclick="openDonorById('${d.id}')">
          <td style="padding:6px 10px"><strong>${d.title||''} ${donorName(d)}</strong></td>
          <td style="padding:6px 10px;font-size:11px">${d.address||''}</td>
          <td style="padding:6px 10px;font-size:11px">${d.phone||d.mobile||''}</td>
          <td style="padding:6px 10px;font-size:11px">${d.affil||''}</td>
          <td style="padding:6px 10px;font-weight:700;color:var(--success)">\u20aa${Math.round(tot).toLocaleString()}</td>
          <td style="padding:6px 10px;font-size:11px">${fmt(lastDate)}</td>
        </tr>`;
      }).join('');
}

function exportReport() {
  if (!can('admin')) { alert('\u05d0\u05d9\u05df \u05d4\u05e8\u05e9\u05d0\u05d4'); return; }
  const data = [['\u05e7\u05d5\u05d3','\u05e9\u05dd','\u05db\u05ea\u05d5\u05d1\u05ea','\u05d8\u05dc\u05e4\u05d5\u05df','\u05e1\u05dc\u05d5\u05dc\u05e8\u05d9','\u05e9\u05d9\u05d5\u05da','\u05de\u05d5\u05e2\u05d3','\u05d4\u05e2\u05e8\u05d5\u05ea','\u05e1\u05da \u05ea\u05e8\u05d5\u05de\u05d5\u05ea','\u05ea\u05e8\u05d5\u05de\u05d4 \u05d0\u05d7\u05e8\u05d5\u05e0\u05d4'],
    ...rptRows.map(d=>{
      const dons=d.donations||[];
      const tot=dons.reduce((s,dn)=>s+parseFloat(dn.amount||0),0);
      const last=dons.map(dn=>dn.date||'').sort().pop()||'';
      return [d.code||'',donorName(d),d.address||'',d.phone||'',d.mobile||'',d.affil||'',d.prefTime||'',d.notes||'',tot,fmt(last)];
    })
  ];
  const ws=XLSX.utils.aoa_to_sheet(data); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'\u05d3\u05d5\u05d7');
  XLSX.writeFile(wb,'report_'+today()+'.xlsx');
}

function printReport() {
  const ac = activeCampaign();
  const rows = rptRows.length ? rptRows : DB.donors;
  const prev3 = [...DB.campaigns].sort((a,b)=>(b.year||'').localeCompare(a.year||'')).filter(c=>!c.active).slice(0,3);
  const ORG = '\u05e2\u05d6\u05e8 \u05ea\u05d5\u05e8\u05d4 \u2013 \u05ea\u05d5\u05e9\u05d9\u05d4 \u05ea\u05e4\u05e8\u05d7';
  const mapCoords = rows.filter(d=>d.lat&&d.lng);
  const mapSection = mapCoords.length > 0
    ? `<div style="margin-top:20px"><h3 style="font-size:12px">\u05de\u05e4\u05ea \u05d0\u05d9\u05e1\u05d5\u05e3</h3>
        <iframe src="https://maps.google.com/maps?q=${encodeURIComponent(mapCoords.slice(0,5).map(d=>d.address||'').join('|'))}&output=embed&z=14" 
          width="100%" height="280" style="border:1px solid #ccc;border-radius:6px" loading="lazy"></iframe></div>` : '';

  const w = window.open('','_blank','width=1000,height=700');
  w.document.write('<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8"><title>\u05d3\u05d5\u05d7 \u05ea\u05d5\u05e8\u05de\u05d9\u05dd</title><style>body{font-family:Arial,sans-serif;margin:20px 30px;color:#1a2744;direction:rtl;font-size:11px}.org{font-size:18px;font-weight:900;border-bottom:3px solid #c9a84c;padding-bottom:5px;margin-bottom:4px}.sub{font-size:11px;color:#666;margin-bottom:12px}table{width:100%;border-collapse:collapse}th{background:#1a2744;color:white;padding:5px 8px;text-align:right;font-size:10px}td{padding:4px 8px;border-bottom:1px solid #eee;vertical-align:top;font-size:10px}tr:nth-child(even) td{background:#f9f9f9}@media print{body{margin:10px}tr{page-break-inside:avoid}td{white-space:normal!important;line-height:1.35;max-height:calc(3 * 1.35em);overflow:hidden}}</style></head><body>');
  w.document.write(`<div class="org">${ORG}</div>`);
  w.document.write(`<div class="sub">${ac?ac.name+' '+(ac.year||''):''} | ${rows.length} \u05ea\u05d5\u05e8\u05de\u05d9\u05dd | ${new Date().toLocaleDateString('he-IL')}</div>`);
  w.document.write('<table><thead><tr><th>\u05e9\u05dd</th><th>\u05db\u05ea\u05d5\u05d1\u05ea</th><th>\u05d8\u05dc\u05e4\u05d5\u05df</th><th>\u05d4\u05e2\u05e8\u05d5\u05ea</th><th>\u05ea\u05e8\u05d5\u05de\u05d4 \u05d2\u05d1\u05d5\u05d4\u05d4</th>'+prev3.map(c=>`<th>${c.name}</th>`).join('')+'</tr></thead><tbody>');
  rows.forEach(d => {
    const dons=d.donations||[];
    const maxDon=Math.max(0,...dons.map(dn=>parseFloat(dn.amount||0)));
    const prev3Tots=prev3.map(c=>dons.filter(dn=>dn.campaignId===c.id).reduce((s,dn)=>s+parseFloat(dn.amount||0),0));
    w.document.write(`<tr><td><strong>${d.title||''} ${donorName(d)}</strong></td><td>${d.address||''}</td><td>${[d.phone,d.mobile].filter(Boolean).join(' | ')}</td><td>${d.notes||''}</td><td style="text-align:center;font-weight:700">${maxDon>0?'\u20aa'+maxDon.toLocaleString():''}</td>${prev3Tots.map(t=>`<td style="text-align:center">${t>0?'\u20aa'+t.toLocaleString():''}</td>`).join('')}</tr>`);
  });
  w.document.write('</tbody></table>'+mapSection+'<div style="margin-top:10px;font-size:9px;color:#aaa">\u05d4\u05d5\u05d3\u05e4\u05e1: '+new Date().toLocaleDateString('he-IL')+'</div><script>window.onload=()=>window.print();<\/script></body></html>');
  w.document.close();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRINT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPrintModal() { openModal('printModal'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LABELS WIZARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LB_FMTS = {
  '70x42':  {cols:3,rows:7, lw:70,  lh:42,   ml:0, mt:10.5},
  '70x29':  {cols:3,rows:10,lw:70,  lh:29.7, ml:0, mt:13.5},
  '105x42': {cols:2,rows:7, lw:105, lh:42,   ml:0, mt:10.5},
};

function openLabelsWizard() {
  closeModal('printModal');
  const grpSel = document.getElementById('lb_group_sel');
  if(grpSel) grpSel.innerHTML = '<option value="">\u05db\u05dc \u05d4\u05e7\u05d1\u05d5\u05e6\u05d5\u05ea</option>' + DB.groups.map(g=>`<option value="${g.id}">${g.name} (${g.code||''})</option>`).join('');
  const srcEl = document.getElementById('lb_source');
  if(srcEl) srcEl.onchange = function() {
    const el = document.getElementById('lb_group_sel');
    if(el) el.style.display = this.value==='group'?'':'none';
  };
  previewLabel();
  openModal('labelsWizardModal');
}

function previewLabel() {
  const font = document.getElementById('lb_font')?.value||'Arial';
  const fs = document.getElementById('lb_fontsize')?.value||'9';
  const showGreeting = document.getElementById('lbf_greeting')?.checked;
  const showTitle = document.getElementById('lbf_title')?.checked;
  const showName = document.getElementById('lbf_name')?.checked;
  const showClosing = document.getElementById('lbf_closing')?.checked;
  const showAddr = document.getElementById('lbf_address')?.checked;
  const showPhone = document.getElementById('lbf_phone')?.checked;
  const sample = DB.donors[0] || {title:'\u05d4\u05e8\u05d1', firstName:'\u05d9\u05e9\u05e8\u05d0\u05dc', lastName:'\u05d9\u05e9\u05e8\u05d0\u05dc\u05d9', closingName:'\u05d1\u05d1\u05e8\u05db\u05d4', address:'\u05e8\u05d7\u05d5\u05d1 \u05d4\u05e8\u05e6\u05dc 12, \u05ea\u05dc \u05d0\u05d1\u05d9\u05d1', phone:'03-1234567'};
  let lines = [];
  if(showGreeting) lines.push('<div>\u05dc\u05db\u05d1\u05d5\u05d3</div>');
  const nameLine = [showTitle?sample.title||'':'', showName?donorName(sample):''].filter(Boolean).join(' ');
  if(nameLine.trim()) lines.push(`<div><strong>${nameLine.trim()}</strong></div>`);
  if(showClosing && sample.closingName) lines.push(`<div>${sample.closingName}</div>`);
  if(showAddr && sample.address) lines.push(`<div>${sample.address}</div>`);
  if(showPhone && (sample.phone||sample.mobile)) lines.push(`<div>${sample.phone||sample.mobile}</div>`);
  const prev = document.getElementById('lb_preview');
  if(prev) prev.innerHTML = lines.map(l=>`<div style="font-family:${font};font-size:${fs}pt">${l}</div>`).join('');
}

function runPrintLabels() {
  const fmtKey = document.querySelector('input[name="lb_fmt"]:checked')?.value||'70x42';
  const fmt = LB_FMTS[fmtKey];
  const source = document.getElementById('lb_source')?.value||'all';
  const grpId = document.getElementById('lb_group_sel')?.value||'';
  const font = document.getElementById('lb_font')?.value||'Arial';
  const fs = parseInt(document.getElementById('lb_fontsize')?.value||'9');
  const showGreeting = document.getElementById('lbf_greeting')?.checked;
  const showTitle = document.getElementById('lbf_title')?.checked;
  const showName = document.getElementById('lbf_name')?.checked;
  const showClosing = document.getElementById('lbf_closing')?.checked;
  const showAddr = document.getElementById('lbf_address')?.checked;
  const showPhone = document.getElementById('lbf_phone')?.checked;

  let donors;
  if (source==='group' && grpId) {
    const grp = DB.groups.find(g=>g.id===grpId);
    donors = (grp?.donorIds||[]).map(id=>DB.donors.find(d=>d.id===id)).filter(Boolean);
  } else if (source==='filtered') {
    donors = rptRows.length ? rptRows : DB.donors;
  } else {
    donors = DB.donors;
  }

  const perPage = fmt.cols * fmt.rows;
  const pages = [];
  for (let p=0; p<Math.ceil(donors.length/perPage); p++) {
    const pg = donors.slice(p*perPage,(p+1)*perPage);
    const divs = pg.map((d,i) => {
      const col = i % fmt.cols;
      const row2 = Math.floor(i / fmt.cols);
      let lines = [];
      if(showGreeting) lines.push('<div>\u05dc\u05db\u05d1\u05d5\u05d3</div>');
      const nl = [showTitle?d.title||'':'',showName?donorName(d):''].filter(Boolean).join(' ');
      if(nl.trim()) lines.push(`<div><strong>${nl.trim()}</strong></div>`);
      if(showClosing&&d.closingName) lines.push(`<div>${d.closingName}</div>`);
      if(showAddr&&d.address) lines.push(`<div>${d.address}</div>`);
      if(showPhone&&(d.phone||d.mobile)) lines.push(`<div>${d.phone||d.mobile}</div>`);
      return `<div style="position:absolute;left:${fmt.ml+col*fmt.lw}mm;top:${fmt.mt+row2*fmt.lh}mm;width:${fmt.lw-4}mm;height:${fmt.lh-2}mm;overflow:hidden;padding:2mm 3mm;font-family:${font};font-size:${fs}pt;line-height:1.3;box-sizing:border-box">${lines.join('')}</div>`;
    }).join('');
    pages.push(`<div style="position:relative;width:210mm;height:297mm;page-break-after:always">${divs}</div>`);
  }
  const w = window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8"><title>\u05de\u05d3\u05d1\u05e7\u05d5\u05ea</title><style>*{box-sizing:border-box}body{margin:0;padding:0;direction:rtl}@page{size:A4;margin:0}@media print{body{margin:0}}</style></head><body>${pages.join('')}<script>window.onload=()=>window.print();<\/script></body></html>`);
  w.document.close();
  closeModal('labelsWizardModal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNDRAISING PRINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openFundraisingPrint() {
  closeModal('printModal');
  const grpSel = document.getElementById('frp_group');
  if(grpSel) grpSel.innerHTML = '<option value="">\u05db\u05dc \u05d4\u05e7\u05d1\u05d5\u05e6\u05d5\u05ea</option>' + DB.groups.map(g=>`<option value="${g.id}">${g.name} (${g.code||''})</option>`).join('');
  const campSel = document.getElementById('frp_camp');
  if(campSel) campSel.innerHTML = '<option value="">\u05de\u05d2\u05d1\u05d9\u05ea \u05e4\u05e2\u05d9\u05dc\u05d4</option>' + DB.campaigns.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  openModal('frPrintModal');
}

function onFrpTypeChange() {
  const t = document.getElementById('frp_type')?.value||'group';
  ['frp_group_row','frp_city_row','frp_neigh_row'].forEach(id=>{document.getElementById(id).style.display='none';});
  if(t==='group') document.getElementById('frp_group_row').style.display='';
  else if(t==='city') document.getElementById('frp_city_row').style.display='';
  else document.getElementById('frp_neigh_row').style.display='';
}

function getFrpDonors(t) {
  if(t==='group') {
    const grpId = document.getElementById('frp_group')?.value||'';
    if(!grpId) return DB.donors;
    const grp = DB.groups.find(g=>g.id===grpId);
    return (grp?.donorIds||[]).map(id=>DB.donors.find(d=>d.id===id)).filter(Boolean);
  }
  if(t==='city') {
    const city = (document.getElementById('frp_city')?.value||'').toLowerCase().trim();
    return city ? DB.donors.filter(d=>(d.address||'').toLowerCase().includes(city)) : DB.donors;
  }
  const neigh = (document.getElementById('frp_neigh')?.value||'').toLowerCase().trim();
  return neigh ? DB.donors.filter(d=>(d.address||'').toLowerCase().includes(neigh)) : DB.donors;
}

function previewFrPrint() {
  const t = document.getElementById('frp_type')?.value||'group';
  const donors = getFrpDonors(t);
  const el = document.getElementById('frp_preview');
  if(el) el.textContent = `\u05d9\u05d5\u05d3\u05e4\u05e1\u05d5 ${donors.length} \u05ea\u05d5\u05e8\u05de\u05d9\u05dd`;
}

function runFrPrint() {
  const t = document.getElementById('frp_type')?.value||'group';
  const campId = document.getElementById('frp_camp')?.value||'';
  const ac = campId ? DB.campaigns.find(c=>c.id===campId) : activeCampaign();
  const grpId = document.getElementById('frp_group')?.value||'';
  const grp = grpId ? DB.groups.find(g=>g.id===grpId) : null;
  const donors = getFrpDonors(t);
  const prev3 = [...DB.campaigns].sort((a,b)=>(b.year||'').localeCompare(a.year||'')).filter(c=>!c.active).slice(0,3);
  const members = grp ? (grp.memberIds||[]).map(id=>frNameById(id)).filter(Boolean) : [];
  const ORG = '\u05e2\u05d6\u05e8 \u05ea\u05d5\u05e8\u05d4 \u2013 \u05ea\u05d5\u05e9\u05d9\u05d4 \u05ea\u05e4\u05e8\u05d7';
  const mapCoords = donors.filter(d=>d.lat&&d.lng);
  const mapSection = mapCoords.length > 0
    ? `<div style="margin-top:16px"><h3 style="font-size:12px">\u05de\u05e4\u05ea \u05d0\u05d9\u05e1\u05d5\u05e3</h3><iframe src="https://maps.google.com/maps?q=${encodeURIComponent(mapCoords.slice(0,8).map(d=>d.address||'').join('|'))}&output=embed&z=14" width="100%" height="280" style="border:1px solid #ccc;border-radius:6px" loading="lazy"></iframe></div>` : '';

  const w = window.open('','_blank','width=1000,height=700');
  w.document.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8"><title>\u05d2\u05d9\u05dc\u05d9\u05d5\u05df \u05d4\u05ea\u05e8\u05de\u05d4</title><style>body{font-family:Arial,sans-serif;margin:25px 30px;color:#1a2744;direction:rtl;font-size:11px}.org{font-size:20px;font-weight:900;border-bottom:3px solid #c9a84c;padding-bottom:5px;margin-bottom:4px}.sub{font-size:11px;color:#666;margin-bottom:10px}.mbrs{background:#f0f4ff;padding:6px 12px;border-radius:6px;font-size:10px;margin-bottom:10px}table{width:100%;border-collapse:collapse}th{background:#1a2744;color:white;padding:5px 8px;text-align:right;font-size:10px}td{padding:4px 8px;border-bottom:1px solid #eee;vertical-align:top}tr:nth-child(even) td{background:#f9f9f9}@media print{body{margin:12px}td{max-height:none;word-break:break-word;overflow-wrap:break-word}}</style></head><body>`);
  w.document.write(`<div class="org">${ORG}</div>`);
  w.document.write(`<div class="sub">${ac?ac.name+' '+(ac.year||''):''} ${grp?'| \u05e7\u05d1\u05d5\u05e6\u05d4: '+grp.name+' ('+grp.code+')':''} | ${donors.length} \u05ea\u05d5\u05e8\u05de\u05d9\u05dd</div>`);
  if(members.length) w.document.write(`<div class="mbrs">\u05d7\u05d1\u05e8\u05d9 \u05d4\u05e7\u05d1\u05d5\u05e6\u05d4: ${members.join(' | ')}</div>`);
  w.document.write('<table><thead><tr><th>\u05e9\u05dd</th><th>\u05db\u05ea\u05d5\u05d1\u05ea</th><th>\u05d8\u05dc\u05e4\u05d5\u05df</th><th>\u05d4\u05e2\u05e8\u05d5\u05ea</th><th>\u05ea\u05e8\u05d5\u05de\u05d4 \u05d2\u05d1\u05d5\u05d4\u05d4</th>'+prev3.map(c=>`<th>${c.name}</th>`).join('')+'</tr></thead><tbody>');
  donors.forEach(d => {
    const dons=d.donations||[];
    const maxDon=Math.max(0,...dons.map(dn=>parseFloat(dn.amount||0)));
    const prev3Tots=prev3.map(c=>dons.filter(dn=>dn.campaignId===c.id).reduce((s,dn)=>s+parseFloat(dn.amount||0),0));
    const tel=[d.phone,d.mobile].filter(Boolean).join(' | ');
    w.document.write(`<tr><td>${d.title||''} ${donorName(d)}</td><td>${d.address||''}</td><td>${tel}</td><td>${d.notes||''}</td><td style="text-align:center;font-weight:700">${maxDon>0?'\u20aa'+maxDon.toLocaleString():''}</td>${prev3Tots.map(p=>`<td style="text-align:center">${p>0?'\u20aa'+p.toLocaleString():''}</td>`).join('')}</tr>`);
  });
  w.document.write('</tbody></table>'+mapSection+'<div style="margin-top:10px;font-size:9px;color:#aaa">\u05d4\u05d5\u05d3\u05e4\u05e1: '+new Date().toLocaleDateString('he-IL')+'</div><script>window.onload=()=>window.print();<\/script></body></html>');
  w.document.close();
  closeModal('frPrintModal');
}

function printGroupsOverview() {
  closeModal('printModal');
  const ac = activeCampaign();
  const ORG = '\u05e2\u05d6\u05e8 \u05ea\u05d5\u05e8\u05d4 \u2013 \u05ea\u05d5\u05e9\u05d9\u05d4 \u05ea\u05e4\u05e8\u05d7';
  const w = window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8"><title>\u05e7\u05d1\u05d5\u05e6\u05d5\u05ea</title><style>body{font-family:Arial,sans-serif;margin:25px;direction:rtl;font-size:12px}table{width:100%;border-collapse:collapse}th{background:#1a2744;color:white;padding:6px 10px;text-align:right}td{padding:5px 10px;border-bottom:1px solid #eee}tr:nth-child(even) td{background:#f9f9f9}@media print{body{margin:12px}td{max-height:none;word-break:break-word;overflow-wrap:break-word}}</style></head><body>`);
  w.document.write(`<h2 style="color:#1a2744">${ORG}</h2><p style="color:#666">${ac?ac.name+' '+(ac.year||''):''} | ${DB.groups.length} \u05e7\u05d1\u05d5\u05e6\u05d5\u05ea</p>`);
  w.document.write('<table><thead><tr><th>\u05e7\u05d5\u05d3</th><th>\u05e9\u05dd</th><th>\u05d5\u05d5\u05e2\u05d3</th><th>\u05d7\u05d1\u05e8\u05d9\u05dd</th><th>\u05d2\u05d9\u05d5\u05e1</th><th>\u05d9\u05e2\u05d3</th></tr></thead><tbody>');
  DB.groups.forEach(g => {
    const members=(g.memberIds||[]).map(id=>frNameById(id)).filter(Boolean);
    const raised=grpRaisedCamp(g,ac?.id);
    w.document.write(`<tr><td>${g.code||'\u2014'}</td><td>${g.name}</td><td>${g.vaad||''}</td><td>${members.join(', ')}</td><td style="text-align:center">${raised>0?'\u20aa'+raised.toLocaleString():''}</td><td style="text-align:center">${g.target?'\u20aa'+parseFloat(g.target).toLocaleString():''}</td></tr>`);
  });
  w.document.write('</tbody></table><script>window.onload=()=>window.print();<\/script></body></html>');
  w.document.close();
}

function printCampaignSummary() {
  closeModal('printModal');
  const ac = activeCampaign(); if(!ac){alert('\u05d0\u05d9\u05df \u05de\u05d2\u05d1\u05d9\u05ea \u05e4\u05e2\u05d9\u05dc\u05d4');return;}
  const tot = DB.donors.reduce((s,d)=>s+(d.donations||[]).filter(dn=>dn.campaignId===ac.id).reduce((ss,dn)=>ss+parseFloat(dn.amount||0),0),0);
  const target = parseFloat(ac.target||0);
  const pct = target>0?Math.round(tot/target*100):0;
  const ORG = '\u05e2\u05d6\u05e8 \u05ea\u05d5\u05e8\u05d4 \u2013 \u05ea\u05d5\u05e9\u05d9\u05d4 \u05ea\u05e4\u05e8\u05d7';
  const w = window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8"><title>\u05e1\u05d9\u05db\u05d5\u05dd</title><style>body{font-family:Arial,sans-serif;margin:40px;direction:rtl;text-align:center}.bar-bg{background:#eee;border-radius:8px;height:30px;margin:12px auto;max-width:450px}.bar-fg{background:#c9a84c;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#1a2744;font-weight:700}@media print{body{margin:20px}tr{page-break-inside:avoid}td{white-space:normal!important;line-height:1.35;max-height:calc(3 * 1.35em);overflow:hidden}}</style></head><body>`);
  w.document.write(`<h1 style="color:#1a2744">${ORG}</h1><h2 style="color:#555">${ac.name} ${ac.year||''}</h2><div style="font-size:48px;font-weight:900;color:#1a2744">\u20aa${Math.round(tot).toLocaleString()}</div><div style="font-size:18px;color:#666">\u05de\u05ea\u05d5\u05da \u05d9\u05e2\u05d3 \u20aa${Math.round(target).toLocaleString()}</div><div class="bar-bg"><div class="bar-fg" style="width:${Math.min(pct,100)}%">${pct}%</div></div>`);
  w.document.write('<script>window.onload=()=>window.print();<\/script></body></html>');
  w.document.close();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT WIZARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openExportWizard() {
  const affilSel = document.getElementById('ex_affil');
  const S = getSettings();
  affilSel.innerHTML = '<option value="">×”×›×œ</option>' + (S.affiliations||[]).map(v=>`<option>${v}</option>`).join('');
  const campSel = document.getElementById('ex_camp');
  campSel.innerHTML = '<option value="">×”×›×œ</option>' + DB.campaigns.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  document.getElementById('ex_preview').textContent = '×œ×—×¥ ×¢×œ ×ª×¦×•×’×” ××§×“×™××” ×œ×¤× ×™ ×”×™×™×¦×•×';
  openModal('exportWizard');
}
function getExportFilteredRows() {
  const affil = document.getElementById('ex_affil')?.value||'';
  const campId = document.getElementById('ex_camp')?.value||'';
  const minTotal = parseFloat(document.getElementById('ex_minTotal')?.value||0)||0;
  const minCamp = parseFloat(document.getElementById('ex_minCamp')?.value||0)||0;
  const from = document.getElementById('ex_from')?.value||'';
  const to = document.getElementById('ex_to')?.value||'';
  return DB.donors.filter(d => {
    if (affil && d.affil !== affil) return false;
    const tot = (d.donations||[]).reduce((s,dn)=>s+parseFloat(dn.amount||0),0);
    if (tot < minTotal) return false;
    if (campId) {
      const campTot = (d.donations||[]).filter(dn=>dn.campaignId===campId).reduce((s,dn)=>s+parseFloat(dn.amount||0),0);
      if (campTot < minCamp) return false;
    }
    if (from || to) {
      const hasDon = (d.donations||[]).some(dn=>(!from||dn.date>=from)&&(!to||dn.date<=to));
      if (!hasDon) return false;
    }
    return true;
  });
}
function previewExport() {
  const rows = getExportFilteredRows();
  document.getElementById('ex_preview').innerHTML = `<strong>× ××¦××• ${rows.length} ×ª×•×¨××™× ×ª×•×××™×</strong> â€” ${rows.slice(0,5).map(d=>donorName(d)).join(', ')}${rows.length>5?'...':''}`;
}
function runExportWizard() {
  const rows = getExportFilteredRows();
  if (!rows.length) { alert('×œ× × ××¦××• ×ª×•×¨××™× ×ª×•×××™×'); return; }
  const cols = Array.from(document.querySelectorAll('#ex_cols input:checked')).map(el=>el.value);
  const colFns = {
    '×§×•×“': d=>d.code||'', '×©×': d=>donorName(d), '×©×™×•×š': d=>d.affil||'',
    '×›×ª×•×‘×ª': d=>d.address||'', '×˜×œ×¤×•×Ÿ': d=>d.phone||'', '×¡×œ×•×œ×¨×™': d=>d.mobile||'',
    '××™×™×œ': d=>d.email||'', '××•×¢×“ ×ª×¨××”': d=>d.prefTime||'',
    '×¡×š ×ª×¨×•××•×ª': d=>(d.donations||[]).reduce((s,dn)=>s+parseFloat(dn.amount||0),0),
    '×ª×¨×•××” ×’×‘×•×”×”': d=>Math.max(0,...(d.donations||[]).map(dn=>parseFloat(dn.amount||0))),
    '××¡×¤×¨ ×ª×¨×•××•×ª': d=>(d.donations||[]).length, '×”×¢×¨×•×ª': d=>d.notes||'',
  };
  const ws_data = [cols, ...rows.map(d=>cols.map(c=>colFns[c]?colFns[c](d):''))];
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, '×™×™×¦×•×');
  XLSX.writeFile(wb, 'export_'+today()+'.xlsx');
  closeModal('exportWizard');
}
// Export currently shown/filtered donors table
function exportFiltered() {
  if (!can('admin')) { alert('××™×Ÿ ×”×¨×©××”'); return; }
  const rows = filteredRows && filteredRows.length ? filteredRows : DB.donors;
  const ws_data = [['×§×•×“','×©×','×©×™×•×š','×›×ª×•×‘×ª','×˜×œ×¤×•×Ÿ','×¡×œ×•×œ×¨×™','××™×™×œ','×”×¢×¨×•×ª','×¡×š ×ª×¨×•××•×ª','×ª×¨×•××” ×’×‘×•×”×”'],
    ...rows.map(d=>[d.code||'',donorName(d),d.affil||'',d.address||'',d.phone||'',d.mobile||'',d.email||'',d.notes||'',
      (d.donations||[]).reduce((s,dn)=>s+parseFloat(dn.amount||0),0),
      Math.max(0,...(d.donations||[]).map(dn=>parseFloat(dn.amount||0)))
    ])
  ];
  const ws = XLSX.utils.aoa_to_sheet(ws_data); const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '×ª×•×¨××™×');
  XLSX.writeFile(wb, 'donors_filtered_'+today()+'.xlsx');
}

// â”€â”€ FR raised = direct donations + proportional group-share â”€â”€
// Direct: donation.fundraiserId === frId â†’ full amount to that FR
// Group: donation.groupId === grp.id â†’ amount DIVIDED equally among group members
function frRaisedTotal(frId, campId) {
  let tot = 0;
  // 1. Direct donations linked to this fundraiser
  DB.donors.forEach(d => (d.donations||[]).forEach(dn => {
    if (dn.fundraiserId === frId && (!campId || dn.campaignId === campId))
      tot += parseFloat(dn.amount||0);
  }));
  // 2. Group-share: this FR gets amount/memberCount per group donation
  DB.groups.forEach(grp => {
    if (!(grp.memberIds||[]).includes(frId)) return;
    const memberCount = grp.memberIds.length;
    if (!memberCount) return;
    DB.donors.forEach(d => (d.donations||[]).forEach(dn => {
      if (dn.groupId === grp.id && (!campId || dn.campaignId === campId))
        tot += parseFloat(dn.amount||0) / memberCount; // e.g. 100â‚ª / 4 members = 25â‚ª each
    }));
  });
  return Math.round(tot * 100) / 100;
}

// Total raised BY a group = sum of all donations where groupId===grp.id (not divided)
function grpRaisedByGroupId(grpId, campId) {
  let tot = 0;
  DB.donors.forEach(d => (d.donations||[]).forEach(dn => {
    if (dn.groupId === grpId && (!campId || dn.campaignId === campId))
      tot += parseFloat(dn.amount||0);
  }));
  return tot;
}
// Override grpRaisedCamp to use direct group donations only
function grpRaisedCamp(grp, campId) {
  return grpRaisedByGroupId(grp.id, campId);
}

function frRaised(frId, campId) {
  let tot = 0;
  DB.donors.forEach(d => (d.donations||[]).forEach(dn => {
    if (dn.fundraiserId === frId && (!campId || dn.campaignId === campId))
      tot += parseFloat(dn.amount||0);
  }));
  return tot;
}

// â”€â”€ How much a group raised (via member fundraisers OR direct group attribution) â”€â”€
function grpRaised(grp, campId) {
  let tot = 0;
  // Count donations directly attributed to this group
  DB.donors.forEach(d => (d.donations||[]).forEach(dn => {
    if (dn.groupId === grp.id && (!campId || dn.campaignId === campId))
      tot += parseFloat(dn.amount||0);
  }));
  return tot;
}

// frRaised: count donations attributed to a specific fundraiser (not via group)

function switchFRTab(tab) {
  ['list','groups'].forEach(t => {
    document.getElementById('frcontent-' + t).style.display = t === tab ? '' : 'none';
    document.getElementById('frtab-' + t).classList.toggle('active', t === tab);
  });
  if (tab === 'list') renderFRList();
  if (tab === 'groups') renderGroupsList();
}

// â”€â”€ Render FR list table â”€â”€
function renderFRPage() {
  renderFRList();
  // Populate vaad filter
  const vaadSel = document.getElementById('frVaad');
  if (vaadSel) {
    const vaads = [...new Set(DB.fundraisers.map(f => f.vaad).filter(Boolean))].sort();
    vaadSel.innerHTML = '<option value="">×›×œ ×”×•×•×¢×“×™×</option>' + vaads.map(v=>`<option>${v}</option>`).join('');
  }
  if (!can('edit')) {
    const btns = document.getElementById('frBtns');
    if (btns) btns.style.display = 'none';
  }
}

function renderFRList() {
  const q = (document.getElementById('frSearch')?.value||'').trim().toLowerCase();
  const vaad = document.getElementById('frVaad')?.value||'';
  const ac = activeCampaign();

  let rows = DB.fundraisers.filter(f => {
    const nm = ((f.firstName||'') + ' ' + (f.lastName||'')).toLowerCase();
    return (!q || nm.includes(q) || (f.code||'').toLowerCase().includes(q) || (f.groupCode||'').includes(q))
      && (!vaad || f.vaad === vaad);
  });

  rows.sort((a,b) => {
    let av, bv;
    if (frSortCol === 'name') { av = (a.firstName||'')+(a.lastName||''); bv = (b.firstName||'')+(b.lastName||''); }
    else if (frSortCol === 'raised') { av = frRaised(a.id, ac?.id); bv = frRaised(b.id, ac?.id); }
    else if (frSortCol === 'target') { av = parseFloat(a.target||0); bv = parseFloat(b.target||0); }
    else { av = a[frSortCol]||''; bv = b[frSortCol]||''; }
    return av < bv ? -frSortDir : av > bv ? frSortDir : 0;
  });

  const lbl = document.getElementById('frCountLabel');
  if (lbl) lbl.textContent = rows.length + ' ××ª×¨×™××™×';

  const body = document.getElementById('frListBody');
  if (!body) return;
  const ce = can('edit');
  body.innerHTML = rows.length === 0
    ? `<tr><td colspan="11" style="text-align:center;padding:28px;color:var(--muted)">××™×Ÿ ××ª×¨×™××™× ×¨×©×•××™×</td></tr>`
    : rows.map(f => {
        const raised = frRaisedTotal(f.id, ac?.id);
        const target = parseFloat(f.target||0);
        const pct = target > 0 ? Math.min(raised/target*100, 100) : 0;
        const avail = f.availPhone === 'home' ? (f.homePhone||'') : (f.mobile||'');
        return `<tr onclick="openFRModal('${f.id}')">
          <td><strong>${f.code||''}</strong></td>
          <td>${(f.firstName||'')} ${(f.lastName||'')}</td>
          <td>${f.vaad||''}</td>
          <td>${f.groupCode||''}</td>
          <td style="font-size:11px">${f.homePhone||''}</td>
          <td style="font-size:11px">${f.mobile||''}</td>
          <td style="font-size:11px;font-weight:600">${avail}</td>
          <td>${target > 0 ? 'â‚ª'+target.toLocaleString() : ''}</td>
          <td><strong style="color:var(--success)">â‚ª${raised.toLocaleString()}</strong></td>
          <td style="min-width:100px">
            ${target > 0 ? `<div class="progress-bar" style="height:8px;margin:0"><div class="progress-fill" style="width:${pct}%"></div></div><span style="font-size:10px;color:var(--muted)">${Math.round(pct)}%</span>` : ''}
          </td>
          <td onclick="event.stopPropagation()"><div class="row-actions">
            ${ce ? `<button class="btn btn-danger btn-sm" onclick="deleteFRById('${f.id}')">ğŸ—‘ï¸</button>` : ''}
          </div></td>
        </tr>`;
      }).join('');
}

function sortFRL(col) {
  if (frSortCol === col) frSortDir *= -1; else { frSortCol = col; frSortDir = 1; }
  renderFRList();
}

// â”€â”€ FR Modal â”€â”€
function openFRModal(id) {
  const isEdit = !!id;
  document.getElementById('frModalTitle').textContent = isEdit ? '×¢×¨×™×›×ª ××ª×¨×™×' : '×”×•×¡×¤×ª ××ª×¨×™×';
  document.getElementById('frDeleteBtn').style.display = isEdit ? '' : 'none';
  document.getElementById('fr_editId').value = id || '';
  if (isEdit) {
    const f = DB.fundraisers.find(x => x.id === id);
    if (!f) return;
    document.getElementById('fr_code').value = f.code||'';
    document.getElementById('fr_firstName').value = f.firstName||'';
    document.getElementById('fr_lastName').value = f.lastName||'';
    document.getElementById('fr_vaad').value = f.vaad||'';
    document.getElementById('fr_groupCode').value = f.groupCode||'';
    document.getElementById('fr_homePhone').value = f.homePhone||'';
    document.getElementById('fr_mobile').value = f.mobile||'';
    document.getElementById('fr_availPhone').value = f.availPhone||'mobile';
    document.getElementById('fr_target').value = f.target||'';
  } else {
    ['fr_firstName','fr_lastName','fr_groupCode','fr_homePhone','fr_mobile','fr_target'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('fr_vaad').value = '';
    document.getElementById('fr_availPhone').value = 'mobile';
    document.getElementById('fr_code').value = genFRCode(); saveDB();
  }
  openModal('frModal');
}

function saveFR() {
  const fn = document.getElementById('fr_firstName').value.trim();
  const ln = document.getElementById('fr_lastName').value.trim();
  if (!fn && !ln) { alert('×™×© ×œ×”×–×™×Ÿ ×©×'); return; }
  const editId = document.getElementById('fr_editId').value;
  const obj = {
    id: editId || 'FR' + Date.now(),
    code: document.getElementById('fr_code').value,
    firstName: fn, lastName: ln,
    vaad: document.getElementById('fr_vaad').value,
    groupCode: document.getElementById('fr_groupCode').value.trim(),
    homePhone: document.getElementById('fr_homePhone').value.trim(),
    mobile: document.getElementById('fr_mobile').value.trim(),
    availPhone: document.getElementById('fr_availPhone').value,
    target: parseFloat(document.getElementById('fr_target').value)||0,
  };
  if (editId) {
    const idx = DB.fundraisers.findIndex(x => x.id === editId);
    if (idx >= 0) DB.fundraisers[idx] = obj;
  } else {
    DB.fundraisers.push(obj);
  }
  saveDB(); closeModal('frModal'); renderFRList();
  if (document.getElementById('pageDash').classList.contains('active')) renderDash();
}

function saveFRandNew() {
  const fn = document.getElementById('fr_firstName').value.trim();
  const ln = document.getElementById('fr_lastName').value.trim();
  if (!fn && !ln) { alert('×™×© ×œ×”×–×™×Ÿ ×©×'); return; }
  const editId = document.getElementById('fr_editId').value;
  const obj = {
    id: editId || 'FR' + Date.now(),
    code: document.getElementById('fr_code').value,
    firstName: fn, lastName: ln,
    vaad: document.getElementById('fr_vaad').value,
    groupCode: document.getElementById('fr_groupCode').value.trim(),
    homePhone: document.getElementById('fr_homePhone').value.trim(),
    mobile: document.getElementById('fr_mobile').value.trim(),
    availPhone: document.getElementById('fr_availPhone').value,
    target: parseFloat(document.getElementById('fr_target').value)||0,
  };
  if (editId) {
    const idx = DB.fundraisers.findIndex(x => x.id === editId);
    if (idx >= 0) DB.fundraisers[idx] = obj;
  } else {
    DB.fundraisers.push(obj);
  }
  saveDB(); renderFRList();
  // Reset for new
  document.getElementById('fr_editId').value = '';
  document.getElementById('frModalTitle').textContent = '×”×•×¡×¤×ª ××ª×¨×™×';
  document.getElementById('frDeleteBtn').style.display = 'none';
  ['fr_firstName','fr_lastName','fr_groupCode','fr_homePhone','fr_mobile','fr_target'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('fr_vaad').value = '';
  document.getElementById('fr_availPhone').value = 'mobile';
  document.getElementById('fr_code').value = genFRCode(); saveDB();
  setTimeout(()=>document.getElementById('fr_firstName').focus(),50);
}

function deleteFR() {
  const id = document.getElementById('fr_editId').value;
  if (!confirm('×œ××—×•×§ ××ª×¨×™× ×–×”?')) return;
  deleteFRById(id);
  closeModal('frModal');
}

function deleteFRById(id) {
  DB.fundraisers = DB.fundraisers.filter(x => x.id !== id);
  // Remove from groups
  DB.groups.forEach(g => { g.memberIds = (g.memberIds||[]).filter(x => x !== id); });
  saveDB(); renderFRList();
}

// â”€â”€ Import FR from Excel â”€â”€

function showFRImportFormat() {
  const msg = `×¤×•×¨××˜ ×§×•×‘×¥ ×™×™×‘×•× ××ª×¨×™××™× (Excel):\n\n×¢××•×“×•×ª × ×“×¨×©×•×ª â€” ×©××•×ª ×”×¢××•×“×•×ª ×‘×›×•×ª×¨×ª ×”×¨××©×•× ×”:\n\n` +
    `â€¢ ×§×•×“ â€” ×§×•×“ ××ª×¨×™× (×× ×¨×™×§ â€” ×™×™×•×•×¦×¨ ××•×˜×•××˜×™ M0001+)\n` +
    `â€¢ ×©× ×¤×¨×˜×™ â€” ×©×“×” ×—×•×‘×”\n` +
    `â€¢ ×©× ××©×¤×—×”\n` +
    `â€¢ ×•×•×¢×“ / ×©×™×¢×•×¨ â€” ×œ××©×œ: ×•×•×¢×“ ×, ×•×•×¢×“ ×‘...\n` +
    `â€¢ ×§×•×“ ×§×‘×•×¦×” â€” 3 ×¡×¤×¨×•×ª\n` +
    `â€¢ ×˜×œ×¤×•×Ÿ ×‘×™×ª\n` +
    `â€¢ ×¤×œ××¤×•×Ÿ / ×¡×œ×•×œ×¨×™\n` +
    `â€¢ ×™×¢×“ â€” ×¡×›×•× ×™×¢×“ ××™×©×™ (××¡×¤×¨ ×‘×œ×‘×“)\n\n` +
    `×”×¢×¨×”: ×©×•×¨×” ×¨××©×•× ×” = ×›×•×ª×¨×•×ª ×‘×“×™×•×§ ×›×¤×™ ×©××•×¦×’ ×œ××¢×œ×”`;
  alert(msg);
}

function importFR(input) {
  if (!can('admin')) { alert('××™×Ÿ ×”×¨×©××”'); return; }
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    let added = 0;
    rows.forEach(row => {
      const code = String(row['×§×•×“']||row['×§×•×“ ××ª×¨×™×']||genFRCode());
      if (DB.fundraisers.find(f => f.code === code)) return;
      DB.fundraisers.push({
        id: 'FR'+Date.now()+Math.random(),
        code, firstName: row['×©× ×¤×¨×˜×™']||'', lastName: row['×©× ××©×¤×—×”']||'',
        vaad: row['×•×•×¢×“']||row['×©×™×¢×•×¨']||'', groupCode: row['×§×•×“ ×§×‘×•×¦×”']||'',
        homePhone: row['×˜×œ×¤×•×Ÿ ×‘×™×ª']||'', mobile: row['×¤×œ××¤×•×Ÿ']||row['×¡×œ×•×œ×¨×™']||'',
        availPhone: 'mobile', target: parseFloat(row['×™×¢×“']||0)||0,
      });
      added++;
    });
    saveDB(); renderFRList();
    alert('×™×•×‘××• ' + added + ' ××ª×¨×™××™×');
    input.value = '';
  };
  reader.readAsArrayBuffer(file);
}

// â”€â”€ FR search in donation form â”€â”€
function searchFRinForm(searchId, resultsId, hiddenId) {
  const q = document.getElementById(searchId).value.trim().toLowerCase();
  const res = q ? DB.fundraisers.filter(f =>
    ((f.firstName||'')+(f.lastName||'')).toLowerCase().includes(q) ||
    (f.code||'').toLowerCase().includes(q)
  ).slice(0,8) : [];
  document.getElementById(resultsId).innerHTML = res.map(f =>
    `<div class="pick-item" onclick="pickFRinForm('${f.id}','${searchId}','${resultsId}','${hiddenId}')">
      ${f.firstName||''} ${f.lastName||''} <span style="font-size:10px;color:var(--muted)">${f.code||''} ${f.vaad?'| '+f.vaad:''}</span>
    </div>`
  ).join('') || (q ? '<p style="font-size:11px;color:var(--muted);padding:5px">×œ× × ××¦××•</p>' : '');
}
function pickFRinForm(frId, searchId, resultsId, hiddenId) {
  const f = DB.fundraisers.find(x => x.id === frId);
  document.getElementById(hiddenId).value = frId;
  document.getElementById(searchId).value = (f.firstName||'') + ' ' + (f.lastName||'');
  document.getElementById(resultsId).innerHTML = '';
}
function clearFRSel(searchId, resultsId, hiddenId) {
  document.getElementById(searchId).value = '';
  document.getElementById(resultsId).innerHTML = '';
  document.getElementById(hiddenId).value = '';
}

function grpNameById(id) {
  if (!id) return '';
  const g = DB.groups.find(x => x.id === id);
  return g ? g.name : '';
}

function toggleDonAssignType() {
  const t = document.getElementById('nd_don_type').value;
  document.getElementById('nd_fr_box').style.display = t==='fr' ? '' : 'none';
  document.getElementById('nd_grp_box').style.display = t==='group' ? '' : 'none';
}

function searchGroupInForm() {
  const q = document.getElementById('nd_grp_search').value.trim().toLowerCase();
  const res = q ? DB.groups.filter(g=>g.name.toLowerCase().includes(q)||(g.code||'').includes(q)).slice(0,8) : [];
  document.getElementById('nd_grp_results').innerHTML = res.map(g=>
    `<div class="pick-item" onclick="pickGroupInForm('${g.id}')">
      ${g.name} <span style="font-size:10px;color:var(--muted)">${g.code||''} | ${(g.memberIds||[]).length} ×—×‘×¨×™×</span>
    </div>`
  ).join('') || (q ? '<p style="font-size:11px;color:var(--muted);padding:5px">×œ× × ××¦××•</p>' : '');
}

function pickGroupInForm(gid) {
  const g = DB.groups.find(x => x.id === gid);
  document.getElementById('nd_grp_id').value = gid;
  document.getElementById('nd_grp_search').value = g.name;
  document.getElementById('nd_grp_results').innerHTML = '';
  const cnt = (g.memberIds||[]).length;
  document.getElementById('nd_grp_info').textContent = cnt > 0 ? `âœ“ ×”×ª×¨×•××” ×ª×—×•×œ×§ ×œ-${cnt} ××ª×¨×™××™× ×‘×©×•×•×”` : '×”×§×‘×•×¦×” ×¨×™×§×”';
}

function clearGrpSel() {
  document.getElementById('nd_grp_search').value = '';
  document.getElementById('nd_grp_results').innerHTML = '';
  document.getElementById('nd_grp_id').value = '';
  document.getElementById('nd_grp_info').textContent = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GROUPS (×§×‘×•×¦×•×ª ××ª×¨×™××™×)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGroupsList() {
  const q = (document.getElementById('grpSearch')?.value||'').trim().toLowerCase();
  const ac = activeCampaign();
  const grps = DB.groups.filter(g => !q || g.name.toLowerCase().includes(q) || (g.code||'').includes(q));
  const container = document.getElementById('groupsListContainer');
  if (!container) return;
  if (grps.length === 0) { container.innerHTML = '<p style="color:var(--muted);padding:20px">××™×Ÿ ×§×‘×•×¦×•×ª</p>'; return; }
  container.innerHTML = grps.map(g => {
    const raised = grpRaised(g, ac?.id);
    const target = parseFloat(g.target||0);
    const pct = target > 0 ? Math.min(raised/target*100, 100) : 0;
    const over = raised >= target && target > 0;
    const memberNames = (g.memberIds||[]).map(id => frNameById(id)).filter(Boolean);
    return `<div class="grp-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div>
          <strong style="font-size:15px">${g.name}</strong>
          <span class="badge" style="background:var(--cream-d);color:var(--muted);margin-right:8px">${g.code||''}</span>
          ${g.vaad ? `<span class="badge" style="background:var(--teal-bg);color:var(--teal)">${g.vaad}</span>` : ''}
        </div>
        <div style="display:flex;gap:6px">
          ${can('edit') ? `<button class="btn btn-outline btn-sm" onclick="openGroupModal('${g.id}')">âœï¸ ×¢×¨×™×›×”</button>` : ''}
          <button class="btn btn-outline btn-sm" onclick="printGroupReport('${g.id}')">ğŸ–¨ï¸ ×“×•×—</button>
          <button class="btn btn-gold btn-sm" onclick="printFundraisingSheet('${g.id}')">ğŸ“‹ ×’×™×œ×™×•×Ÿ</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:12px">
        <div style="background:var(--cream);border-radius:8px;padding:10px;text-align:center">
          <div style="font-size:18px;font-weight:700;font-family:'Frank Ruhl Libre',serif;color:var(--success)">â‚ª${raised.toLocaleString()}</div>
          <div style="font-size:10px;color:var(--muted)">×’×™×™×¡×” ×¢×“ ×›×”</div>
        </div>
        <div style="background:var(--cream);border-radius:8px;padding:10px;text-align:center">
          <div style="font-size:18px;font-weight:700;font-family:'Frank Ruhl Libre',serif">${target > 0 ? 'â‚ª'+target.toLocaleString() : '-'}</div>
          <div style="font-size:10px;color:var(--muted)">×™×¢×“ ×§×‘×•×¦×ª×™</div>
        </div>
        <div style="background:var(--cream);border-radius:8px;padding:10px;text-align:center">
          <div style="font-size:18px;font-weight:700;font-family:'Frank Ruhl Libre',serif">${(g.memberIds||[]).length}</div>
          <div style="font-size:10px;color:var(--muted)">×—×‘×¨×™×</div>
        </div>
        <div style="background:var(--cream);border-radius:8px;padding:10px;text-align:center">
          <div style="font-size:18px;font-weight:700;font-family:'Frank Ruhl Libre',serif">${(g.donorIds||[]).length}</div>
          <div style="font-size:10px;color:var(--muted)">×ª×•×¨××™×</div>
        </div>
      </div>
      ${target > 0 ? `
        <div class="progress-bar"><div class="progress-fill ${over?'over':''}" style="width:${pct}%"></div></div>
        <div style="font-size:11px;color:var(--muted);margin-top:3px">${Math.round(pct)}% ××”×™×¢×“${over?' âœ“':''}</div>` : ''}
      ${memberNames.length > 0 ? `<div style="margin-top:10px;font-size:12px;color:var(--muted)">ğŸ‘¥ ${memberNames.join(' | ')}</div>` : ''}
      ${g.notes ? `<div style="font-size:12px;color:var(--muted);margin-top:4px">ğŸ“ ${g.notes}</div>` : ''}
    </div>`;
  }).join('');
}

// â”€â”€ Group Modal â”€â”€
function openGroupModal(id) {
  const isEdit = !!id;
  document.getElementById('grpModalTitle').textContent = isEdit ? '×¢×¨×™×›×ª ×§×‘×•×¦×”' : '×§×‘×•×¦×” ×—×“×©×”';
  document.getElementById('grpDeleteBtn').style.display = isEdit ? '' : 'none';
  document.getElementById('grp_editId').value = id || '';
  if (isEdit) {
    const g = DB.groups.find(x => x.id === id); if (!g) return;
    document.getElementById('grp_code').value = g.code||'';
    document.getElementById('grp_name').value = g.name||'';
    document.getElementById('grp_vaad').value = g.vaad||'';
    document.getElementById('grp_target').value = g.target||'';
    document.getElementById('grp_notes').value = g.notes||'';
    grpTempMembers = [...(g.memberIds||[])];
    grpTempDonors = [...(g.donorIds||[])];
  } else {
    ['grp_name','grp_target','grp_notes'].forEach(i => document.getElementById(i).value = '');
    document.getElementById('grp_vaad').value = '';
    const code = genGrpCode(''); saveDB();
    document.getElementById('grp_code').value = code;
    grpTempMembers = [];
    grpTempDonors = [];
  }
  document.getElementById('grp_member_search').value = '';
  document.getElementById('grp_member_results').innerHTML = '';
  document.getElementById('grp_donor_search').value = '';
  document.getElementById('grp_donor_results').innerHTML = '';
  renderGrpMembers();
  renderGrpDonors();
  openModal('groupModal');
}

function updateGrpCode() {
  const editId = document.getElementById('grp_editId').value;
  if (editId) return; // don't change code when editing
  const vaad = document.getElementById('grp_vaad').value;
  const code = genGrpCode(vaad); saveDB();
  document.getElementById('grp_code').value = code;
}

function renderGrpMembers() {
  document.getElementById('grpMemberCount').textContent = grpTempMembers.length;
  document.getElementById('grpMembersList').innerHTML = grpTempMembers.map(id => {
    const f = DB.fundraisers.find(x => x.id === id);
    if (!f) return '';
    return `<span style="background:var(--teal-bg);color:var(--teal);padding:3px 10px;border-radius:20px;font-size:12px;display:inline-flex;align-items:center;gap:5px">
      ${f.firstName||''} ${f.lastName||''} (${f.code||''})
      <button onclick="removeTempMember('${id}')" style="background:none;border:none;cursor:pointer;color:var(--teal);font-size:14px;line-height:1">âœ•</button>
    </span>`;
  }).join('');
}

function searchFRforGroup() {
  const q = document.getElementById('grp_member_search').value.trim().toLowerCase();
  const res = q ? DB.fundraisers.filter(f =>
    !grpTempMembers.includes(f.id) &&
    (((f.firstName||'')+(f.lastName||'')).toLowerCase().includes(q) || (f.code||'').includes(q))
  ).slice(0,8) : [];
  document.getElementById('grp_member_results').innerHTML = res.map(f =>
    `<div class="pick-item" onclick="addTempMember('${f.id}')">
      ${f.firstName||''} ${f.lastName||''} <span style="font-size:10px;color:var(--muted)">${f.code||''} ${f.vaad?'| '+f.vaad:''}</span>
    </div>`
  ).join('') || (q ? '<p style="font-size:11px;color:var(--muted);padding:5px">×œ× × ××¦××•</p>' : '');
}
function addTempMember(id) {
  if (!grpTempMembers.includes(id)) grpTempMembers.push(id);
  document.getElementById('grp_member_search').value = '';
  document.getElementById('grp_member_results').innerHTML = '';
  renderGrpMembers();
}
function removeTempMember(id) {
  grpTempMembers = grpTempMembers.filter(x => x !== id);
  renderGrpMembers();
}

function renderGrpDonors() {
  document.getElementById('grpDonorCount').textContent = grpTempDonors.length;
  document.getElementById('grpDonorsList').innerHTML = grpTempDonors.map(id => {
    const d = DB.donors.find(x => x.id === id);
    if (!d) return '';
    return `<span style="background:var(--gold-bg);color:#7a5c00;padding:3px 10px;border-radius:20px;font-size:12px;display:inline-flex;align-items:center;gap:5px">
      ${donorName(d)} (${d.code||''})
      <button onclick="removeTempDonor('${id}')" style="background:none;border:none;cursor:pointer;color:#7a5c00;font-size:14px;line-height:1">âœ•</button>
    </span>`;
  }).join('');
}
function searchDonorForGroup() {
  const q = document.getElementById('grp_donor_search').value.trim().toLowerCase();
  const res = q ? DB.donors.filter(d =>
    !grpTempDonors.includes(d.id) &&
    (donorName(d).toLowerCase().includes(q) || (d.code||'').toLowerCase().includes(q) || (d.address||'').toLowerCase().includes(q))
  ).slice(0,8) : [];
  document.getElementById('grp_donor_results').innerHTML = res.map(d =>
    `<div class="pick-item" onclick="addTempDonor('${d.id}')">
      ${donorName(d)} <span style="font-size:10px;color:var(--muted)">${d.code||''} ${d.address?'| '+d.address:''}</span>
    </div>`
  ).join('') || (q ? '<p style="font-size:11px;color:var(--muted);padding:5px">×œ× × ××¦××•</p>' : '');
}
function addTempDonor(id) {
  if (!grpTempDonors.includes(id)) grpTempDonors.push(id);
  document.getElementById('grp_donor_search').value = '';
  document.getElementById('grp_donor_results').innerHTML = '';
  renderGrpDonors();
}
function removeTempDonor(id) {
  grpTempDonors = grpTempDonors.filter(x => x !== id);
  renderGrpDonors();
}

function saveGroup() {
  const name = document.getElementById('grp_name').value.trim();
  if (!name) { alert('×™×© ×œ×”×–×™×Ÿ ×©× ×§×‘×•×¦×”'); return; }
  const editId = document.getElementById('grp_editId').value;
  const obj = {
    id: editId || 'G'+Date.now(),
    code: document.getElementById('grp_code').value,
    name, vaad: document.getElementById('grp_vaad').value,
    target: parseFloat(document.getElementById('grp_target').value)||0,
    notes: document.getElementById('grp_notes').value.trim(),
    memberIds: [...grpTempMembers],
    donorIds: [...grpTempDonors],
  };
  if (editId) { const idx = DB.groups.findIndex(x => x.id === editId); if (idx >= 0) DB.groups[idx] = obj; }
  else DB.groups.push(obj);
  saveDB(); closeModal('groupModal'); renderGroupsList();
}

function deleteGroup() {
  const id = document.getElementById('grp_editId').value;
  if (!confirm('×œ××—×•×§ ×§×‘×•×¦×” ×–×•?')) return;
  DB.groups = DB.groups.filter(x => x.id !== id);
  saveDB(); closeModal('groupModal'); renderGroupsList();
}




// â”€â”€ Dynamic select with "Add new" option â”€â”€
// Converts a <select> to support inline adding of new options
function makeSelectAddable(selId, settingsKey, addBlank) {
  const S = getSettings();
  const keyMap = {
    title:'titles', titles:'titles',
    affiliations:'affiliations', affil:'affiliations',
    closings:'closingNames', closingName:'closingNames',
    prefTimes:'prefTimes', prefTime:'prefTimes',
    methods:'payMethods', method:'payMethods',
    relTypes:'relTypes', relType:'relTypes',
    vaads:'vaads', vaad:'vaads'
  };
  const sk = keyMap[settingsKey] || settingsKey;
  const vals = S[sk] || [];
  const el = document.getElementById(selId);
  if (!el) return;
  const curVal = el.value;
  el.innerHTML = (addBlank ? '<option value="">-</option>' : '') +
    vals.map(v => `<option value="${v}"${v===curVal?' selected':''}>${v}</option>`).join('') +
    '<option value="__add__">â• ×”×•×¡×£ ×—×“×©...</option>';
  
  // Create or reuse the add-row beneath the select
  let addRow = document.getElementById('addrow_'+selId);
  if (!addRow) {
    addRow = document.createElement('div');
    addRow.id = 'addrow_'+selId;
    addRow.className = 'add-opt-row';
    addRow.innerHTML = `<input type="text" class="form-control" placeholder="×¢×¨×š ×—×“×©..." style="font-size:12px" id="addinput_${selId}">
      <button class="btn btn-navy btn-sm" onclick="confirmAddOpt('${selId}','${sk}')">âœ“</button>
      <button class="btn btn-outline btn-sm" onclick="cancelAddOpt('${selId}')">âœ•</button>`;
    el.parentNode.insertBefore(addRow, el.nextSibling);
    document.getElementById('addinput_'+selId).addEventListener('keydown', ev => {
      if(ev.key==='Enter') confirmAddOpt(selId, sk);
      if(ev.key==='Escape') cancelAddOpt(selId);
    });
  }
  
  el.onchange = function() {
    if (this.value === '__add__') {
      this.value = curVal || '';
      addRow.classList.add('visible');
      document.getElementById('addinput_'+selId)?.focus();
    }
  };
}

function confirmAddOpt(selId, settingsKey) {
  const inp = document.getElementById('addinput_'+selId);
  const val = inp?.value?.trim();
  if (!val) { inp?.focus(); return; }
  const S = getSettings();
  if (!S[settingsKey]) S[settingsKey] = [];
  if (!S[settingsKey].includes(val)) S[settingsKey].push(val);
  DB.settings = S;
  saveDB();
  // Re-build select with new value selected
  const el = document.getElementById(selId);
  if (el) {
    makeSelectAddable(selId, settingsKey, el.options[0]?.value==='');
    el.value = val;
  }
  cancelAddOpt(selId);
}

function cancelAddOpt(selId) {
  const row = document.getElementById('addrow_'+selId);
  if (row) { row.classList.remove('visible'); }
  const inp = document.getElementById('addinput_'+selId);
  if (inp) inp.value = '';
}

// Call this when opening donor modal / donation form to wire up all selects
function initSelectsAddable() {
  const pairs = [
    ['f_title','titles'], ['f_affil','affiliations'], ['f_closingName','closings'],
    ['f_prefTime','prefTimes'], ['f_relType','relTypes'],
    ['nd_method','methods'], ['qd_method','methods'],
  ];
  pairs.forEach(([id, key]) => {
    if (document.getElementById(id)) makeSelectAddable(id, key, true);
  });
}

// â”€â”€ Group search for donation forms â”€â”€
function searchGroupInForm(prefix) {
  const q = (document.getElementById(prefix+'_search')?.value||'').toLowerCase().trim();
  const resultsEl = document.getElementById(prefix+'_results');
  if (!resultsEl) return;
  const matches = DB.groups.filter(g =>
    (g.name||'').toLowerCase().includes(q) ||
    (g.code||'').toLowerCase().includes(q) ||
    (g.vaad||'').toLowerCase().includes(q)
  ).slice(0, 8);
  resultsEl.innerHTML = matches.length
    ? matches.map(g => `<div class="pick-item" onclick="pickGroupInForm('${prefix}','${g.id}')">
        <strong>${g.name}</strong>
        <span style="float:left;font-size:10px;color:var(--muted)">${g.code||''} | ${g.memberIds?.length||0} ×—×‘×¨×™×</span>
      </div>`).join('')
    : (q ? '<div style="padding:7px;font-size:12px;color:var(--muted)">×œ× × ××¦××” ×§×‘×•×¦×”</div>' : '');
  resultsEl.style.display = '';
}
function pickGroupInForm(prefix, grpId) {
  const grp = DB.groups.find(g=>g.id===grpId); if(!grp) return;
  document.getElementById(prefix+'_id').value = grpId;
  document.getElementById(prefix+'_search').value = grp.name + (grp.code?' ('+grp.code+')':'');
  document.getElementById(prefix+'_results').style.display = 'none';
  // Show info
  const info = document.getElementById(prefix+'_info');
  if (info) {
    const count = grp.memberIds?.length || 0;
    const names = (grp.memberIds||[]).map(id=>frNameById(id)).filter(Boolean);
    info.style.display = '';
    info.textContent = count > 0
      ? `×”×ª×¨×•××” ×ª×—×•×œ×§ ×œ-${count} ×—×‘×¨×™× (×›×œ ××—×“ ×™×§×‘×œ ×§×¨×“×™×˜ ×©×œ 1/${count}): ${names.join(', ')}`
      : '××™×Ÿ ×—×‘×¨×™× ×¨×©×•××™× ×‘×§×‘×•×¦×”';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BULK SELECT & DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSelectAll(cb) {
  const checked = cb.checked;
  document.querySelectorAll('.donor-row-cb').forEach(el => el.checked = checked);
  updateBulkBar();
}

function toggleSelectAllDonors(cb) {
  document.querySelectorAll('.donor-row-cb').forEach(c => c.checked = cb.checked);
  updateBulkBar();
}
function updateBulkBar() {
  const selected = document.querySelectorAll('.donor-row-cb:checked');
  const bar = document.getElementById('bulkActionBar');
  const cnt = document.getElementById('bulkCount');
  if (!bar) return;
  if (selected.length > 0) {
    bar.style.display = 'flex';
    cnt.textContent = selected.length + ' × ×‘×—×¨×•';
  } else {
    bar.style.display = 'none';
  }
}
function clearAllSelections() {
  document.querySelectorAll('.donor-row-cb').forEach(el => el.checked = false);
  const cb = document.getElementById('selectAllDonors');
  if (cb) cb.checked = false;
  updateBulkBar();
}
function deleteSelectedDonors() {
  if (!can('admin')) { alert('××™×Ÿ ×”×¨×©××”'); return; }
  const ids = Array.from(document.querySelectorAll('.donor-row-cb:checked')).map(el => el.dataset.id);
  if (!ids.length) return;
  if (!confirm(`×”×× ×œ××—×•×§ ${ids.length} ×ª×•×¨××™×? ×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×”!`)) return;
  DB.donors = DB.donors.filter(d => !ids.includes(d.id));
  saveDB();
  renderDonorTable();
  clearAllSelections();
  renderGlobalStats();
  toast(ids.length + ' ×ª×•×¨××™× × ××—×§×•');
}

function toast(msg) {
  let t = document.getElementById('toastMsg');
  if (!t) {
    t = document.createElement('div');
    t.id = 'toastMsg';
    t.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#1a2744;color:white;padding:10px 20px;border-radius:20px;font-size:13px;z-index:9999;opacity:0;transition:opacity .3s';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.opacity = '1';
  setTimeout(() => { t.style.opacity = '0'; }, 2500);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PENDING BUFFER â€” for new donors not yet saved
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _pendingDonations = [];
let _pendingFuture = [];
let _pendingRelations = [];

function isNewDonor() {
  // Returns true when we're adding a brand new (unsaved) donor
  return !currentDonorId || currentDonorId === '__new__';
}

function flushPendingToNewDonor(donorId) {
  const d = DB.donors.find(x => x.id === donorId); if (!d) return;
  if (!d.donations) d.donations = [];
  if (!d.futureDonations) d.futureDonations = [];
  if (!d.relations) d.relations = [];
  _pendingDonations.forEach(obj => d.donations.push(obj));
  _pendingFuture.forEach(obj => d.futureDonations.push(obj));
  _pendingRelations.forEach(obj => d.relations.push(obj));
  _pendingDonations = [];
  _pendingFuture = [];
  _pendingRelations = [];
}


function confirmFutureDonation(donorId, futureIdx) {
  // Open donor card, switch to donations tab, pre-fill amount from future donation
  const d = DB.donors.find(x=>x.id===donorId); if(!d) return;
  const fd = (d.futureDonations||[])[futureIdx];
  currentDonorId = donorId;
  fillDForm(d);
  switchDTab('donations');
  openModal('donorModal');
  setTimeout(() => {
    // Open the donation form pre-filled
    const box = document.getElementById('donationFormBox');
    if(box) box.style.display='';
    // Pre-fill amount and notes from the future donation
    if(fd) {
      const amtEl = document.getElementById('nd_amount');
      const notesEl = document.getElementById('nd_notes');
      const campEl = document.getElementById('nd_campaign');
      if(amtEl && fd.expectedAmount) amtEl.value = fd.expectedAmount;
      if(notesEl && fd.notes) notesEl.value = fd.notes;
      if(campEl && fd.campaignId) campEl.value = fd.campaignId;
      // Set today as date
      const dateEl = document.getElementById('nd_date');
      if(dateEl) dateEl.value = new Date().toISOString().split('T')[0];
    }
    // Mark that we should remove this future donation upon save
    window._confirmFutureDonorId = donorId;
    window._confirmFutureIdx = futureIdx;
    // Show info banner
    const banner = document.createElement('div');
    banner.id = 'futurConfirmBanner';
    banner.style.cssText = 'background:#d1fae5;border:1px solid #6ee7b7;color:#065f46;padding:8px 12px;border-radius:7px;font-size:12px;margin-bottom:8px';
    banner.innerHTML = 'âœ… <strong>××™×©×•×¨ ×ª×¨×•××” ×¢×ª×™×“×™×ª</strong> â€” ×œ××—×¨ ×©××™×¨×” ×”×ª×¨×•××” ×”×¢×ª×™×“×™×ª ×ª×•×¡×¨ ××•×˜×•××˜×™×ª';
    const fb = document.getElementById('donationFormBox');
    if(fb && !document.getElementById('futurConfirmBanner')) fb.prepend(banner);
  }, 150);
}

function renderPendingDonations() {
  const body = document.getElementById('donorStatsBody');
  if (!body) return;
  if (_pendingDonations.length === 0) {
    body.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--muted);font-size:13px">××™×Ÿ ×ª×¨×•××•×ª ×¢×“×™×™×Ÿ</td></tr>';
    return;
  }
  body.innerHTML = _pendingDonations.map((dn,i) => `
    <tr>
      <td>${fmt(dn.date)}</td>
      <td style="font-size:11px">${toHeb(dn.date)}</td>
      <td><strong style="color:var(--success)">â‚ª${parseFloat(dn.amount||0).toLocaleString()}</strong></td>
      <td>${dn.method||''}</td>
      <td><button class="btn btn-danger btn-sm" onclick="removePending('don',${i})">ğŸ—‘ï¸</button></td>
    </tr>`).join('');
}

function renderPendingFuture() {
  const body = document.getElementById('futureTabBody');
  if (!body) return;
  if (_pendingFuture.length === 0) {
    body.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--muted);font-size:13px">××™×Ÿ ×ª×¨×•××•×ª ×¢×ª×™×“×™×•×ª</td></tr>';
    return;
  }
  body.innerHTML = _pendingFuture.map((f,i) => `
    <tr>
      <td>${fmt(f.date)}</td>
      <td>${f.expectedAmount ? 'â‚ª'+parseFloat(f.expectedAmount).toLocaleString() : 'â€”'}</td>
      <td>${f.notes||''}</td>
      <td><button class="btn btn-danger btn-sm" onclick="removePending('future',${i})">ğŸ—‘ï¸</button></td>
    </tr>`).join('');
}

function renderPendingRelations() {
  const body = document.getElementById('relTabBody');
  if (!body) return;
  if (_pendingRelations.length === 0) {
    body.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:20px;color:var(--muted);font-size:13px">××™×Ÿ ×”×ª×××•×ª</td></tr>';
    return;
  }
  body.innerHTML = _pendingRelations.map((r,i) => {
    const other = DB.donors.find(x=>x.id===r.relId);
    return `<tr>
      <td>${other ? donorName(other) : r.relId}</td>
      <td>${r.relType||''}</td>
      <td><button class="btn btn-danger btn-sm" onclick="removePending('rel',${i})">ğŸ—‘ï¸</button></td>
    </tr>`;
  }).join('');
}

function removePending(type, idx) {
  if(type==='don') _pendingDonations.splice(idx,1);
  else if(type==='future') _pendingFuture.splice(idx,1);
  else if(type==='rel') _pendingRelations.splice(idx,1);
  if(type==='don') renderPendingDonations();
  else if(type==='future') renderPendingFuture();
  else renderPendingRelations();
}

// â”€â”€ Donation attribution mode: FR vs Group â”€â”€
function toggleDonMode(prefix) {
  const isGrp = document.querySelector(`input[name="${prefix}_mode"]:checked`)?.value === 'grp';
  const frWrap = document.getElementById(prefix+'_fr_wrap');
  const grpWrap = document.getElementById(prefix+'_grp_wrap');
  if (frWrap) frWrap.style.display = isGrp ? 'none' : '';
  if (grpWrap) grpWrap.style.display = isGrp ? '' : 'none';
  if (isGrp) {
    // Populate group dropdown
    const sel = document.getElementById(prefix+'_grp_sel');
    if (sel) {
      sel.innerHTML = '<option value="">-- ×‘×—×¨ ×§×‘×•×¦×” --</option>' +
        DB.groups.map(g => `<option value="${g.id}">${g.name} (${g.code||''}) â€” ${g.memberIds?.length||0} ×—×‘×¨×™×</option>`).join('');
    }
  }
}
function updateGrpInfo(prefix) {
  const selId = prefix+'_grp_sel';
  const infoId = prefix+'_grp_info';
  const grpId = document.getElementById(selId)?.value;
  const grp = grpId ? DB.groups.find(g=>g.id===grpId) : null;
  const el = document.getElementById(infoId);
  if (!el) return;
  if (grp && grp.memberIds?.length) {
    const names = grp.memberIds.map(id=>frNameById(id)).filter(Boolean);
    el.textContent = `×”×ª×¨×•××” ×ª×—×•×œ×§ ×‘×™×Ÿ: ${names.join(' | ')} (${names.length} ×—×‘×¨×™×)`;
    el.style.color = 'var(--teal)';
  } else {
    el.textContent = '';
  }
}
function getDonAttribution(prefix) {
  const mode = document.querySelector(`input[name="${prefix}_mode"]:checked`)?.value || 'fr';
  if (mode === 'grp') {
    return {
      fundraiserId: '',
      groupId: document.getElementById(prefix+'_grp_id')?.value || ''
    };
  }
  return {
    fundraiserId: document.getElementById(prefix+'_fr_id')?.value || '',
    groupId: ''
  };
}

function loadDemoIfEmpty(){
  if(DB.donors.length>0) return;
  // Add sample campaign
  DB.campaigns=[
    {id:'CAM1',name:'××’×‘×™×ª ×¤×•×¨×™× ×ª×©×¤"×”',year:'×ª×©×¤"×”',goal:150000,deadline:'2025-03-14',active:true,desc:'××’×‘×™×ª ×”×©× ×”'},
    {id:'CAM2',name:'××’×‘×™×ª ×¤×•×¨×™× ×ª×©×¤"×“',year:'×ª×©×¤"×“',goal:120000,deadline:'2024-03-24',active:false,desc:''},
  ];
  DB.donors=[
    {id:'D1',code:'T1001',title:'×”×¨×‘',firstName:'××©×”',lastName:'×œ×•×™',closingName:'×‘×‘×¨×›×”',affil:'×‘×•×’×¨',address:'×”×¨×¦×œ 15, ×™×¨×•×©×œ×™×',entrance:'×›× ×™×¡×” ×',phone:'02-5551234',mobile:'0521234567',email:'moshe@example.com',marriageYear:'1995',cohort:'××—×–×•×¨ ×›',notes:'×ª×•×¨× ×•×ª×™×§',prefTime:'×¤×•×¨×™× ×‘×‘×™×ª',createdAt:'2022-09-01T10:00:00',
      donations:[{amount:500,date:'2024-03-06',method:'××–×•××Ÿ',campaignId:'CAM2',notes:''},{amount:1000,date:'2025-03-13',method:'××©×¨××™',campaignId:'CAM1',notes:'×©× ×ª×™'}],
      futureDonations:[{date:'2026-03-02',expectedAmount:1500,campaignId:'CAM1',notes:'×”×•×¡×›× ×‘×©×™×—×” - ××’×“×™×œ'},{date:'2025-09-15',expectedAmount:null,campaignId:'',notes:'×œ×‘×“×•×§ ×‘×¨××© ×”×©× ×”'}],
      relations:[]},
    {id:'D2',code:'T1002',title:'××¨',firstName:'×™×¢×§×‘',lastName:'×›×”×Ÿ',closingName:'×‘×›×‘×•×“ ×¨×‘',affil:'×”×•×¨×” ×ª×œ××™×“',address:'×‘×Ÿ ×’×•×¨×™×•×Ÿ 8, ×ª×œ ××‘×™×‘',entrance:'×§×•××” 4',phone:'03-6661234',mobile:'0501111222',email:'yaakov@example.com',marriageYear:'',cohort:'',notes:'',prefTime:'×˜×œ×¤×•× ×™ ×œ×¤× ×™ ×¤×•×¨×™×',createdAt:'2023-01-15T10:00:00',
      donations:[{amount:2000,date:'2025-02-15',method:'×”×¢×‘×¨×” ×‘× ×§××™×ª',campaignId:'CAM1',notes:''}],
      futureDonations:[{date:'2026-02-20',expectedAmount:2500,campaignId:'CAM1',notes:'××¢×•× ×™×™×Ÿ ×œ×”×’×“×™×œ'}],
      relations:[{donorId:'D1',type:'×©×•×•×¢×¨'}]},
    {id:'D3',code:'T1003',title:'×“"×¨',firstName:'×©×¨×”',lastName:'×’×•×œ×“×‘×¨×’',closingName:'×‘×”×•×§×¨×”',affil:'××›×¨',address:'×‘×™××œ×™×§ 22, ×—×™×¤×”',entrance:'',phone:'04-8884321',mobile:'0523334445',email:'sarah@example.com',marriageYear:'2001',cohort:'',notes:'×”×›×™×¨×” ×“×¨×š ×¨. ×©××¢×•×Ÿ',prefTime:'×˜×œ×¤×•× ×™ ×‘×¤×•×¨×™×',createdAt:'2024-03-01T10:00:00',
      donations:[{amount:5000,date:'2025-03-10',method:"×¦'×§",campaignId:'CAM1',notes:'×©×™×§ 123'}],
      futureDonations:[],relations:[]},
    {id:'D4',code:'T1004',title:'×”×¨×‘',firstName:'××‘×¨×”×',lastName:'×’×¨×™× ×‘×¨×’',closingName:'×™×™×©×¨ ×›×—',affil:'×ª×œ××™×“',address:'××œ×›×™ ×™×©×¨××œ 3, ×‘× ×™ ×‘×¨×§',entrance:'',phone:'',mobile:'0524445566',email:'',marriageYear:'',cohort:'××—×–×•×¨ ×›×”',notes:'',prefTime:'×¤×•×¨×™× ×‘×‘×™×ª',createdAt:'2024-06-10T10:00:00',
      donations:[],
      futureDonations:[{date:'2026-03-02',expectedAmount:500,campaignId:'CAM1',notes:'×‘×™×§×¨ ×‘×¡×•×›×•×ª - ×”×¡×›×™× ×œ×ª×¨×•×'}],
      relations:[]},
  ];
  // Demo fundraisers
  if (!DB.fundraisers.length) {
    DB.nextFRCode = 1;
    DB.nextGrpSeq = {};
    DB.fundraisers = [
      {id:'FR1',code:'M0001',firstName:'×“×•×“',lastName:'××œ×¤×¡×™',vaad:'×•×•×¢×“ ×',groupCode:'101',homePhone:'02-5551111',mobile:'0521111111',availPhone:'mobile',target:5000},
      {id:'FR2',code:'M0002',firstName:'×™×•×¡×£',lastName:'×‘×¨×’×¨',vaad:'×•×•×¢×“ ×',groupCode:'101',homePhone:'02-5552222',mobile:'0522222222',availPhone:'mobile',target:4000},
      {id:'FR3',code:'M0003',firstName:'××‘×¨×”×',lastName:'×’×•×œ×“',vaad:'×•×•×¢×“ ×‘',groupCode:'201',homePhone:'02-5553333',mobile:'0523333333',availPhone:'home',target:6000},
      {id:'FR4',code:'M0004',firstName:'×™×¢×§×‘',lastName:'×“×•×™×“×•×‘',vaad:'×•×•×¢×“ ×‘',groupCode:'201',homePhone:'',mobile:'0524444444',availPhone:'mobile',target:3000},
      {id:'FR5',code:'M0005',firstName:'××©×”',lastName:'×”×œ×•×™',vaad:'×•×•×¢×“ ×’',groupCode:'301',homePhone:'02-5555555',mobile:'0525555555',availPhone:'mobile',target:8000},
    ];
    DB.nextFRCode = 6;
    DB.groups = [
      {id:'G1',code:'101',name:'×§×‘×•×¦×ª ××œ×¤×¡×™-×‘×¨×’×¨',vaad:'×•×•×¢×“ ×',target:9000,notes:'×§×‘×•×¦×” ×•×ª×™×§×”',memberIds:['FR1','FR2'],donorIds:['D1','D2']},
      {id:'G2',code:'201',name:'×§×‘×•×¦×ª ×’×•×œ×“-×“×•×™×“×•×‘',vaad:'×•×•×¢×“ ×‘',target:9000,notes:'',memberIds:['FR3','FR4'],donorIds:['D3']},
      {id:'G3',code:'301',name:'×§×‘×•×¦×ª ×”×œ×•×™',vaad:'×•×•×¢×“ ×’',target:8000,notes:'',memberIds:['FR5'],donorIds:['D4']},
    ];
    // Assign fundraisers to demo donations
    if (DB.donors[0]?.donations[0]) DB.donors[0].donations[0].fundraiserId = 'FR1';
    if (DB.donors[0]?.donations[1]) DB.donors[0].donations[1].fundraiserId = 'FR2';
    if (DB.donors[1]?.donations[0]) DB.donors[1].donations[0].fundraiserId = 'FR3';
    if (DB.donors[2]?.donations[0]) DB.donors[2].donations[0].fundraiserId = 'FR5';
  }
  saveDB();
}

// INIT
loadDB();
</script>
</body>
</html>
